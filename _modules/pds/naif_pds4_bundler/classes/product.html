

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pds.naif_pds4_bundler.classes.product &mdash; NAIF PDS4 Bundler 1.3.0
 documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home" alt="Documentation Home"> NAIF PDS4 Bundler
          

          
          </a>

          
            
            
              <div class="version">
                1.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../10_overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../20_spice_kernel_archive_description.html">SPICE Kernel Archive Description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../30_spice_kernel_archive_preparation_guide.html">SPICE Kernel Archive Preparation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../40_naif_pds4_bundler_user_guide.html">NAIF PDS4 Bundler User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../50_api_docs.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../60_annex_npb_for_pds3.html">Appendix: NPB for PDS3 Archives</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">NAIF PDS4 Bundler</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>pds.naif_pds4_bundler.classes.product</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pds.naif_pds4_bundler.classes.product</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Product Class and Child Classes Implementation.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">difflib</span>
<span class="kn">import</span> <span class="nn">filecmp</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">spiceypy</span>

<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">add_carriage_return</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">add_crs_to_file</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">check_eol</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">checksum_from_label</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">checksum_from_registry</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">ck_coverage</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">compare_files</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">creation_time</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">current_date</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">dsk_coverage</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">et_to_date</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">extension_to_type</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">get_latest_kernel</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">match_patterns</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">md5</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">mk_to_list</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">pck_coverage</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">product_mapping</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">replace_string_in_file</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">safe_make_directory</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">spice_exception_handler</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">spk_coverage</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">string_in_file</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">type_to_extension</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">utf8len</span>
<span class="kn">from</span> <span class="nn">.label</span> <span class="kn">import</span> <span class="n">BundlePDS4Label</span>
<span class="kn">from</span> <span class="nn">.label</span> <span class="kn">import</span> <span class="n">ChecksumPDS3Label</span>
<span class="kn">from</span> <span class="nn">.label</span> <span class="kn">import</span> <span class="n">ChecksumPDS4Label</span>
<span class="kn">from</span> <span class="nn">.label</span> <span class="kn">import</span> <span class="n">DocumentPDS4Label</span>
<span class="kn">from</span> <span class="nn">.label</span> <span class="kn">import</span> <span class="n">InventoryPDS3Label</span>
<span class="kn">from</span> <span class="nn">.label</span> <span class="kn">import</span> <span class="n">InventoryPDS4Label</span>
<span class="kn">from</span> <span class="nn">.label</span> <span class="kn">import</span> <span class="n">MetaKernelPDS4Label</span>
<span class="kn">from</span> <span class="nn">.label</span> <span class="kn">import</span> <span class="n">OrbnumFilePDS4Label</span>
<span class="kn">from</span> <span class="nn">.label</span> <span class="kn">import</span> <span class="n">SpiceKernelPDS3Label</span>
<span class="kn">from</span> <span class="nn">.label</span> <span class="kn">import</span> <span class="n">SpiceKernelPDS4Label</span>
<span class="kn">from</span> <span class="nn">.log</span> <span class="kn">import</span> <span class="n">error_message</span>
<span class="kn">from</span> <span class="nn">.object</span> <span class="kn">import</span> <span class="n">Object</span>
<span class="kn">from</span> <span class="nn">.setup</span> <span class="kn">import</span> <span class="n">Setup</span>


<div class="viewcode-block" id="Product"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.Product">[docs]</a><span class="k">class</span> <span class="nc">Product</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parent Class that defines a generic archive product (or file).</span>

<span class="sd">    Assigns value to the common attributes for all Products: file size,</span>
<span class="sd">    creation time and date, and file extension.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Constructor.&quot;&quot;&quot;</span>
        <span class="n">stat_info</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">stat_info</span><span class="o">.</span><span class="n">st_size</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># If specified via configuration, try to obtain the checksum from a</span>
        <span class="c1"># checksum registry file, if not present, try to obtain it from the</span>
        <span class="c1"># label if the product is in the staging area. Otherwise, compute the</span>
        <span class="c1"># checksum.</span>
        <span class="c1">#</span>
        <span class="c1"># Checksums for checksum files are always re-calculated.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s2">&quot;ChecksumProduct&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">checksum</span><span class="p">:</span>
                <span class="n">checksum</span> <span class="o">=</span> <span class="n">checksum_from_registry</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">working_directory</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">checksum</span><span class="p">:</span>
                    <span class="n">checksum</span> <span class="o">=</span> <span class="n">checksum_from_label</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">checksum</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">checksum</span><span class="p">:</span>
                <span class="n">checksum</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">md5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">checksum</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">md5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">checksum</span> <span class="o">=</span> <span class="n">checksum</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="n">archive_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_acronym</span><span class="si">}</span><span class="s2">_spice/&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">archive_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">volume_id</span><span class="si">}</span><span class="s2">/&quot;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">,</span> <span class="s2">&quot;creation_date_time&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">creation_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">creation_date_time</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">creation_time</span> <span class="o">=</span> <span class="n">creation_time</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">date_format</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">creation_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">creation_time</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_product</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">add_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">add_checksum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">checksum</span><span class="p">)</span>

<div class="viewcode-block" id="Product.get_observer_and_target"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.Product.get_observer_and_target">[docs]</a>    <span class="k">def</span> <span class="nf">get_observer_and_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the configuration to extract the observers and the targets.</span>

<span class="sd">        :return: observers and targets</span>
<span class="sd">        :rtype: tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">observers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">json_config</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>

            <span class="c1">#</span>
            <span class="c1"># If the pattern is matched for the kernel name, extract</span>
            <span class="c1"># the target and observer from the kernel list</span>
            <span class="c1"># configuration.</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">[</span><span class="s2">&quot;@pattern&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>

                <span class="n">ker_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">kernel_list_config</span><span class="p">[</span><span class="n">pattern</span><span class="p">[</span><span class="s2">&quot;@pattern&quot;</span><span class="p">]]</span>

                <span class="c1">#</span>
                <span class="c1"># Check if the kernel has specified targets.</span>
                <span class="c1"># Note that the mission target will not be used in this case.</span>
                <span class="c1">#</span>
                <span class="k">if</span> <span class="s2">&quot;targets&quot;</span> <span class="ow">in</span> <span class="n">ker_config</span><span class="p">:</span>
                    <span class="n">targets</span> <span class="o">=</span> <span class="n">ker_config</span><span class="p">[</span><span class="s2">&quot;targets&quot;</span><span class="p">][</span><span class="s2">&quot;target&quot;</span><span class="p">]</span>
                <span class="c1">#</span>
                <span class="c1"># If the kernel has no targets then the mission target is used.</span>
                <span class="c1">#</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">target</span><span class="p">]</span>

                <span class="c1">#</span>
                <span class="c1"># Check if the kernel has specified observers.</span>
                <span class="c1"># Note that the mission observer will not be used in this case.</span>
                <span class="c1">#</span>
                <span class="k">if</span> <span class="s2">&quot;observers&quot;</span> <span class="ow">in</span> <span class="n">ker_config</span><span class="p">:</span>
                    <span class="n">observers</span> <span class="o">=</span> <span class="n">ker_config</span><span class="p">[</span><span class="s2">&quot;observers&quot;</span><span class="p">][</span><span class="s2">&quot;observer&quot;</span><span class="p">]</span>
                <span class="c1">#</span>
                <span class="c1"># If the kernel has no observers then the mission observer is</span>
                <span class="c1"># used.</span>
                <span class="c1">#</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">observers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">observer</span><span class="p">]</span>

                <span class="k">break</span>
            <span class="c1">#</span>
            <span class="c1"># If the product is not in the kernel list (such as the orbnum</span>
            <span class="c1"># file), then use the mission observers and targets.</span>
            <span class="c1">#</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">observers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">observer</span><span class="p">]</span>
                <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">target</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">observers</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SpiceKernelProduct"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.SpiceKernelProduct">[docs]</a><span class="k">class</span> <span class="nc">SpiceKernelProduct</span><span class="p">(</span><span class="n">Product</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Product child Class that defines a SPICE Kernel file archive product.</span>

<span class="sd">    :param setup: NPB run Setup Object</span>
<span class="sd">    :type setup: object</span>
<span class="sd">    :param name: SPICE Kernel filename</span>
<span class="sd">    :type name: str</span>
<span class="sd">    :param collection: SPICE Kernel collection that will be a container of</span>
<span class="sd">                       the SPICE Kernel Product Object</span>
<span class="sd">    :type collection: Object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setup</span><span class="p">:</span> <span class="n">Setup</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">collection</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Constructor.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">extension</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">extension_to_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># Determine if it is a binary or a text kernel.</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extension</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">file_format</span> <span class="o">=</span> <span class="s2">&quot;Binary&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">file_format</span> <span class="o">=</span> <span class="s2">&quot;Character&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">lid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">product_lid</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">product_vid</span><span class="p">()</span>
            <span class="n">ker_dir</span> <span class="o">=</span> <span class="s2">&quot;spice_kernels&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># Determine if it is a binary or a text kernel.</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extension</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">file_format</span> <span class="o">=</span> <span class="s2">&quot;BINARY&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">record_type</span> <span class="o">=</span> <span class="s2">&quot;FIXED_LENGTH&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">record_bytes</span> <span class="o">=</span> <span class="s2">&quot;1024&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">file_format</span> <span class="o">=</span> <span class="s2">&quot;ASCII&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">record_type</span> <span class="o">=</span> <span class="s2">&quot;STREAM&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">record_bytes</span> <span class="o">=</span> <span class="s1">&#39;&quot;N/A&quot;&#39;</span>

            <span class="n">ker_dir</span> <span class="o">=</span> <span class="s2">&quot;data&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">collection_path</span> <span class="o">=</span> <span class="n">setup</span><span class="o">.</span><span class="n">staging_directory</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">ker_dir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>

        <span class="n">product_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_path</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>

        <span class="c1">#</span>
        <span class="c1"># We generate the kernel directory if not present</span>
        <span class="c1">#</span>
        <span class="n">safe_make_directory</span><span class="p">(</span><span class="n">product_path</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># We copy the kernel to the staging directory. If multiple directories</span>
        <span class="c1"># are provided, the first one is used.</span>
        <span class="c1">#</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Copy </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> to staging directory.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">product_path</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
            <span class="n">origin_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">directory</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">kernels_directory</span><span class="p">:</span>
                <span class="n">file</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">ker</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">ker</span> <span class="ow">in</span> <span class="n">files</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">ker</span>
                <span class="p">]</span>

                <span class="c1">#</span>
                <span class="c1"># If the file exists save the path and escape the loop.</span>
                <span class="c1">#</span>
                <span class="k">if</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">origin_path</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">new_product</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>

            <span class="c1">#</span>
            <span class="c1"># If after the first loop the file is not present we do another</span>
            <span class="c1"># loop to see if the file needs mapping.</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">origin_path</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">directory</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">kernels_directory</span><span class="p">:</span>
                    <span class="n">file</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">ker</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">ker</span> <span class="ow">in</span> <span class="n">files</span>
                        <span class="k">if</span> <span class="n">product_mapping</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">)</span> <span class="o">==</span> <span class="n">ker</span>
                    <span class="p">]</span>

                    <span class="k">if</span> <span class="n">file</span><span class="p">:</span>
                        <span class="n">origin_path</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">new_product</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;-- Mapping </span><span class="si">{</span><span class="n">product_mapping</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;with </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="k">break</span>

            <span class="c1">#</span>
            <span class="c1"># If after the two loops the file is not present raise an error.</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">origin_path</span><span class="p">:</span>
                <span class="n">error_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> not present in </span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">setup</span><span class="o">=</span><span class="n">setup</span><span class="p">)</span>

            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">origin_path</span><span class="p">,</span> <span class="n">product_path</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> already present in staging directory.&quot;</span><span class="p">)</span>

            <span class="c1">#</span>
            <span class="c1"># Even though it is not a &#39;new&#39; product, the file is present in</span>
            <span class="c1"># the staging area because it was generated in a prior run.</span>
            <span class="c1">#</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_product</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1">#</span>
        <span class="c1"># We update the path after having copied the kernel.</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">product_path</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">coverage</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_description</span><span class="p">()</span>

        <span class="n">Product</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Extract the required information from the kernel list read from</span>
        <span class="c1"># configuration for the product.</span>
        <span class="c1">#</span>
        <span class="p">(</span><span class="n">observers</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_observer_and_target</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observers</span> <span class="o">=</span> <span class="n">observers</span>

        <span class="c1">#</span>
        <span class="c1"># The kernel is labeled.</span>
        <span class="c1">#</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Labeling </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">SpiceKernelPDS4Label</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maklabel_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_maklabel_options</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">SpiceKernelPDS3Label</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="SpiceKernelProduct.product_lid"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.SpiceKernelProduct.product_lid">[docs]</a>    <span class="k">def</span> <span class="nf">product_lid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine product logical identifier (LID).</span>

<span class="sd">        :return: product LID</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">product_lid</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:spice_kernels:</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">logical_identifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">product_lid</span></div>

<div class="viewcode-block" id="SpiceKernelProduct.product_vid"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.SpiceKernelProduct.product_vid">[docs]</a>    <span class="k">def</span> <span class="nf">product_vid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine product logical identifier (VID).</span>

<span class="sd">        :return: product VID</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">product_vid</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span>

        <span class="k">return</span> <span class="n">product_vid</span></div>

<div class="viewcode-block" id="SpiceKernelProduct.read_description"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.SpiceKernelProduct.read_description">[docs]</a>    <span class="k">def</span> <span class="nf">read_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the kernel list to return the description.</span>

<span class="sd">        The generated kernel list file must be used because it contains the</span>
<span class="sd">        description.</span>

<span class="sd">        :return: Kernel Description from the Kernel List</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kernel_list_file</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">working_directory</span>
            <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_acronym</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">run_type</span><span class="si">}</span><span class="s2">_&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">release</span><span class="p">)</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">.kernel_list&quot;</span>
        <span class="p">)</span>

        <span class="n">get_token</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">description</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">kernel_list_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">lst</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">get_token</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">get_token</span> <span class="ow">and</span> <span class="s2">&quot;DESCRIPTION&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">description</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">get_token</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">description</span><span class="p">:</span>
            <span class="n">error_message</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> does not have a DESCRIPTION on </span><span class="si">{</span><span class="n">kernel_list_file</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
                <span class="n">setup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">description</span></div>

<div class="viewcode-block" id="SpiceKernelProduct.read_maklabel_options"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.SpiceKernelProduct.read_maklabel_options">[docs]</a>    <span class="k">def</span> <span class="nf">read_maklabel_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the kernel list to return the ``MAKLABEL_OPTIONS``.</span>

<span class="sd">        The generated kernel list file must be used because it contains the</span>
<span class="sd">        ``MAKLABEL_OPTIONS``.</span>

<span class="sd">        :return: ``MAKLABEL_OPTIONS`` from kernel list</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kernel_list_file</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">working_directory</span>
            <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_acronym</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">run_type</span><span class="si">}</span><span class="s2">_&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">release</span><span class="p">)</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">.kernel_list&quot;</span>
        <span class="p">)</span>

        <span class="n">get_token</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">maklabel_options</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">kernel_list_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">lst</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">get_token</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">get_token</span> <span class="ow">and</span> <span class="s2">&quot;MAKLABEL_OPTIONS&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">maklabel_options</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">get_token</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">maklabel_options</span><span class="p">:</span>
            <span class="n">error_message</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> does not have a MAKLABEL_OPTIONS on </span><span class="si">{</span><span class="n">kernel_list_file</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
                <span class="n">setup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">maklabel_options</span></div>

<div class="viewcode-block" id="SpiceKernelProduct.coverage"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.SpiceKernelProduct.coverage">[docs]</a>    <span class="k">def</span> <span class="nf">coverage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine the product coverage.&quot;&quot;&quot;</span>
        <span class="n">system</span> <span class="o">=</span> <span class="s2">&quot;UTC&quot;</span>
        <span class="c1">#</span>
        <span class="c1"># Before computing the coverage we check if the label is already</span>
        <span class="c1"># present.</span>
        <span class="c1">#</span>
        <span class="n">coverage</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">product_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.xml&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">product_label</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">product_label</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">lbl</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lbl</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;&lt;start_date_time&gt;&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">start</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&lt;start_date_time&gt;&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">start</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&lt;/start_date_time&gt;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s2">&quot;&lt;stop_date_time&gt;&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">stop</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&lt;stop_date_time&gt;&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">stop</span> <span class="o">=</span> <span class="n">stop</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&lt;/stop_date_time&gt;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">start</span> <span class="ow">and</span> <span class="n">stop</span><span class="p">:</span>
                        <span class="n">coverage</span> <span class="o">=</span> <span class="p">[</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">]</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;-- Coverage obtained from existing &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;label: &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">product_label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">coverage</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;spk&quot;</span><span class="p">:</span>

                <span class="c1">#</span>
                <span class="c1"># For PDS3, do not consider the main body for coverage but all</span>
                <span class="c1"># bodies, to follow MAKLABEL style.</span>
                <span class="c1">#</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span><span class="p">:</span>
                    <span class="n">main_name</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">main_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">spice_name</span>

                <span class="n">coverage</span> <span class="o">+=</span> <span class="n">spk_coverage</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                    <span class="n">main_name</span><span class="o">=</span><span class="n">main_name</span><span class="p">,</span>
                    <span class="n">date_format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">date_format</span><span class="p">,</span>
                    <span class="n">system</span><span class="o">=</span><span class="n">system</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;ck&quot;</span><span class="p">:</span>
                <span class="n">coverage</span> <span class="o">+=</span> <span class="n">ck_coverage</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">date_format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">date_format</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="n">system</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">extension</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;bpc&quot;</span><span class="p">:</span>
                <span class="n">coverage</span> <span class="o">+=</span> <span class="n">pck_coverage</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">date_format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">date_format</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="n">system</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;dsk&quot;</span><span class="p">:</span>
                <span class="n">coverage</span> <span class="o">+=</span> <span class="n">dsk_coverage</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">date_format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">date_format</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="n">system</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span><span class="p">:</span>
                    <span class="n">coverage</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&quot;N/A&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;N/A&quot;&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">coverage</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_finish</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">coverage</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_time</span> <span class="o">=</span> <span class="n">coverage</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>

<div class="viewcode-block" id="SpiceKernelProduct.ck_kernel_ids"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.SpiceKernelProduct.ck_kernel_ids">[docs]</a>    <span class="k">def</span> <span class="nf">ck_kernel_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract IDs from CK.</span>

<span class="sd">        :return: List of IDs present in the CK</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">spiceypy</span><span class="o">.</span><span class="n">ckobj</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">id_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">id_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>

        <span class="n">id_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">id_list</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">id_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="SpiceKernelProduct.ik_kernel_ids"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.SpiceKernelProduct.ik_kernel_ids">[docs]</a>    <span class="k">def</span> <span class="nf">ik_kernel_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract IDs from IK.</span>

<span class="sd">        :return: List of IDs present in the IK</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>

            <span class="n">id_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">parse_bool</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>

                <span class="k">if</span> <span class="s2">&quot;begindata&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">parse_bool</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="s2">&quot;begintext&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">parse_bool</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="s2">&quot;INS-&quot;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">parse_bool</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
                    <span class="n">id_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">:])</span>

        <span class="n">id_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">id_list</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">id_list</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MetaKernelProduct"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.MetaKernelProduct">[docs]</a><span class="k">class</span> <span class="nc">MetaKernelProduct</span><span class="p">(</span><span class="n">Product</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Product child class Meta-Kernel.</span>

<span class="sd">    :param setup: NPB execution setup object</span>
<span class="sd">    :type setup: object</span>
<span class="sd">    :param kernel: Meta-kernel path</span>
<span class="sd">    :type kernel: str</span>
<span class="sd">    :param spice_kernels_collection: SPICE Kernel Collection</span>
<span class="sd">    :type spice_kernels_collection: object</span>
<span class="sd">    :param user_input: Indicates whether if the meta-kernel is provided by the user</span>
<span class="sd">    :type user_input: bool</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">setup</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
        <span class="n">kernel</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
        <span class="n">spice_kernels_collection</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
        <span class="n">user_input</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Constructor.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_input</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Copy meta-kernel: </span><span class="si">{</span><span class="n">kernel</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">kernel</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Generate meta-kernel: </span><span class="si">{</span><span class="n">kernel</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">setup</span><span class="o">.</span><span class="n">templates_directory</span><span class="si">}</span><span class="s2">/template_metakernel.tm&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">new_product</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">spice_kernels_collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_format</span> <span class="o">=</span> <span class="s2">&quot;Character&quot;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="ow">in</span> <span class="n">kernel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">kernel</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">extension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">extension_to_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Add the configuration items for the meta-kernel.</span>
        <span class="c1"># This includes sorting out the meta-kernel name.</span>
        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">metak</span> <span class="ow">in</span> <span class="n">setup</span><span class="o">.</span><span class="n">mk</span><span class="p">:</span>

            <span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">metak</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span>
                <span class="n">name_pattern</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="s2">&quot;pattern&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_pattern</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">patterns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name_pattern</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">patterns</span> <span class="o">+=</span> <span class="n">name_pattern</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">match_patterns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">metak</span><span class="p">[</span><span class="s2">&quot;@name&quot;</span><span class="p">],</span> <span class="n">patterns</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mk_setup</span> <span class="o">=</span> <span class="n">metak</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;VERSION&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">values</span>
                <span class="c1">#</span>
                <span class="c1"># If it is a yearly meta-kernel we need the year to set</span>
                <span class="c1"># set the coverage of the meta-kernel.</span>
                <span class="c1">#</span>
                <span class="k">if</span> <span class="s2">&quot;YEAR&quot;</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">year</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;YEAR&quot;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">YEAR</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;YEAR&quot;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;mk_setup&quot;</span><span class="p">):</span>
            <span class="n">error_message</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Meta-kernel </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> has not been matched &quot;</span> <span class="sa">f</span><span class="s2">&quot;in configuration.&quot;</span><span class="p">,</span>
                <span class="n">setup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection_path</span> <span class="o">=</span> <span class="n">setup</span><span class="o">.</span><span class="n">staging_directory</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s2">&quot;extras&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
            <span class="n">product_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_path</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">KERNELPATH</span> <span class="o">=</span> <span class="s2">&quot;./data&quot;</span>
        <span class="k">elif</span> <span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection_path</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">setup</span><span class="o">.</span><span class="n">staging_directory</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s2">&quot;spice_kernels&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
            <span class="p">)</span>
            <span class="n">product_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_path</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">KERNELPATH</span> <span class="o">=</span> <span class="s2">&quot;..&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">AUTHOR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">producer_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MISSION_NAME</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_name</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">,</span> <span class="s2">&quot;creation_date_time&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">MK_CREATION_DATE</span> <span class="o">=</span> <span class="n">current_date</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">creation_date_time</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">MK_CREATION_DATE</span> <span class="o">=</span> <span class="n">current_date</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SPICE_NAME</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">spice_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">INSTITUTION</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">institution</span>

        <span class="c1">#</span>
        <span class="c1"># Generate the meta-kernel directory if not present</span>
        <span class="c1">#</span>
        <span class="n">safe_make_directory</span><span class="p">(</span><span class="n">product_path</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Name the meta-kernel; if the meta-kernel is manually provided this</span>
        <span class="c1"># step is skipped.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">user_input</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">kernel</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">product_path</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">FILE_NAME</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="c1">#</span>
        <span class="c1"># Check product version if the current archive is not the</span>
        <span class="c1"># first release or if the mk_setup configuration section has been</span>
        <span class="c1"># provided.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">increment</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">,</span> <span class="s2">&quot;mk_setup&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_version</span><span class="p">()</span>

        <span class="c1">#</span>
        <span class="c1"># Generate the product LIDVID.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_product_lid</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_product_vid</span><span class="p">()</span>

            <span class="c1">#</span>
            <span class="c1"># The meta-kernel must be named before fetching the description.</span>
            <span class="c1">#</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_description</span><span class="p">()</span>

        <span class="c1">#</span>
        <span class="c1"># Generate the meta-kernel.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_input</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Meta-kernel already exists: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;-- The meta-kernel will be generated and the one &quot;</span>
                    <span class="s2">&quot;present in the staging are will be overwritten.&quot;</span>
                <span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;-- Note that to provide a meta-kernel as an input, &quot;</span>
                    <span class="s2">&quot;it must be provided via configuration file.&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_product</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Implement manual provision of meta-kernel.</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">product_path</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">product_path</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">new_product</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1">#</span>
        <span class="c1"># Following the product generation we read the kernels again to</span>
        <span class="c1"># include all the kernels present.</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_metakernel</span> <span class="o">=</span> <span class="n">mk_to_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># Set the meta-kernel times</span>
            <span class="c1">#</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coverage</span><span class="p">()</span>

            <span class="c1">#</span>
            <span class="c1"># Extract the required information from the kernel list read from</span>
            <span class="c1"># configuration for the product.</span>
            <span class="c1">#</span>
            <span class="p">(</span><span class="n">observers</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_observer_and_target</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">observers</span> <span class="o">=</span> <span class="n">observers</span>

        <span class="n">Product</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Labeling meta-kernel: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">MetaKernelPDS4Label</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="MetaKernelProduct.check_version"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.MetaKernelProduct.check_version">[docs]</a>    <span class="k">def</span> <span class="nf">check_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if the provided Meta-kernel version is correct.&quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1"># Distinguish in between the different kernels we can find in the</span>
        <span class="c1"># previous increment.</span>
        <span class="c1">#</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_setup</span><span class="p">[</span><span class="s2">&quot;@name&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>

            <span class="c1">#</span>
            <span class="c1"># So far, only the pattern key YEAR is incorporated to sort out</span>
            <span class="c1"># the version of the meta-kernel name.</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;YEAR&quot;</span><span class="p">:</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;$&quot;</span> <span class="o">+</span> <span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;$&quot;</span> <span class="o">+</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;?&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>

        <span class="n">versions</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">bundle_directory</span><span class="si">}</span><span class="s2">/&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_acronym</span><span class="si">}</span><span class="s2">_spice/&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;spice_kernels/mk/</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="n">versions</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">version_index</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">)</span>

            <span class="n">version</span> <span class="o">=</span> <span class="n">versions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">version</span><span class="p">[</span><span class="n">version_index</span> <span class="p">:</span> <span class="n">version_index</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">key</span><span class="p">])]</span>
            <span class="n">version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">version</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;-- Version from kernel list and from previous &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;increment agree: </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;-- The meta-kernel version is not as expected &quot;</span>
                    <span class="s2">&quot;from previous increment.&quot;</span>
                <span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;   Version set to: </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span><span class="si">}</span><span class="s2">, whereas &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;it is expected to be: </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;   It is recommended to stop the execution and fix the issue.&quot;</span>
                <span class="p">)</span>

        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;-- Meta-kernel from previous increment is not available.&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Version will be set to: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MetaKernelProduct.set_product_lid"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.MetaKernelProduct.set_product_lid">[docs]</a>    <span class="k">def</span> <span class="nf">set_product_lid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the Meta-kernel LID.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;mk&quot;</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_v&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="n">product_lid</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:spice_kernels:</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">logical_identifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">name</span>
        <span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lid</span> <span class="o">=</span> <span class="n">product_lid</span></div>

<div class="viewcode-block" id="MetaKernelProduct.set_product_vid"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.MetaKernelProduct.set_product_vid">[docs]</a>    <span class="k">def</span> <span class="nf">set_product_vid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the Meta-kernel VID.</span>

<span class="sd">        If the meta-kernel has been automatically generated as indicated in</span>
<span class="sd">        the configuration file, it has a version attribute, otherwise it does</span>
<span class="sd">        not and its version number must be equal to the expected VID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">product_vid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.0&quot;</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;-- </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> No VID explicit in kernel name: set to 1.0&quot;</span>
            <span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;-- Make sure that the MK pattern in the &quot;</span>
                <span class="s2">&quot;configuration file is correct, if manually provided make sure &quot;</span>
                <span class="s2">&quot;you provided the appropriate name.&quot;</span>
            <span class="p">)</span>
            <span class="n">product_vid</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span>

            <span class="c1">#</span>
            <span class="c1"># Implement this exceptional check for first releases of an archive.</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="s2">&quot;01&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="n">error_message</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> version does not correspond to VID &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;1.0. Rename the MK accordingly.&quot;</span><span class="p">,</span>
                    <span class="n">setup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vid</span> <span class="o">=</span> <span class="n">product_vid</span></div>

<div class="viewcode-block" id="MetaKernelProduct.get_description"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.MetaKernelProduct.get_description">[docs]</a>    <span class="k">def</span> <span class="nf">get_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Obtain the kernel product description information.&quot;&quot;&quot;</span>
        <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">json_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">kernel_list_config</span>

        <span class="n">kernel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">re_config</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">kernel</span><span class="p">):</span>

                <span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_config</span><span class="p">[</span><span class="n">pattern</span><span class="o">.</span><span class="n">pattern</span><span class="p">][</span><span class="s2">&quot;description&quot;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">patterns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_config</span><span class="p">[</span><span class="n">pattern</span><span class="o">.</span><span class="n">pattern</span><span class="p">][</span><span class="s2">&quot;patterns&quot;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                    <span class="n">patterns</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># try:</span>
                <span class="c1">#     options = self.json_config[pattern.pattern][&quot;mklabel_options&quot;]</span>
                <span class="c1"># except BaseException:</span>
                <span class="c1">#     options = &quot;&quot;</span>
                <span class="c1"># try:</span>
                <span class="c1">#     mapping = self.json_config[pattern.pattern][&quot;mapping&quot;]</span>
                <span class="c1"># except BaseException:</span>
                <span class="c1">#     mapping = &quot;&quot;</span>

                <span class="c1">#</span>
                <span class="c1"># ``options&#39;&#39; and ``descriptions&#39;&#39; require substituting</span>
                <span class="c1"># parameters derived from the filenames</span>
                <span class="c1"># themselves.</span>
                <span class="c1">#</span>
                <span class="k">if</span> <span class="n">patterns</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;$&quot;</span> <span class="o">+</span> <span class="n">el</span><span class="p">)</span> <span class="ow">in</span> <span class="n">description</span><span class="p">:</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">[</span><span class="n">el</span><span class="p">]</span>

                            <span class="c1">#</span>
                            <span class="c1"># There are two distinct patterns:</span>
                            <span class="c1">#    * extracted form the filename</span>
                            <span class="c1">#    * defined in the configuration file.</span>
                            <span class="c1">#</span>
                            <span class="k">if</span> <span class="p">(</span>
                                <span class="s2">&quot;@pattern&quot;</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">[</span><span class="n">el</span><span class="p">]</span>
                                <span class="ow">and</span> <span class="n">patterns</span><span class="p">[</span><span class="n">el</span><span class="p">][</span><span class="s2">&quot;@pattern&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;kernel&quot;</span>
                            <span class="p">):</span>
                                <span class="c1">#</span>
                                <span class="c1"># When extracted from the filename, the</span>
                                <span class="c1"># keyword is matched in between patterns.</span>
                                <span class="c1">#</span>

                                <span class="c1">#</span>
                                <span class="c1"># First Turn the regex set into a single</span>
                                <span class="c1"># character to be able to know were in the</span>
                                <span class="c1"># filename is.</span>
                                <span class="c1">#</span>
                                <span class="n">patt_ker</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;#text&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[0-9]&quot;</span><span class="p">,</span> <span class="s2">&quot;$&quot;</span><span class="p">)</span>
                                <span class="n">patt_ker</span> <span class="o">=</span> <span class="n">patt_ker</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[a-z]&quot;</span><span class="p">,</span> <span class="s2">&quot;$&quot;</span><span class="p">)</span>
                                <span class="n">patt_ker</span> <span class="o">=</span> <span class="n">patt_ker</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[A-Z]&quot;</span><span class="p">,</span> <span class="s2">&quot;$&quot;</span><span class="p">)</span>
                                <span class="n">patt_ker</span> <span class="o">=</span> <span class="n">patt_ker</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[a-zA-Z]&quot;</span><span class="p">,</span> <span class="s2">&quot;$&quot;</span><span class="p">)</span>

                                <span class="c1">#</span>
                                <span class="c1"># Split the resulting pattern to build up the</span>
                                <span class="c1"># indexes to extract the value from the kernel</span>
                                <span class="c1"># name.</span>
                                <span class="c1">#</span>
                                <span class="n">patt_split</span> <span class="o">=</span> <span class="n">patt_ker</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">el</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                                <span class="c1">#</span>
                                <span class="c1"># Create a list with the length of each part.</span>
                                <span class="c1">#</span>
                                <span class="n">indexes</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">patt_split</span><span class="p">:</span>
                                    <span class="n">indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">element</span><span class="p">))</span>

                                <span class="c1">#</span>
                                <span class="c1"># Extract the value with the index from the</span>
                                <span class="c1"># kernel name.</span>
                                <span class="c1">#</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indexes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                    <span class="n">value</span> <span class="o">=</span> <span class="n">kernel</span><span class="p">[</span>
                                        <span class="n">indexes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span> <span class="o">-</span> <span class="n">indexes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                    <span class="p">]</span>
                                    <span class="k">if</span> <span class="n">patterns</span><span class="p">[</span><span class="n">el</span><span class="p">][</span><span class="s2">&quot;@pattern&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
                                        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                                        <span class="c1">#</span>
                                        <span class="c1"># Write the value of the pattern for</span>
                                        <span class="c1"># future use.</span>
                                        <span class="c1">#</span>
                                        <span class="n">patterns</span><span class="p">[</span><span class="n">el</span><span class="p">][</span><span class="s2">&quot;&amp;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">error_message</span><span class="p">(</span>
                                        <span class="sa">f</span><span class="s2">&quot;Kernel pattern </span><span class="si">{</span><span class="n">patt_ker</span><span class="si">}</span><span class="s2"> &quot;</span>
                                        <span class="sa">f</span><span class="s2">&quot;not adept to write &quot;</span>
                                        <span class="sa">f</span><span class="s2">&quot;description. Remember a &quot;</span>
                                        <span class="sa">f</span><span class="s2">&quot;metacharacter &quot;</span>
                                        <span class="sa">f</span><span class="s2">&quot;cannot start or finish &quot;</span>
                                        <span class="sa">f</span><span class="s2">&quot;a kernel pattern.&quot;</span><span class="p">,</span>
                                        <span class="n">setup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">,</span>
                                    <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1">#</span>
                                <span class="c1"># For non-kernels the value is based on the</span>
                                <span class="c1"># value within the tag that needs to be</span>
                                <span class="c1"># provided by the user; there is no way this</span>
                                <span class="c1"># can be done automatically.</span>
                                <span class="c1">#</span>
                                <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">[</span><span class="n">el</span><span class="p">]:</span>
                                    <span class="k">if</span> <span class="n">kernel</span> <span class="o">==</span> <span class="n">val</span><span class="p">[</span><span class="s2">&quot;@value&quot;</span><span class="p">]:</span>
                                        <span class="n">value</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s2">&quot;#text&quot;</span><span class="p">]</span>
                                        <span class="c1">#</span>
                                        <span class="c1"># Write the value of the pattern for</span>
                                        <span class="c1"># future use.</span>
                                        <span class="c1">#</span>
                                        <span class="n">patterns</span><span class="p">[</span><span class="n">el</span><span class="p">][</span><span class="s2">&quot;&amp;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                                    <span class="n">error_message</span><span class="p">(</span>
                                        <span class="sa">f</span><span class="s2">&quot;-- Kernel description &quot;</span>
                                        <span class="sa">f</span><span class="s2">&quot;could not be updated with &quot;</span>
                                        <span class="sa">f</span><span class="s2">&quot;pattern: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
                                        <span class="n">setup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">,</span>
                                    <span class="p">)</span>

                            <span class="n">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;$&quot;</span> <span class="o">+</span> <span class="n">el</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="n">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="s2">&quot;  &quot;</span> <span class="ow">in</span> <span class="n">description</span><span class="p">:</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">description</span><span class="p">:</span>
            <span class="n">error_message</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> does not have a description on configuration file.&quot;</span><span class="p">,</span>
                <span class="n">setup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">description</span></div>

<div class="viewcode-block" id="MetaKernelProduct.write_product"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.MetaKernelProduct.write_product">[docs]</a>    <span class="k">def</span> <span class="nf">write_product</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write the Meta-kernel.&quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1"># Obtain meta-kernel grammar from configuration.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="s2">&quot;grammar&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_setup</span><span class="p">:</span>
            <span class="n">error_message</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Meta-kernel grammar not defined in configuration for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">kernel_grammar_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_setup</span><span class="p">[</span><span class="s2">&quot;grammar&quot;</span><span class="p">][</span><span class="s2">&quot;pattern&quot;</span><span class="p">]</span>

        <span class="c1">#</span>
        <span class="c1"># We scan the kernel directory to obtain the list of available kernels</span>
        <span class="c1">#</span>
        <span class="n">kernel_type_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lsk&quot;</span><span class="p">,</span> <span class="s2">&quot;pck&quot;</span><span class="p">,</span> <span class="s2">&quot;fk&quot;</span><span class="p">,</span> <span class="s2">&quot;ik&quot;</span><span class="p">,</span> <span class="s2">&quot;sclk&quot;</span><span class="p">,</span> <span class="s2">&quot;spk&quot;</span><span class="p">,</span> <span class="s2">&quot;ck&quot;</span><span class="p">,</span> <span class="s2">&quot;dsk&quot;</span><span class="p">]</span>

        <span class="c1">#</span>
        <span class="c1"># Setup the end-of-line character</span>
        <span class="c1">#</span>
        <span class="n">eol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">eol_mk</span>

        <span class="c1">#</span>
        <span class="c1"># All the files of the directory are read into a list</span>
        <span class="c1">#</span>
        <span class="n">mkgen_kernels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">excluded_kernels</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">kernel_type</span> <span class="ow">in</span> <span class="n">kernel_type_list</span><span class="p">:</span>

            <span class="c1">#</span>
            <span class="c1"># First we build the list of excluded kernels</span>
            <span class="c1">#</span>
            <span class="k">for</span> <span class="n">kernel_grammar</span> <span class="ow">in</span> <span class="n">kernel_grammar_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;exclude:&quot;</span> <span class="ow">in</span> <span class="n">kernel_grammar</span><span class="p">:</span>
                    <span class="n">excluded_kernels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kernel_grammar</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;exclude:&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;     Matching </span><span class="si">{</span><span class="n">kernel_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">(s) with meta-kernel grammar.&quot;</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">kernel_grammar</span> <span class="ow">in</span> <span class="n">kernel_grammar_list</span><span class="p">:</span>

                <span class="k">if</span> <span class="s2">&quot;date:&quot;</span> <span class="ow">in</span> <span class="n">kernel_grammar</span><span class="p">:</span>
                    <span class="n">kernel_grammar</span> <span class="o">=</span> <span class="n">kernel_grammar</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;date:&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">dates</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dates</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1">#</span>
                <span class="c1"># Kernels can come from several kernel directories or from the</span>
                <span class="c1"># previous meta-kernel. Paths are provided by the parameter</span>
                <span class="c1"># paths and meta-kernels with mks.</span>
                <span class="c1">#</span>
                <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">mks</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">kernel_grammar</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">type_to_extension</span><span class="p">(</span>
                    <span class="n">kernel_type</span>
                <span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span><span class="p">:</span>
                            <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">staging_directory</span> <span class="o">+</span> <span class="s2">&quot;/DATA&quot;</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">staging_directory</span> <span class="o">+</span> <span class="s2">&quot;/spice_kernels&quot;</span>
                            <span class="p">)</span>
                        <span class="c1"># paths.append(self.setup.kernels_directory)</span>

                        <span class="c1">#</span>
                        <span class="c1"># Try to look for meta-kernels from previous</span>
                        <span class="c1"># increments.</span>
                        <span class="c1">#</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">mks</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">bundle_directory</span><span class="si">}</span><span class="s2">/&quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_acronym</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;_spice/spice_kernels/mk/&quot;</span>
                                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_v&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">*.tm&#39;</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">increment</span><span class="p">:</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                    <span class="s2">&quot;-- No meta-kernels from &quot;</span>
                                    <span class="s2">&quot;previous increment &quot;</span>
                                    <span class="s2">&quot;available.&quot;</span>
                                <span class="p">)</span>

                        <span class="n">latest_kernel</span> <span class="o">=</span> <span class="n">get_latest_kernel</span><span class="p">(</span>
                            <span class="n">kernel_type</span><span class="p">,</span>
                            <span class="n">paths</span><span class="p">,</span>
                            <span class="n">kernel_grammar</span><span class="p">,</span>
                            <span class="n">dates</span><span class="o">=</span><span class="n">dates</span><span class="p">,</span>
                            <span class="n">excluded_kernels</span><span class="o">=</span><span class="n">excluded_kernels</span><span class="p">,</span>
                            <span class="n">mks</span><span class="o">=</span><span class="n">mks</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Exception: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">latest_kernel</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">if</span> <span class="n">latest_kernel</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">latest_kernel</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">latest_kernel</span> <span class="o">=</span> <span class="p">[</span><span class="n">latest_kernel</span><span class="p">]</span>

                        <span class="k">for</span> <span class="n">kernel</span> <span class="ow">in</span> <span class="n">latest_kernel</span><span class="p">:</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        Matched: </span><span class="si">{</span><span class="n">kernel</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">mkgen_kernels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kernel_type</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">kernel</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Remove duplicate entries from the kernel list (possible depending on</span>
        <span class="c1"># the grammar).</span>
        <span class="c1">#</span>
        <span class="n">mkgen_kernels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">OrderedDict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">mkgen_kernels</span><span class="p">))</span>

        <span class="c1">#</span>
        <span class="c1"># Subset the SPICE kernels collection with the kernels in the MK</span>
        <span class="c1"># only.</span>
        <span class="c1">#</span>
        <span class="n">collection_metakernel</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">spice_kernel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">product</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">mkgen_kernels</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">spice_kernel</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">collection_metakernel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spice_kernel</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">collection_metakernel</span> <span class="o">=</span> <span class="n">collection_metakernel</span>

        <span class="c1">#</span>
        <span class="c1"># Report kernels present in meta-kernel</span>
        <span class="c1">#</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-- Archived kernels present in meta-kernel&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">kernel</span> <span class="ow">in</span> <span class="n">collection_metakernel</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     </span><span class="si">{</span><span class="n">kernel</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">num_ker_total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">product</span><span class="p">)</span>
        <span class="n">num_ker_mk</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">collection_metakernel</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">num_ker_total</span> <span class="o">!=</span> <span class="n">num_ker_mk</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Archived kernels:           </span><span class="si">{</span><span class="n">num_ker_total</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Kernels in meta-kernel:     </span><span class="si">{</span><span class="n">num_ker_mk</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Archived kernels:           </span><span class="si">{</span><span class="n">num_ker_total</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Kernels in meta-kernel:     </span><span class="si">{</span><span class="n">num_ker_mk</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># The kernel list for the new mk is formatted accordingly</span>
        <span class="c1">#</span>
        <span class="n">kernels</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">kernel_dir_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">kernel</span> <span class="ow">in</span> <span class="n">mkgen_kernels</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">kernel_dir_name</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">kernel_dir_name</span> <span class="o">!=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">kernels</span> <span class="o">+=</span> <span class="n">eol</span>

            <span class="n">kernel_dir_name</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">kernels</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">26</span><span class="si">}</span><span class="s2">&#39;$KERNELS/</span><span class="si">{</span><span class="n">kernel</span><span class="si">}</span><span class="s2">&#39;</span><span class="si">{</span><span class="n">eol</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">KERNELS_IN_METAKERNEL</span> <span class="o">=</span> <span class="n">kernels</span>

        <span class="c1">#</span>
        <span class="c1"># Introduce and curate the rest of fields from configuration</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="s2">&quot;data&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_setup</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_setup</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;description&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_setup</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]:</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_setup</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;description&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">curated_data</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">curated_desc</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">first_line</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="c1">#</span>
            <span class="c1"># We want to remove the blanks if the line is empty.</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">curated_data</span> <span class="o">+=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">first_line</span><span class="p">:</span>
                    <span class="n">curated_data</span> <span class="o">+=</span> <span class="n">eol</span>
                <span class="n">first_line</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">curated_data</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="n">eol</span>

        <span class="n">metakernel_dictionary</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">desc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="c1">#</span>
            <span class="c1"># We want to remove the blanks if the line is empty, and replace</span>
            <span class="c1"># any possible keywords.</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">curated_desc</span> <span class="o">+=</span> <span class="n">eol</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metakernel_dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="n">key</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span>
                        <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">line</span>
                        <span class="ow">and</span> <span class="s2">&quot;$&quot;</span> <span class="ow">in</span> <span class="n">line</span>
                    <span class="p">):</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;$&quot;</span> <span class="o">+</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="n">curated_desc</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="n">eol</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">DATA</span> <span class="o">=</span> <span class="n">curated_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DESCRIPTION</span> <span class="o">=</span> <span class="n">curated_desc</span>

        <span class="n">metakernel_dictionary</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metakernel_dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                            <span class="ow">and</span> <span class="n">key</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span>
                            <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">line</span>
                            <span class="ow">and</span> <span class="s2">&quot;$&quot;</span> <span class="ow">in</span> <span class="n">line</span>
                        <span class="p">):</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;$&quot;</span> <span class="o">+</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">eol</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-- Meta-kernel generated.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">silent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;   * Created &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">staging_directory</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># If the meta-kernel has been generated by NPB with a given grammar,</span>
        <span class="c1"># etc. pause the pipeline to allow the user to introduce changes.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;mk_setup&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;mk_setup&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;interrupt_to_update&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_setup</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_setup</span><span class="p">[</span><span class="s2">&quot;interrupt_to_update&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;    * The meta-kernel might need to be updated. You can:&quot;</span>
                        <span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s1">&#39;        - Type &quot;vi&quot; and press ENTER to edit the &#39;</span>
                            <span class="s2">&quot;file with the VI text editor.&quot;</span>
                        <span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;        - Edit the file with your favorite edit &quot;</span>
                            <span class="s2">&quot;and press ENTER and continue.&quot;</span>
                        <span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;        - Press ENTER to continue.&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      MK path: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                        <span class="n">inp</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;&gt;&gt; Type &#39;vi&#39; and/or press ENTER to continue... &quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;vi&quot;</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">cmd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;EDITOR&quot;</span><span class="p">,</span> <span class="s2">&quot;vi&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span>
                                <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                    <span class="s2">&quot;-- Meta-kernel edited with Vi by the user.&quot;</span>
                                <span class="p">)</span>
                            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Vi text editor is not available.&quot;</span><span class="p">)</span>
                                <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;&gt;&gt; Press Enter to continue... &quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">diff</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compare</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="MetaKernelProduct.compare"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.MetaKernelProduct.compare">[docs]</a>    <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;**Compare the Meta-kernel with the previous version**.</span>

<span class="sd">        The MK is compared with a previous version of the MK. If no prior</span>
<span class="sd">        MK is found, the new MK is compared to NPB&#39;s MK template.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">val_mk</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1">#</span>
        <span class="c1"># Compare meta-kernel with latest. First try with previous increment.</span>
        <span class="c1">#</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">match_flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">val_mk_path</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">bundle_directory</span><span class="si">}</span><span class="s2">/&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_acronym</span><span class="si">}</span><span class="s2">_spice/spice_kernels/mk/&quot;</span>
            <span class="p">)</span>

            <span class="n">val_mk_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">while</span> <span class="n">match_flag</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_mk_name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">val_mks</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">val_mk_path</span> <span class="o">+</span> <span class="n">val_mk_name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;*.tm&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">val_mks</span><span class="p">:</span>
                        <span class="n">val_mks</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">val_mks</span><span class="p">)</span>
                        <span class="n">val_mk</span> <span class="o">=</span> <span class="n">val_mks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">match_flag</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">match_flag</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">val_mk</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No label for comparison found.&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># If previous increment does not work, compare with the MK</span>
            <span class="c1"># template.</span>
            <span class="c1">#</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- No other version of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> has been found.&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;-- Comparing with meta-kernel template.&quot;</span><span class="p">)</span>

            <span class="n">val_mk</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">templates_directory</span><span class="si">}</span><span class="s2">/template_metakernel.tm&quot;</span>

        <span class="n">fromfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span>
        <span class="n">tofile</span> <span class="o">=</span> <span class="n">val_mk</span>
        <span class="nb">dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">working_directory</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;-- Comparing &quot;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_acronym</span><span class="si">}</span><span class="s2">_spice/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s2">&quot;...&quot;</span>
        <span class="p">)</span>
        <span class="n">compare_files</span><span class="p">(</span><span class="n">fromfile</span><span class="p">,</span> <span class="n">tofile</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">diff</span><span class="p">)</span></div>

<div class="viewcode-block" id="MetaKernelProduct.validate"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.MetaKernelProduct.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform a basic validation of the Meta-kernel.</span>

<span class="sd">        The validation consists of:</span>

<span class="sd">           * load the kernel with the SPICE API ``FURNSH``</span>
<span class="sd">           * count the loaded kernels with SPICE API ``KTOTAL``</span>
<span class="sd">           * compare the number of kernels in the kernel pool with the length</span>
<span class="sd">             of the MK collection list attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">step</span><span class="si">}</span><span class="s2"> - Meta-kernel </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> validation&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">silent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-- &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; - &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>

        <span class="n">rel_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_acronym</span><span class="si">}</span><span class="s2">_spice/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">path</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">bundle_directory</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_acronym</span><span class="si">}</span><span class="s2">_spice&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_acronym</span><span class="si">}</span><span class="s2">_spice/&quot;</span>
            <span class="o">+</span> <span class="n">rel_path</span>
        <span class="p">)</span>

        <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">mkdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">mkdir</span><span class="p">)</span>

        <span class="n">spiceypy</span><span class="o">.</span><span class="n">kclear</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">spiceypy</span><span class="o">.</span><span class="n">furnsh</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

            <span class="c1">#</span>
            <span class="c1"># In KTOTAL, all meta-kernels are counted in the total; therefore</span>
            <span class="c1"># we need to subtract 1 kernel.</span>
            <span class="c1">#</span>
            <span class="n">ker_num_fr</span> <span class="o">=</span> <span class="n">spiceypy</span><span class="o">.</span><span class="n">ktotal</span><span class="p">(</span><span class="s2">&quot;ALL&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">ker_num_mk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_metakernel</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Kernels loaded with FURNSH: </span><span class="si">{</span><span class="n">ker_num_fr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Kernels present in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ker_num_mk</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ker_num_fr</span> <span class="o">!=</span> <span class="n">ker_num_mk</span><span class="p">:</span>
                <span class="n">spiceypy</span><span class="o">.</span><span class="n">kclear</span><span class="p">()</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;-- Number of kernels loaded is not equal to kernels &quot;</span>
                    <span class="s2">&quot;present in meta-kernel.&quot;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;-- The MK could not be loaded with the SPICE API FURNSH.&quot;</span><span class="p">)</span>

        <span class="n">spiceypy</span><span class="o">.</span><span class="n">kclear</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span></div>

<div class="viewcode-block" id="MetaKernelProduct.coverage"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.MetaKernelProduct.coverage">[docs]</a>    <span class="nd">@spice_exception_handler</span>
    <span class="k">def</span> <span class="nf">coverage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine Meta-kernel coverage.</span>

<span class="sd">        Meta-kernel coverage is determined by:</span>

<span class="sd">        *  for whole mission meta-kernels ``start_date_time`` and ``stop_date_time``</span>
<span class="sd">           are set to the coverage provided by spacecraft SPK, CKs, or to other</span>
<span class="sd">           dates at the discretion of the archive producer. These other dates might</span>
<span class="sd">           be required for missions whose SPks and CKs do not explicitly cover the</span>
<span class="sd">           dates required by the archive, e.g.: a lander mission with a fixed</span>
<span class="sd">           position provided by an SPK with extended coverage</span>

<span class="sd">        *  for yearly mission meta-kernels ``start_date_time`` and ``stop_date_time``</span>
<span class="sd">           are set to the coverage from ``Jan 1 00:00`` of the year to either the</span>
<span class="sd">           end of coverage provided by spacecraft SPK or CKs, or the end of</span>
<span class="sd">           the year (whichever is earlier)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kernels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mk_sets_coverage</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1">#</span>
        <span class="c1"># Match the pattern with the kernels in the meta-kernel.</span>
        <span class="c1"># Only the kernel patterns identified with the meta-kernel attribute</span>
        <span class="c1"># will be used.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="s2">&quot;coverage_kernels&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_setup</span><span class="p">:</span>
            <span class="n">coverage_kernels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_setup</span><span class="p">[</span><span class="s2">&quot;coverage_kernels&quot;</span><span class="p">]</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="n">coverage_kernels</span><span class="p">[</span><span class="s2">&quot;pattern&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patterns</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="n">patterns</span><span class="p">]</span>

            <span class="c1">#</span>
            <span class="c1"># It is assumed that the coverage kernel is present in the</span>
            <span class="c1"># meta-kernel.</span>
            <span class="c1">#</span>
            <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
                <span class="c1">#</span>
                <span class="c1"># Only match coverage kernels that have the MK pattern in the</span>
                <span class="c1"># mk attribute.</span>
                <span class="c1">#</span>
                <span class="k">for</span> <span class="n">kernel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_metakernel</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">kernel</span><span class="p">):</span>
                        <span class="n">kernels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mk_sets_coverage</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">start_times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">finish_times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">kernels</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># Look for the identified kernel in the collection, if the kernel</span>
            <span class="c1"># is not present the coverage will have to be computed.</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="n">kernels</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">kernel</span> <span class="ow">in</span> <span class="n">kernels</span><span class="p">:</span>
                    <span class="n">ker_found</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">product</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">kernel</span> <span class="o">==</span> <span class="n">product</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                            <span class="n">start_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spiceypy</span><span class="o">.</span><span class="n">utc2et</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">start_time</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="n">finish_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spiceypy</span><span class="o">.</span><span class="n">utc2et</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">stop_time</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="n">ker_found</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="c1">#</span>
                    <span class="c1"># When the kernels are not present in the current</span>
                    <span class="c1"># collection, the coverage is computed.</span>
                    <span class="c1">#</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ker_found</span><span class="p">:</span>
                        <span class="n">path</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">bundle_directory</span><span class="si">}</span><span class="s2">/&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_acronym</span><span class="si">}</span><span class="s2">_spice/&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;spice_kernels/&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">extension_to_type</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">kernel</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

                        <span class="c1">#</span>
                        <span class="c1"># Added check of file size for test cases.</span>
                        <span class="c1">#</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;-- File not present in final area: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">.&quot;</span>
                            <span class="p">)</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="s2">&quot;   It will not be used to determine the coverage.&quot;</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">extension_to_type</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;spk&quot;</span><span class="p">:</span>
                                <span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">stop_time</span><span class="p">)</span> <span class="o">=</span> <span class="n">spk_coverage</span><span class="p">(</span>
                                    <span class="n">path</span><span class="p">,</span> <span class="n">main_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">spice_name</span>
                                <span class="p">)</span>
                            <span class="k">elif</span> <span class="n">extension_to_type</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;ck&quot;</span><span class="p">:</span>
                                <span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">stop_time</span><span class="p">)</span> <span class="o">=</span> <span class="n">ck_coverage</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">error_message</span><span class="p">(</span>
                                    <span class="s2">&quot;Kernel used to determine &quot;</span>
                                    <span class="s2">&quot;coverage is not a SPK or CK &quot;</span>
                                    <span class="s2">&quot;kernel.&quot;</span><span class="p">,</span>
                                    <span class="n">setup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">,</span>
                                <span class="p">)</span>

                            <span class="n">start_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spiceypy</span><span class="o">.</span><span class="n">utc2et</span><span class="p">(</span><span class="n">start_time</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="n">finish_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spiceypy</span><span class="o">.</span><span class="n">utc2et</span><span class="p">(</span><span class="n">stop_time</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

                            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;-- File </span><span class="si">{</span><span class="n">kernel</span><span class="si">}</span><span class="s2"> used to determine coverage.&quot;</span>
                            <span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># If it is a yearly meta-kernel; we need to handle it separately.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">start_times</span> <span class="ow">and</span> <span class="n">finish_times</span><span class="p">:</span>

            <span class="c1">#</span>
            <span class="c1"># The date can be January 1st, of the year or the mission start</span>
            <span class="c1"># date, but it should not be later or earlier than that.</span>
            <span class="c1">#</span>
            <span class="n">et_mission_start</span> <span class="o">=</span> <span class="n">spiceypy</span><span class="o">.</span><span class="n">utc2et</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_start</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">et_year_start</span> <span class="o">=</span> <span class="n">spiceypy</span><span class="o">.</span><span class="n">utc2et</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="si">}</span><span class="s2">-01-01T00:00:00&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">et_year_start</span> <span class="o">&gt;</span> <span class="n">et_mission_start</span><span class="p">:</span>
                <span class="n">start_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">et_year_start</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">et_mission_start</span><span class="p">]</span>

            <span class="c1">#</span>
            <span class="c1"># Update the end time of the meta-kernel</span>
            <span class="c1">#</span>
            <span class="n">et_year_stop</span> <span class="o">=</span> <span class="n">spiceypy</span><span class="o">.</span><span class="n">utc2et</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">-01-01T00:00:00&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">finish_times</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">et_year_stop</span><span class="p">:</span>
                <span class="n">finish_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">et_year_stop</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_sets_coverage</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;-- Meta-kernel will be used to determine SPICE &quot;</span> <span class="s2">&quot;Collection coverage.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s2">&quot;-- Meta-kernel will not be used to determine &quot;</span>
                    <span class="s2">&quot;SPICE Collection coverage.&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">start_time</span> <span class="o">=</span> <span class="n">spiceypy</span><span class="o">.</span><span class="n">et2utc</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">start_times</span><span class="p">),</span> <span class="s2">&quot;ISOC&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;Z&quot;</span>
            <span class="n">stop_time</span> <span class="o">=</span> <span class="n">spiceypy</span><span class="o">.</span><span class="n">et2utc</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">finish_times</span><span class="p">),</span> <span class="s2">&quot;ISOC&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;Z&quot;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Meta-kernel coverage: </span><span class="si">{</span><span class="n">start_time</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">stop_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># The alternative is to set the increment times to the increment</span>
            <span class="c1"># or mission times provided via configuration.</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">):</span>

                <span class="c1">#</span>
                <span class="c1"># In the case of yearly kernels the coverage must be constrained</span>
                <span class="c1"># within the limits of the year.</span>
                <span class="c1">#</span>
                <span class="n">et_mission_start</span> <span class="o">=</span> <span class="n">spiceypy</span><span class="o">.</span><span class="n">utc2et</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_start</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">et_mission_finish</span> <span class="o">=</span> <span class="n">spiceypy</span><span class="o">.</span><span class="n">utc2et</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_finish</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">et_incremn_finish</span> <span class="o">=</span> <span class="n">spiceypy</span><span class="o">.</span><span class="n">utc2et</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">increment_finish</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">et_year_start</span> <span class="o">=</span> <span class="n">spiceypy</span><span class="o">.</span><span class="n">utc2et</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="si">}</span><span class="s2">-01-01T00:00:00&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">et_year_start</span> <span class="o">&gt;</span> <span class="n">et_mission_start</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_start</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_start</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">start_time</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="si">}</span><span class="s2">-01-01T00:00:00Z&quot;</span>

                <span class="n">et_year_stop</span> <span class="o">=</span> <span class="n">spiceypy</span><span class="o">.</span><span class="n">utc2et</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">-01-01T00:00:00&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">et_incremn_finish</span> <span class="o">&lt;</span> <span class="n">et_year_stop</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">increment_finish</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="n">stop_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">increment_finish</span>
                <span class="k">elif</span> <span class="n">et_mission_finish</span> <span class="o">&lt;</span> <span class="n">et_year_stop</span><span class="p">:</span>
                    <span class="n">stop_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_finish</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">stop_time</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">-01-01T00:00:00Z&quot;</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;-- No kernel(s) found to determine MK coverage. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Times from configuration in accordance to yearly MK &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;will be used: </span><span class="si">{</span><span class="n">start_time</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">stop_time</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">start_time</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop_time</span> <span class="o">=</span> <span class="n">stop_time</span>

                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">,</span> <span class="s2">&quot;increment_start&quot;</span><span class="p">):</span>
                    <span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">increment_start</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_start</span>

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">,</span> <span class="s2">&quot;increment_finish&quot;</span><span class="p">):</span>
                    <span class="n">stop_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">increment_finish</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">stop_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_finish</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;-- No kernel(s) found to determine MK coverage. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Times from configuration will be used: </span><span class="si">{</span><span class="n">start_time</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">stop_time</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">start_time</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop_time</span> <span class="o">=</span> <span class="n">stop_time</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1">#</span>
            <span class="c1"># The obtained start and stop times for the meta-kernel might need</span>
            <span class="c1"># to be corrected for the increment start and stop times provided</span>
            <span class="c1"># via configuration.</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">,</span> <span class="s2">&quot;increment_start&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">):</span>
                    <span class="c1">#</span>
                    <span class="c1"># Check if the increment start year is the same as the yearly</span>
                    <span class="c1"># MK. If so update it.</span>
                    <span class="c1">#</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">increment_start</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">start_time</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]:</span>
                        <span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">increment_start</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;-- Coverage start time corrected with &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;increment start from configuration file to: </span><span class="si">{</span><span class="n">start_time</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">increment_start</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;-- Coverage start time corrected with &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;increment start from configuration file to: </span><span class="si">{</span><span class="n">start_time</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">,</span> <span class="s2">&quot;increment_finish&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">):</span>
                    <span class="c1">#</span>
                    <span class="c1"># Check if the increment finish year is the same as the yearly</span>
                    <span class="c1"># MK. If so update it.</span>
                    <span class="c1">#</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">increment_finish</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">stop_time</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]:</span>
                        <span class="n">stop_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">increment_finish</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;-- Coverage finish time corrected with &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;increment finish from configuration file to: </span><span class="si">{</span><span class="n">stop_time</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">stop_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">increment_finish</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;-- Coverage finish time corrected with &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;increment finish from configuration file to: </span><span class="si">{</span><span class="n">stop_time</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="c1">#</span>
            <span class="c1"># Re-format the time accordingly. The &#39;Z&#39; is removed from the UTC</span>
            <span class="c1"># string since it is not supported until the SPICE Toolkit N0067.</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span><span class="p">:</span>
                <span class="n">system</span> <span class="o">=</span> <span class="s2">&quot;TDB&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">system</span> <span class="o">=</span> <span class="s2">&quot;UTC&quot;</span>
            <span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">stop_time</span><span class="p">)</span> <span class="o">=</span> <span class="n">et_to_date</span><span class="p">(</span>
                <span class="n">spiceypy</span><span class="o">.</span><span class="n">utc2et</span><span class="p">(</span><span class="n">start_time</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">spiceypy</span><span class="o">.</span><span class="n">utc2et</span><span class="p">(</span><span class="n">stop_time</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">date_format</span><span class="p">,</span>
                <span class="n">system</span><span class="o">=</span><span class="n">system</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">start_time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_time</span> <span class="o">=</span> <span class="n">stop_time</span></div></div>


<div class="viewcode-block" id="OrbnumFileProduct"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.OrbnumFileProduct">[docs]</a><span class="k">class</span> <span class="nc">OrbnumFileProduct</span><span class="p">(</span><span class="n">Product</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Product child class ORBNUM File.</span>

<span class="sd">    :param setup: NPB execution setup object</span>
<span class="sd">    :type setup: object</span>
<span class="sd">    :param name: ORBNUM file path</span>
<span class="sd">    :type name: str</span>
<span class="sd">    :param collection: Miscellaneous Collection that contains the ORBNUM product</span>
<span class="sd">    :type collection: object</span>
<span class="sd">    :param spice_kernels_collection: SPICE Kernel Collection</span>
<span class="sd">    :type spice_kernels_collection: object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">setup</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
        <span class="n">collection</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
        <span class="n">spice_kernels_collection</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Constructor.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernels_collection</span> <span class="o">=</span> <span class="n">spice_kernels_collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extension</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">setup</span><span class="o">.</span><span class="n">orbnum_directory</span>

        <span class="k">if</span> <span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection_path</span> <span class="o">=</span> <span class="n">setup</span><span class="o">.</span><span class="n">staging_directory</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s2">&quot;extras&quot;</span>
            <span class="n">product_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_path</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s2">&quot;orbnum&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>

        <span class="k">elif</span> <span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection_path</span> <span class="o">=</span> <span class="n">setup</span><span class="o">.</span><span class="n">staging_directory</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s2">&quot;miscellaneous&quot;</span>
            <span class="n">product_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_path</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s2">&quot;orbnum&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>

        <span class="c1">#</span>
        <span class="c1"># Map the orbnum file with its configuration.</span>
        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">orbnum_type</span> <span class="ow">in</span> <span class="n">setup</span><span class="o">.</span><span class="n">orbnum</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">orbnum_type</span><span class="p">[</span><span class="s2">&quot;pattern&quot;</span><span class="p">],</span> <span class="n">name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_orbnum_type</span> <span class="o">=</span> <span class="n">orbnum_type</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pattern</span> <span class="o">=</span> <span class="n">orbnum_type</span><span class="p">[</span><span class="s2">&quot;pattern&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_orbnum_type&quot;</span><span class="p">):</span>
            <span class="n">error_message</span><span class="p">(</span>
                <span class="s2">&quot;The orbnum file does not match any type &quot;</span>
                <span class="s2">&quot;described in the configuration.&quot;</span><span class="p">,</span>
                <span class="n">setup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_product_lid</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_product_vid</span><span class="p">()</span>

        <span class="c1">#</span>
        <span class="c1"># We generate the kernel directory if not present</span>
        <span class="c1">#</span>
        <span class="n">safe_make_directory</span><span class="p">(</span><span class="n">product_path</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># We copy the file to the staging directory.</span>
        <span class="c1">#</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Copy </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> to staging directory.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">product_path</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">product_path</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_product</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> already present in staging directory.&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">new_product</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1">#</span>
        <span class="c1"># Add CRs to the ORBNUM file. Need reveiw for PDS3.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">check_eol</span><span class="p">(</span><span class="n">product_path</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">eol</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-- Adding CRLF to ORBNUM file.&quot;</span><span class="p">)</span>
                <span class="n">add_crs_to_file</span><span class="p">(</span>
                    <span class="n">product_path</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">eol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span>
                <span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># We update the path after having copied the kernel.</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">product_path</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="c1">#</span>
        <span class="c1"># We obtain the parameters required to fill the label.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_header</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_event_detection_key</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">header_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_header_length</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_previous_orbnum</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_records</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sample_record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sample_record</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_description</span><span class="p">()</span>

            <span class="c1">#</span>
            <span class="c1"># Table character description is only obtained if there are missing</span>
            <span class="c1"># records.</span>
            <span class="c1">#</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table_char_description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_character_description</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">get_params</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">coverage</span><span class="p">()</span>

            <span class="c1">#</span>
            <span class="c1"># Extract the required information from the kernel list read from</span>
            <span class="c1"># configuration for the product.</span>
            <span class="c1">#</span>
            <span class="p">(</span><span class="n">observers</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_observer_and_target</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">observers</span> <span class="o">=</span> <span class="n">observers</span>

        <span class="n">Product</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># The kernel is labeled.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Labeling </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">OrbnumFilePDS4Label</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="OrbnumFileProduct.set_product_lid"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.OrbnumFileProduct.set_product_lid">[docs]</a>    <span class="k">def</span> <span class="nf">set_product_lid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the Product LID.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lid</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:miscellaneous:orbnum_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">logical_identifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></div>

<div class="viewcode-block" id="OrbnumFileProduct.set_product_vid"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.OrbnumFileProduct.set_product_vid">[docs]</a>    <span class="k">def</span> <span class="nf">set_product_vid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the Product VID.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vid</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span></div>

<div class="viewcode-block" id="OrbnumFileProduct.set_previous_orbnum"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.OrbnumFileProduct.set_previous_orbnum">[docs]</a>    <span class="k">def</span> <span class="nf">set_previous_orbnum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine the previous version of the ORBNUM file.</span>

<span class="sd">        For some cases, more than one orbit number file</span>
<span class="sd">        may exist for a given SPK, with only one file having the same name</span>
<span class="sd">        as the SPK and other files having a version token appended to the</span>
<span class="sd">        SPK name. It is also possible that a version token is always present.</span>
<span class="sd">        This method finds the latest version of such an orbnum file in the</span>
<span class="sd">        final area.</span>

<span class="sd">        NPB assumes that the version pattern of the orbnum file name follows</span>
<span class="sd">        the REGEX pattern::</span>

<span class="sd">           _[vV][0-9]*[.]</span>

<span class="sd">        E.g.::</span>

<span class="sd">           (...)_v01.orb</span>
<span class="sd">           (...)_V9999.nrb</span>
<span class="sd">           (...)_v1.orb</span>

<span class="sd">        This method provides values to the ``_previous_orbnum`` and</span>
<span class="sd">        ``_orbnum_version`` protected attributes, both are strings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">bundle_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_acronym</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;_spice//miscellaneous/&quot;</span>
        <span class="p">]</span>
        <span class="n">previous_orbnum</span> <span class="o">=</span> <span class="n">get_latest_kernel</span><span class="p">(</span><span class="s2">&quot;orbnum&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pattern</span><span class="p">,</span> <span class="n">dates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">previous_orbnum</span><span class="p">:</span>

            <span class="n">version_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;_[vV][0-9]*[\.]&quot;</span>
            <span class="n">version_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">version_pattern</span><span class="p">,</span> <span class="n">previous_orbnum</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">,</span> <span class="n">version_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_previous_version</span> <span class="o">=</span> <span class="n">version</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">previous_orbnum</span> <span class="o">=</span> <span class="n">previous_orbnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1">#</span>
        <span class="c1"># If a previous orbnum file is not found, it might be due to the</span>
        <span class="c1"># fact that the file does not have a version explicitely indicated</span>
        <span class="c1"># by the filename.</span>
        <span class="c1">#</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="c1">#</span>
            <span class="c1"># Try to remove the version part of the filename pattern. For</span>
            <span class="c1"># the time being this implementation is limited to NAIF</span>
            <span class="c1"># orbnum files with this characteristics.</span>
            <span class="c1">#</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">version_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;_[vV]\[0\-9\]*[\.]&quot;</span>
                <span class="n">version_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">version_pattern</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pattern</span><span class="p">)</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pattern</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">version_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="c1">#</span>
                <span class="c1"># The pattern already does not have an explicit version</span>
                <span class="c1"># number.</span>
                <span class="c1">#</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pattern</span>

            <span class="n">previous_orbnum</span> <span class="o">=</span> <span class="n">get_latest_kernel</span><span class="p">(</span><span class="s2">&quot;orbnum&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">dates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">previous_orbnum</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_previous_orbnum</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_previous_orbnum</span> <span class="o">=</span> <span class="n">previous_orbnum</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_previous_version</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span></div>

<div class="viewcode-block" id="OrbnumFileProduct.read_header"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.OrbnumFileProduct.read_header">[docs]</a>    <span class="k">def</span> <span class="nf">read_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read and process an ORBNUM file header.</span>

<span class="sd">        Defines the record_fixed_length attribute that provides the length of</span>
<span class="sd">        a record.</span>

<span class="sd">        :return: ORBNUM header line</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o</span><span class="p">:</span>

            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_orbnum_type</span><span class="p">[</span><span class="s2">&quot;header_start_line&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_orbnum_type</span><span class="p">[</span><span class="s2">&quot;header_start_line&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">o</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

            <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
            <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>

        <span class="c1">#</span>
        <span class="c1"># Perform a minimal check to determine if the orbnum file has</span>
        <span class="c1"># the appropriate header. Include the old ORBNUM utility header format</span>
        <span class="c1"># for Descending and Ascending node events (Odyssey).</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;Event&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;Node&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">error_message</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The header of the orbnum file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is not as expected.&quot;</span><span class="p">,</span>
                <span class="n">setup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;===&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">error_message</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The header of the orbnum file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is not as expected.&quot;</span><span class="p">,</span>
                <span class="n">setup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Set the fixed record length from the header.</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">record_fixed_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">header</span></div>

<div class="viewcode-block" id="OrbnumFileProduct.get_header_length"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.OrbnumFileProduct.get_header_length">[docs]</a>    <span class="k">def</span> <span class="nf">get_header_length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read an ORBNUM file and return the length of the header in bytes.</span>

<span class="sd">        :return: ORBNUM file header length</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">header_length</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">header_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_orbnum_type</span><span class="p">[</span><span class="s2">&quot;header_start_line&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">o</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">lines</span> <span class="o">&lt;</span> <span class="n">header_start</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">header_length</span> <span class="o">+=</span> <span class="n">utf8len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>

        <span class="k">return</span> <span class="n">header_length</span> <span class="o">+</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="OrbnumFileProduct.get_sample_record"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.OrbnumFileProduct.get_sample_record">[docs]</a>    <span class="k">def</span> <span class="nf">get_sample_record</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read an orbnum file and return one record sample.</span>

<span class="sd">        This sample (one data line) will be used to determine the format of</span>
<span class="sd">        each parameter of the orbnum file. The sample is re-processed in such a</span>
<span class="sd">        way that it contains no spaces for the UTC dates.</span>

<span class="sd">        :return: sample record line</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sample_record</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">header_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_orbnum_type</span><span class="p">[</span><span class="s2">&quot;header_start_line&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">o</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">lines</span> <span class="o">&gt;</span> <span class="n">header_start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1">#</span>
                    <span class="c1"># The original condition was: ``if line.strip():``</span>
                    <span class="c1"># But some orbnum files have records that only have the</span>
                    <span class="c1"># orbit number and nothing else. E.g.:</span>
                    <span class="c1">#</span>
                    <span class="c1"># header[0]        No.     Event UTC PERI</span>
                    <span class="c1"># header[1]      =====  ====================</span>
                    <span class="c1"># skip               2</span>
                    <span class="c1"># sample_record      3  1976 JUN 22 18:07:09</span>
                    <span class="c1">#</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="n">sample_record</span> <span class="o">=</span> <span class="n">line</span>
                        <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sample_record</span><span class="p">:</span>
            <span class="n">error_message</span><span class="p">(</span><span class="s2">&quot;The orbnum file has no records.&quot;</span><span class="p">,</span> <span class="n">setup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">)</span>

        <span class="n">sample_record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">utc_blanks_to_dashes</span><span class="p">(</span><span class="n">sample_record</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sample_record</span></div>

<div class="viewcode-block" id="OrbnumFileProduct.utc_blanks_to_dashes"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.OrbnumFileProduct.utc_blanks_to_dashes">[docs]</a>    <span class="k">def</span> <span class="nf">utc_blanks_to_dashes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_record</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reformat UTC strings in the ORBNUM file.</span>

<span class="sd">        Re-process the UTC string fields of an ORBNUM sample row</span>
<span class="sd">        to remove blank spaces.</span>

<span class="sd">        :param sample_record: sample row with UTC string with blank spaces</span>
<span class="sd">        :type sample_record: str</span>
<span class="sd">        :return: sample row with UTC string with dashes</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">utc_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;[0-9]</span><span class="si">{4}</span><span class="s2">[ ][A-Z]</span><span class="si">{3}</span><span class="s2">[ ][0-9]</span><span class="si">{2}</span><span class="s2">[ ][0-9]</span><span class="si">{2}</span><span class="s2">[:][0-9]</span><span class="si">{2}</span><span class="s2">[:][0-9]</span><span class="si">{2}</span><span class="s2">&quot;</span>

        <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">utc_pattern</span><span class="p">,</span> <span class="n">sample_record</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># Turn the string to a list to modify it.</span>
            <span class="c1">#</span>
            <span class="n">sample_record</span> <span class="o">=</span> <span class="n">sample_record</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="k">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">sample_record</span></div>

<div class="viewcode-block" id="OrbnumFileProduct.read_records"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.OrbnumFileProduct.read_records">[docs]</a>    <span class="k">def</span> <span class="nf">read_records</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read and interpret the records of an ORBNUM file.</span>

<span class="sd">        Read an orbnum file and set the number of records attribute,</span>
<span class="sd">        the length of the records attribute, determine which lines have blank</span>
<span class="sd">        records and, perform simple checks of the records.</span>

<span class="sd">        :return: number of records of ORBNUM file</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">blank_records</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o</span><span class="p">:</span>
            <span class="n">previous_orbit_number</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">records</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">header_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_orbnum_type</span><span class="p">[</span><span class="s2">&quot;header_start_line&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">o</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">lines</span> <span class="o">&gt;</span> <span class="n">header_start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">orbit_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">records_length</span> <span class="o">=</span> <span class="n">utf8len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                    <span class="c1">#</span>
                    <span class="c1"># Checks are performed from the first record.</span>
                    <span class="c1">#</span>
                    <span class="k">if</span> <span class="n">lines</span> <span class="o">&gt;</span> <span class="n">header_start</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">previous_orbit_number</span> <span class="ow">and</span> <span class="p">(</span>
                            <span class="n">orbit_number</span> <span class="o">-</span> <span class="n">previous_orbit_number</span> <span class="o">!=</span> <span class="mi">1</span>
                        <span class="p">):</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;-- Orbit number &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">previous_orbit_number</span><span class="si">}</span><span class="s2"> record &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;is followed by </span><span class="si">{</span><span class="n">orbit_number</span><span class="si">}</span><span class="s2">.&quot;</span>
                            <span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                            <span class="n">error_message</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Orbnum record number </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2"> is blank.&quot;</span><span class="p">,</span>
                                <span class="n">setup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="k">elif</span> <span class="p">(</span>
                            <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="n">records_length</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_fixed_length</span>
                        <span class="p">):</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;-- Orbit number </span><span class="si">{</span><span class="n">orbit_number</span><span class="si">}</span><span class="s2"> &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;record has an incorrect length,&quot;</span>
                                <span class="sa">f</span><span class="s2">&quot; the record will be expanded &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;to cover the adequate fixed &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;length.&quot;</span>
                            <span class="p">)</span>

                            <span class="n">blank_records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">orbit_number</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                        <span class="n">records</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="n">previous_orbit_number</span> <span class="o">=</span> <span class="n">orbit_number</span>

        <span class="c1">#</span>
        <span class="c1"># If there are blank records, we need to add blank spaces and</span>
        <span class="c1"># generate a new version of the orbnum file.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">blank_records</span><span class="p">:</span>

            <span class="c1">#</span>
            <span class="c1"># Generate the name for the new orbnum file. This is the only</span>
            <span class="c1"># place where the version of the previous orbnum file is used.</span>
            <span class="c1">#</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;_[vV][0-9]*[\.]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">matches</span><span class="p">:</span>

                <span class="c1">#</span>
                <span class="c1"># If the name does not have an explicit version, the version</span>
                <span class="c1"># is set to 2.</span>
                <span class="c1">#</span>
                <span class="n">original_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_v2.&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">name</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;-- ORBNUM file name updated with explicit &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;version number to: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">version</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">,</span> <span class="n">matches</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                <span class="n">version_number</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>

                <span class="n">new_version_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">version_number</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">leading_zeros</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">version_number</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">new_version_number</span><span class="p">))</span>
                <span class="n">new_version_number</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_version_number</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">leading_zeros</span><span class="p">)</span>

                <span class="n">new_version</span> <span class="o">=</span> <span class="n">matches</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="n">version_number</span><span class="p">,</span> <span class="n">new_version_number</span>
                <span class="p">)</span>

                <span class="n">original_name</span> <span class="o">=</span> <span class="n">matches</span><span class="o">.</span><span class="n">string</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">matches</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">new_version</span><span class="p">)</span>
                <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">matches</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">new_version</span><span class="p">)</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Orbnum name updated to: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1">#</span>
            <span class="c1"># The updated name needs to be propagated to the kernel</span>
            <span class="c1"># list.</span>
            <span class="c1">#</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernels_collection</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">kernel_list</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="n">original_name</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">kernels_collection</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">kernel_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

            <span class="c1">#</span>
            <span class="c1"># Following the name, write the new file and remove the</span>
            <span class="c1"># provided orbnum file.</span>
            <span class="c1">#</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">n</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">o</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">header_start</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">orbit_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">orbit_number</span><span class="p">)</span> <span class="ow">in</span> <span class="n">blank_records</span><span class="p">:</span>
                                <span class="c1">#</span>
                                <span class="c1"># Careful, Python will change the EOL to</span>
                                <span class="c1"># Line Feed when reading the file.</span>
                                <span class="c1">#</span>
                                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">n</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                    <span class="n">line</span>
                                    <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">record_fixed_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">eol</span>
                                <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">n</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">eol</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">n</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">eol</span><span class="p">)</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">blank_records</span> <span class="o">=</span> <span class="n">blank_records</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">records</span> <span class="o">=</span> <span class="n">records</span>

        <span class="k">return</span> <span class="n">records</span></div>

<div class="viewcode-block" id="OrbnumFileProduct.set_event_detection_key"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.OrbnumFileProduct.set_event_detection_key">[docs]</a>    <span class="k">def</span> <span class="nf">set_event_detection_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Obtain the ORBNUM event detection key.</span>

<span class="sd">        The event detection key is a string identifying which geometric event</span>
<span class="sd">        signifies the start of an orbit. The possible events are:</span>

<span class="sd">           ``APO``    signals a search for apoapsis</span>

<span class="sd">           ``PERI``   signals a search for periapsis</span>

<span class="sd">           ``A-NODE`` signals a search for passage through</span>
<span class="sd">           the ascending node</span>

<span class="sd">           ``D-NODE`` signals a search for passage through</span>
<span class="sd">           the descending node</span>

<span class="sd">           ``MINLAT`` signals a search for the time of</span>
<span class="sd">           minimum planetocentric latitude</span>

<span class="sd">           ``MAXLAT`` signals a search for the time of</span>
<span class="sd">           maximum planetocentric latitude</span>

<span class="sd">           ``MINZ``   signals a search for the time of the</span>
<span class="sd">           minimum value of the Z (Cartesian) coordinate</span>

<span class="sd">           ``MAXZ``   signals a search for the time of the</span>
<span class="sd">           maximum value of the Z (Cartesian) coordinate</span>

<span class="sd">        :param header: ORBNUM file header line</span>
<span class="sd">        :type header: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">events</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;APO&quot;</span><span class="p">,</span> <span class="s2">&quot;PERI&quot;</span><span class="p">,</span> <span class="s2">&quot;A-NODE&quot;</span><span class="p">,</span> <span class="s2">&quot;D-NODE&quot;</span><span class="p">,</span> <span class="s2">&quot;MINLAT&quot;</span><span class="p">,</span> <span class="s2">&quot;MAXLAT&quot;</span><span class="p">,</span> <span class="s2">&quot;MINZ&quot;</span><span class="p">,</span> <span class="s2">&quot;MAXZ&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_event_detection_key</span> <span class="o">=</span> <span class="n">event</span>
                <span class="k">break</span>

        <span class="c1">#</span>
        <span class="c1"># For orbnum files generated with older versions of the ORBNUM</span>
        <span class="c1"># utility, the event columns have a different format. For example,</span>
        <span class="c1"># for Mars Odyssey (m01_ext64.nrb):</span>
        <span class="c1">#</span>
        <span class="c1">#  No.      Desc-Node UTC         Node SCLK          Asc-Node UTC  ...</span>
        <span class="c1"># ===== ====================  ================  ====================</span>
        <span class="c1"># 82266 2020 JUL 01 01:24:31  4/1278034592.076  2020 JUL 01 02:23:12</span>
        <span class="c1"># 82267 2020 JUL 01 03:23:06  4/1278041706.241  2020 JUL 01 04:21:46</span>
        <span class="c1"># 82268 2020 JUL 01 05:21:38  4/1278048819.054  2020 JUL 01 06:20:18</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_event_detection_key&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;Desc-Node&quot;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;Asc-Node&quot;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">desc_node_index</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;Desc-Node&quot;</span><span class="p">)</span>
                <span class="n">asc_node_index</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;Asc-Node&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">asc_node_index</span> <span class="o">&lt;</span> <span class="n">desc_node_index</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_event_detection_key</span> <span class="o">=</span> <span class="s2">&quot;A-NODE&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_event_detection_key</span> <span class="o">=</span> <span class="s2">&quot;D-NODE&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_event_detection_key&quot;</span><span class="p">):</span>
            <span class="n">error_message</span><span class="p">(</span><span class="s2">&quot;orbnum event detection key is incorrect.&quot;</span><span class="p">,</span> <span class="n">setup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">)</span></div>

<div class="viewcode-block" id="OrbnumFileProduct.event_mapping"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.OrbnumFileProduct.event_mapping">[docs]</a>    <span class="k">def</span> <span class="nf">event_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps the event keyword to the event name/description.</span>

<span class="sd">        :param event: ORBNUM event key</span>
<span class="sd">        :type event: str</span>
<span class="sd">        :return: ORBNUM event description</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;APO&quot;</span><span class="p">:</span> <span class="s2">&quot;apocenter&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PERI&quot;</span><span class="p">:</span> <span class="s2">&quot;pericenter&quot;</span><span class="p">,</span>
            <span class="s2">&quot;A-NODE&quot;</span><span class="p">:</span> <span class="s2">&quot;passage through the ascending node&quot;</span><span class="p">,</span>
            <span class="s2">&quot;D-NODE&quot;</span><span class="p">:</span> <span class="s2">&quot;passage through the descending node&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MINLAT&quot;</span><span class="p">:</span> <span class="s2">&quot;minimum planetocentric latitude&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MAXLAT&quot;</span><span class="p">:</span> <span class="s2">&quot;maximum planetocentric latitude&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MINZ&quot;</span><span class="p">:</span> <span class="s2">&quot;minimum value of the cartesian Z coordinate&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MAXZ&quot;</span><span class="p">:</span> <span class="s2">&quot;maximum value of the cartesian Z coordinate&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">event_dict</span><span class="p">[</span><span class="n">event</span><span class="p">]</span></div>

<div class="viewcode-block" id="OrbnumFileProduct.opposite_event_mapping"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.OrbnumFileProduct.opposite_event_mapping">[docs]</a>    <span class="k">def</span> <span class="nf">opposite_event_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps the event keyword to the opposite event keyword.</span>

<span class="sd">        :param event: ORBNUM event key</span>
<span class="sd">        :type event: str</span>
<span class="sd">        :return: ORBNUM opposite event keyword</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">opp_event_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;APO&quot;</span><span class="p">:</span> <span class="s2">&quot;PERI&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PERI&quot;</span><span class="p">:</span> <span class="s2">&quot;APO&quot;</span><span class="p">,</span>
            <span class="s2">&quot;A-NODE&quot;</span><span class="p">:</span> <span class="s2">&quot;D-NODE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;D-NODE&quot;</span><span class="p">:</span> <span class="s2">&quot;A-NODE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MINLAT&quot;</span><span class="p">:</span> <span class="s2">&quot;MAXLAT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MAXLAT&quot;</span><span class="p">:</span> <span class="s2">&quot;MINLAT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MINZ&quot;</span><span class="p">:</span> <span class="s2">&quot;MAXZ&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MAXZ&quot;</span><span class="p">:</span> <span class="s2">&quot;MINZ&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">opp_event_dict</span><span class="p">[</span><span class="n">event</span><span class="p">]</span></div>

<div class="viewcode-block" id="OrbnumFileProduct.get_params"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.OrbnumFileProduct.get_params">[docs]</a>    <span class="k">def</span> <span class="nf">get_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Obtain the parameters present in the ORBNUM file.</span>

<span class="sd">        Currently, there are 11 orbital parameters available:</span>

<span class="sd">           ``No.``          The orbit number of a descending node event.</span>

<span class="sd">           ``Event UTC``    The UTC time of that event.</span>

<span class="sd">           ``Event SCLK``    The SCLK time of the event.</span>

<span class="sd">           ``OP-Event UTC`` The UTC time of the opposite event.</span>

<span class="sd">           ``Sub Sol Lon``  Sub-solar planetodetic longitude at event</span>
<span class="sd">           time (DEGS).</span>

<span class="sd">           ``Sub Sol Lat``  Sub-solar planetodetic latitude at event</span>
<span class="sd">           time (DEGS).</span>

<span class="sd">           ``Sub SC Lon``   Sub-target planetodetic longitude (DEGS).</span>

<span class="sd">           ``Sub SC Lat``   Sub-target planetodetic latitude (DEGS).</span>

<span class="sd">           ``Alt``          Altitude of the target above the observer</span>
<span class="sd">           body at event time (KM).</span>

<span class="sd">           ``Inc``          Inclination of the vehicle orbit plane at</span>
<span class="sd">           event time (DEGS).</span>

<span class="sd">           ``Ecc``          Eccentricity of the target orbit about</span>
<span class="sd">           the primary body at event time (DEGS),</span>

<span class="sd">           ``Lon Node``     Longitude of the ascending node of the</span>
<span class="sd">           orbit plane at event time (DEGS).</span>

<span class="sd">           ``Arg Per``      Argument of periapsis of the orbit plane at</span>
<span class="sd">           event time (DEGS).</span>

<span class="sd">           ``Sol Dist``     Solar distance from target at event</span>
<span class="sd">           time (KM).</span>

<span class="sd">           ``Semi Axis``   Semi-major axis of the target&#39;s orbit at</span>
<span class="sd">           event time (KM).</span>

<span class="sd">        :param header: ORBNUM file header line</span>
<span class="sd">        :type header: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;No.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Event UTC&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Desc-Node UTC&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Event SCLK&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Node SCLK&quot;</span><span class="p">,</span>
            <span class="s2">&quot;OP-Event UTC&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Asc-Node UTC&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SolLon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SolLat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SC Lon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SC Lat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Alt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Ecc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;LonNode&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Arg Per&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Sol Dist&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Semi Axis&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="n">parameters</span></div>

<div class="viewcode-block" id="OrbnumFileProduct.set_params"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.OrbnumFileProduct.set_params">[docs]</a>    <span class="k">def</span> <span class="nf">set_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Define the parameters&#39; template dictionary.</span>

<span class="sd">        :param header: ORBNUM file header line</span>
<span class="sd">        :type header: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The orbit number, UTC date and angular parameters have fixed</span>
        <span class="c1"># lengths, which are provided in the parameters&#39; template.</span>
        <span class="c1"># The length of the rest of the parameters depends on each orbnum</span>
        <span class="c1"># file and are obtained from the ORBNUM file itself.</span>
        <span class="c1">#</span>
        <span class="c1"># For ORBNUM files using IM previous to v1.7.0.0 the ``field_format``</span>
        <span class="c1"># values are:</span>
        <span class="c1">#</span>
        <span class="c1">#    Parameter      IM &lt; 1.7.0.0  IM &gt;= 1.7.0.0</span>
        <span class="c1">#    =============  ============  =============</span>
        <span class="c1">#    No.            I5            %5d</span>
        <span class="c1">#    Event UTC      A20           %20s</span>
        <span class="c1">#    Desc-Node UTC  A20           %20s</span>
        <span class="c1">#    Event SCLK     A?            %?s</span>
        <span class="c1">#    Node SCLK      A?            %?s</span>
        <span class="c1">#    OP-Event UTC   A20           %20s</span>
        <span class="c1">#    Asc-Node UTC   A20           %20s</span>
        <span class="c1">#    All the rest   F?.?          %?.?f</span>
        <span class="c1">#</span>
        <span class="n">params_template</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;No.&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ASCII_Integer&quot;</span><span class="p">,</span>
                <span class="s2">&quot;length&quot;</span><span class="p">:</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Number that provides an incremental orbit &quot;</span>
                <span class="s2">&quot;count determined by the $EVENT event.&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;Event UTC&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ASCII_String&quot;</span><span class="p">,</span>
                <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="s2">&quot;8&quot;</span><span class="p">,</span>
                <span class="s2">&quot;length&quot;</span><span class="p">:</span> <span class="s2">&quot;20&quot;</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;UTC time of the $EVENT event that &quot;</span>
                <span class="s2">&quot;signifies the start of an orbit.&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;Desc-Node UTC&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ASCII_String&quot;</span><span class="p">,</span>
                <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="s2">&quot;8&quot;</span><span class="p">,</span>
                <span class="s2">&quot;length&quot;</span><span class="p">:</span> <span class="s2">&quot;20&quot;</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;UTC time of the $EVENT event that &quot;</span>
                <span class="s2">&quot;signifies the start of an orbit.&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;Event SCLK&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ASCII_String&quot;</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;SCLK time of the $EVENT event that &quot;</span>
                <span class="s2">&quot;signifies the start of an orbit.&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;Node SCLK&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ASCII_String&quot;</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;SCLK time of the $EVENT event that &quot;</span>
                <span class="s2">&quot;signifies the start of an orbit.&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;OP-Event UTC&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ASCII_String&quot;</span><span class="p">,</span>
                <span class="s2">&quot;length&quot;</span><span class="p">:</span> <span class="s2">&quot;20&quot;</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;UTC time of opposite event ($OPPEVENT).&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;Asc-Node UTC&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ASCII_String&quot;</span><span class="p">,</span>
                <span class="s2">&quot;length&quot;</span><span class="p">:</span> <span class="s2">&quot;20&quot;</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;UTC time of opposite event ($OPPEVENT).&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;SolLon&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ASCII_Real&quot;</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Sub-solar planetodetic longitude at the &quot;</span>
                <span class="s2">&quot;$EVENT event time in the $FRAME.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="s2">&quot;deg&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;SolLat&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ASCII_Real&quot;</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Sub-solar planetodetic latitude at the &quot;</span>
                <span class="s2">&quot;$EVENT event time in the $FRAME.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="s2">&quot;deg&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;SC Lon&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ASCII_Real&quot;</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Sub-target planetodetic longitude at the &quot;</span>
                <span class="s2">&quot;$EVENT event time in the $FRAME.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="s2">&quot;deg&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;SC Lat&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ASCII_Real&quot;</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Sub-target planetodetic latitude at at the &quot;</span>
                <span class="s2">&quot;$EVENT event time in the $FRAME.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="s2">&quot;deg&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;Alt&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ASCII_Real&quot;</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Altitude of the target above the observer &quot;</span>
                <span class="s2">&quot;body at the $EVENT event time relative to&quot;</span>
                <span class="s2">&quot; the $TARGET ellipsoid.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="s2">&quot;km&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;Inc&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ASCII_Real&quot;</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Inclination of the vehicle orbit plane at &quot;</span>
                <span class="s2">&quot;event time.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="s2">&quot;km&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;Ecc&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ASCII_Real&quot;</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Eccentricity of the target orbit about &quot;</span>
                <span class="s2">&quot;the primary body at the $EVENT event time.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="s2">&quot;deg&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;LonNode&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ASCII_Real&quot;</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Longitude of the ascending node of the&quot;</span>
                <span class="s2">&quot; orbit plane at the $EVENT event time.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="s2">&quot;deg&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;Arg Per&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ASCII_Real&quot;</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Argument of periapsis of the orbit plane at &quot;</span>
                <span class="s2">&quot;the $EVENT event time.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="s2">&quot;deg&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;Sol Dist&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ASCII_Real&quot;</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Solar distance from target at the $EVENT &quot;</span>
                <span class="s2">&quot;event time.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="s2">&quot;km&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;Semi Axis&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ASCII_Real&quot;</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Semi-major axis of the target&#39;s orbit at&quot;</span>
                <span class="s2">&quot; the $EVENT event time.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="s2">&quot;km&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>

        <span class="c1">#</span>
        <span class="c1"># Define the complete list of parameters.</span>
        <span class="c1">#</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span>

        <span class="n">sample_record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_record</span>

        <span class="c1">#</span>
        <span class="c1"># Iterate the parameters and generate a dictionary for each based on</span>
        <span class="c1"># the parameters&#39; template dictionary.</span>
        <span class="c1">#</span>
        <span class="c1"># The parameters are first initialised. The orbnum header with two</span>
        <span class="c1"># re-processed records will look as follows:</span>
        <span class="c1">#</span>
        <span class="c1"># header[1]     No.     Event UTC PERI       Event SCLK PERI      ...</span>
        <span class="c1"># header[2]    =====  ====================  ====================  ...</span>
        <span class="c1"># param_record  1954  2015-OCT-01T01:33:57    2/0496935200.34677  ...</span>
        <span class="c1">#               1955  2015-OCT-01T06:06:54    2/0496951577.40847  ...</span>
        <span class="c1">#</span>
        <span class="c1"># The length of each parameter is based on the second header line.</span>
        <span class="c1"># Please note that what will be used is the maximum potential length</span>
        <span class="c1"># of each parameter.</span>
        <span class="c1">#</span>
        <span class="n">number</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">location</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">params_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">blankspace_iter</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[ ]&quot;</span><span class="p">,</span> <span class="n">header</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>

            <span class="n">name</span> <span class="o">=</span> <span class="n">param</span>
            <span class="c1">#</span>
            <span class="c1"># Parameter location; offset with respect to the line start.</span>
            <span class="c1"># Use the length from the previous iteration and add the</span>
            <span class="c1"># blank spaces in between parameter columns.</span>
            <span class="c1">#</span>
            <span class="c1"># To find blank spaces we use a regular expression iterator.</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="n">number</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">blankspaces_loc</span> <span class="o">=</span> <span class="n">blankspace_iter</span><span class="o">.</span><span class="fm">__next__</span><span class="p">()</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">blankspaces</span> <span class="o">=</span> <span class="n">blankspaces_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">blankspaces_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">location</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="o">+</span> <span class="n">blankspaces</span>

            <span class="nb">type</span> <span class="o">=</span> <span class="n">params_template</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s2">&quot;length&quot;</span> <span class="ow">in</span> <span class="n">params_template</span><span class="p">[</span><span class="n">param</span><span class="p">]:</span>
                <span class="n">length</span> <span class="o">=</span> <span class="n">params_template</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;length&quot;</span><span class="p">]</span>
                <span class="n">param_length</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#</span>
                <span class="c1"># Obtain the parameter length as the length of the table</span>
                <span class="c1"># separator from the header.</span>
                <span class="c1">#</span>
                <span class="n">length</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="n">number</span><span class="p">]))</span>
                <span class="c1">#</span>
                <span class="c1"># If the parameter is a float we need to include the decimal</span>
                <span class="c1"># part.</span>
                <span class="c1">#</span>
                <span class="k">if</span> <span class="s2">&quot;ASCII_Real&quot;</span> <span class="ow">in</span> <span class="n">params_template</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]:</span>
                    <span class="c1">#</span>
                    <span class="c1"># We need to sort the number of decimals.</span>
                    <span class="c1">#</span>
                    <span class="n">param_record</span> <span class="o">=</span> <span class="n">sample_record</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="n">number</span><span class="p">]</span>
                    <span class="n">param_length</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_record</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">param_length</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1">#</span>
            <span class="c1"># Write the format</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">information_model_float</span> <span class="o">&gt;=</span> <span class="mf">1007000000.0</span><span class="p">:</span>
                <span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;%&quot;</span> <span class="o">+</span> <span class="n">length</span>
                <span class="k">if</span> <span class="s2">&quot;ASCII_Real&quot;</span> <span class="ow">in</span> <span class="n">params_template</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]:</span>
                    <span class="nb">format</span> <span class="o">+=</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">param_length</span> <span class="o">+</span> <span class="s2">&quot;f&quot;</span>
                <span class="k">elif</span> <span class="s2">&quot;ASCII_String&quot;</span> <span class="ow">in</span> <span class="n">params_template</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]:</span>
                    <span class="nb">format</span> <span class="o">+=</span> <span class="s2">&quot;s&quot;</span>
                <span class="k">elif</span> <span class="s2">&quot;ASCII_Integer&quot;</span> <span class="ow">in</span> <span class="n">params_template</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]:</span>
                    <span class="nb">format</span> <span class="o">+=</span> <span class="s2">&quot;d&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">error_message</span><span class="p">(</span><span class="s2">&quot;Parameter type for ORBNUM file is incorrect.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;ASCII_Real&quot;</span> <span class="ow">in</span> <span class="n">params_template</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]:</span>
                    <span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;F&quot;</span> <span class="o">+</span> <span class="n">length</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">param_length</span>
                <span class="k">elif</span> <span class="s2">&quot;ASCII_String&quot;</span> <span class="ow">in</span> <span class="n">params_template</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]:</span>
                    <span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;A&quot;</span> <span class="o">+</span> <span class="n">length</span>
                <span class="k">elif</span> <span class="s2">&quot;ASCII_Integer&quot;</span> <span class="ow">in</span> <span class="n">params_template</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]:</span>
                    <span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;I&quot;</span> <span class="o">+</span> <span class="n">length</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">error_message</span><span class="p">(</span><span class="s2">&quot;Parameter type for ORBNUM file is incorrect.&quot;</span><span class="p">)</span>

            <span class="c1">#</span>
            <span class="c1"># Parameter number (column number)</span>
            <span class="c1">#</span>
            <span class="n">number</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1">#</span>
            <span class="c1"># Description. It can contain $EVENT, $TARGET and/or $FRAME. If</span>
            <span class="c1"># so is substituted by the appropriate value.</span>
            <span class="c1">#</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">params_template</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;description&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s2">&quot;$EVENT&quot;</span> <span class="ow">in</span> <span class="n">description</span><span class="p">:</span>
                <span class="n">event_desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_mapping</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_event_detection_key</span><span class="p">)</span>
                <span class="n">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;$EVENT&quot;</span><span class="p">,</span> <span class="n">event_desc</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;$TARGET&quot;</span> <span class="ow">in</span> <span class="n">description</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
                <span class="n">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;$TARGET&quot;</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;$FRAME&quot;</span> <span class="ow">in</span> <span class="n">description</span><span class="p">:</span>
                <span class="n">frame_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orbnum_type</span><span class="p">[</span><span class="s2">&quot;event_detection_frame&quot;</span><span class="p">]</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">frame_dict</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">frame_dict</span><span class="p">[</span><span class="s1">&#39;spice_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="n">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;$FRAME&quot;</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;$OPPEVENT&quot;</span> <span class="ow">in</span> <span class="n">description</span><span class="p">:</span>
                <span class="c1">#</span>
                <span class="c1"># For the opposite event correct the field description as</span>
                <span class="c1"># well.</span>
                <span class="c1">#</span>
                <span class="n">oppevent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opposite_event_mapping</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_event_detection_key</span><span class="p">)</span>
                <span class="n">oppevent_desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_mapping</span><span class="p">(</span><span class="n">oppevent</span><span class="p">)</span>
                <span class="n">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;$OPPEVENT&quot;</span><span class="p">,</span> <span class="n">oppevent_desc</span><span class="p">)</span>

            <span class="c1">#</span>
            <span class="c1"># Add event type in names.</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;Event UTC&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;Event SCLK&quot;</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_detection_key</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;OP-Event UTC&quot;</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">oppevent</span>

            <span class="c1">#</span>
            <span class="c1"># If the parameter has a unit, get it from the template.</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="s2">&quot;unit&quot;</span> <span class="ow">in</span> <span class="n">params_template</span><span class="p">[</span><span class="n">param</span><span class="p">]:</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="n">params_template</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1">#</span>
            <span class="c1"># build the dictionary for the parameter and add it to the</span>
            <span class="c1"># parameter list</span>
            <span class="c1">#</span>
            <span class="n">params_dict</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="n">number</span><span class="p">,</span>
                <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="n">location</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span>
                <span class="s2">&quot;length&quot;</span><span class="p">:</span> <span class="n">length</span><span class="p">,</span>
                <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="nb">format</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
                <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="n">unit</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params_dict</span></div>

<div class="viewcode-block" id="OrbnumFileProduct.get_description"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.OrbnumFileProduct.get_description">[docs]</a>    <span class="k">def</span> <span class="nf">get_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write the ORBNUM table character description.</span>

<span class="sd">        Write the ORBNUM product description information based on the orbit</span>
<span class="sd">        determination event and the PCK kernel used.</span>

<span class="sd">        :return: ORBNUM file description for label.</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event_mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;PERI&quot;</span><span class="p">:</span> <span class="s2">&quot;periapsis&quot;</span><span class="p">,</span>
            <span class="s2">&quot;APO&quot;</span><span class="p">:</span> <span class="s2">&quot;apoapsis&quot;</span><span class="p">,</span>
            <span class="s2">&quot;A-NODE&quot;</span><span class="p">:</span> <span class="s2">&quot;ascending node&quot;</span><span class="p">,</span>
            <span class="s2">&quot;D-NODE&quot;</span><span class="p">:</span> <span class="s2">&quot;descending node&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MINLAT&quot;</span><span class="p">:</span> <span class="s2">&quot;minimum planetocentric latitude&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MAXLAT&quot;</span><span class="p">:</span> <span class="s2">&quot;maximum planetocentric latitude&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MINZ&quot;</span><span class="p">:</span> <span class="s2">&quot;minimum value of Z (cartesian) coordinate&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MAXZ&quot;</span><span class="p">:</span> <span class="s2">&quot;maximum value of Z (cartesian) coordinate&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">event</span> <span class="o">=</span> <span class="n">event_mapping</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_event_detection_key</span><span class="p">]</span>

        <span class="n">pck_mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orbnum_type</span><span class="p">[</span><span class="s2">&quot;pck&quot;</span><span class="p">]</span>
        <span class="n">report</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pck_mapping</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">pck_mapping</span><span class="p">[</span><span class="s1">&#39;kernel_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>

        <span class="n">description</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;SPICE text orbit number file containing orbit &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;numbers and start times for orbits numbered by/&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;starting at </span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s2"> events, and sets of selected &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;geometric parameters at the orbit start times. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;SPICE text PCK file constants from the </span><span class="si">{</span><span class="n">report</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_previous_orbnum&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_previous_orbnum</span><span class="p">:</span>
                <span class="n">description</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot; This file supersedes the following orbit &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;number file: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_previous_orbnum</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>

        <span class="n">description</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; Created by </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_orbnum_type</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span>

        <span class="k">return</span> <span class="n">description</span></div>

<div class="viewcode-block" id="OrbnumFileProduct.table_character_description"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.OrbnumFileProduct.table_character_description">[docs]</a>    <span class="k">def</span> <span class="nf">table_character_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write the ORBNUM table character description.</span>

<span class="sd">        Write the orbnum table character description information</span>
<span class="sd">        determination event and the PCK kernel used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">blank_records</span><span class="p">:</span>
            <span class="n">number_of_records</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blank_records</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">number_of_records</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">plural</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plural</span> <span class="o">=</span> <span class="s2">&quot;s&quot;</span>

            <span class="n">description</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Since the SPK file(s) used to &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;generate this orbit number file did not provide &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;continuous coverage, the file contains &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">number_of_records</span><span class="si">}</span><span class="s2"> record</span><span class="si">{</span><span class="n">plural</span><span class="si">}</span><span class="s2"> that only provide the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;orbit number in the first field (No.) with all other &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;fields set to blank spaces.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">description</span></div>

<div class="viewcode-block" id="OrbnumFileProduct.coverage"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.OrbnumFileProduct.coverage">[docs]</a>    <span class="k">def</span> <span class="nf">coverage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine the coverage of the ORNBUM file.</span>

<span class="sd">        The coverage of the ORBNUM file can be determined in three different</span>
<span class="sd">        ways:</span>

<span class="sd">           *  If there is a one to one correspondence with an SPK</span>
<span class="sd">              file, the SPK file can be provided with the ``&lt;kernel&gt;``</span>
<span class="sd">              tag. The tag can be a path to a specific kernel that</span>
<span class="sd">              does not have to be part of the increment, a pattern</span>
<span class="sd">              of a kernel present in the increment or a pattern of</span>
<span class="sd">              a kernel present in the final directory of the archive.</span>

<span class="sd">           *  If there is a quasi one to one correspondence with an</span>
<span class="sd">              SPK file with a given cutoff time prior to the end</span>
<span class="sd">              of the SPK file, the SPK file can be provided with the</span>
<span class="sd">              ``&lt;kernel&gt;`` tag. The tag can be a path to a specific kernel</span>
<span class="sd">              that does not have to be part of the increment, a pattern</span>
<span class="sd">              of a kernel present in the increment or a pattern of</span>
<span class="sd">              a kernel present in the final directory of the archive.</span>
<span class="sd">              Currently, the only cutoff pattern available is the</span>
<span class="sd">              boundary of the previous day of the SPK coverage stop</span>
<span class="sd">              time.</span>

<span class="sd">           *  A user can provide a look-up table with this file, as follows::</span>

<span class="sd">                &lt;lookup_table&gt;</span>
<span class="sd">                   &lt;file name=&quot;maven_orb_rec_210101_210401_v1.orb&quot;&gt;</span>
<span class="sd">                      &lt;start&gt;2021-01-01T00:00:00.000Z&lt;/start&gt;</span>
<span class="sd">                      &lt;finish&gt;2021-04-01T01:00:00.000Z&lt;/finish&gt;</span>
<span class="sd">                   &lt;/file&gt;</span>
<span class="sd">                &lt;/lookup_table&gt;</span>

<span class="sd">              Note that in this particular case the first three and</span>
<span class="sd">              last three lines of the orbnum files would have provided::</span>

<span class="sd">                   Event UTC PERI</span>
<span class="sd">                   ====================</span>
<span class="sd">                   2021 JAN 01 00:14:15</span>
<span class="sd">                   2021 JAN 01 03:50:43</span>
<span class="sd">                   2021 JAN 01 07:27:09</span>
<span class="sd">                   (...)</span>
<span class="sd">                   2021 MAR 31 15:00:05</span>
<span class="sd">                   2021 MAR 31 18:36:29</span>
<span class="sd">                   2021 MAR 31 22:12:54</span>

<span class="sd">           *  If nothing is provided NPB will provide the coverage based on</span>
<span class="sd">              the event time of the first orbit and the opposite event time</span>
<span class="sd">              of the last orbit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;coverage&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orbnum_type</span><span class="p">:</span>
            <span class="n">coverage_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orbnum_type</span><span class="p">[</span><span class="s2">&quot;coverage&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coverage_source</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">coverage_found</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="s2">&quot;kernel&quot;</span> <span class="ow">in</span> <span class="n">coverage_source</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">coverage_source</span><span class="p">[</span><span class="s2">&quot;kernel&quot;</span><span class="p">]:</span>
                <span class="n">coverage_kernel</span> <span class="o">=</span> <span class="n">coverage_source</span><span class="p">[</span><span class="s2">&quot;kernel&quot;</span><span class="p">][</span><span class="s2">&quot;#text&quot;</span><span class="p">]</span>
                <span class="c1">#</span>
                <span class="c1"># Search the kernel that provides coverage, Note that</span>
                <span class="c1"># this kernel is either</span>
                <span class="c1">#</span>
                <span class="c1">#   -- present in the increment</span>
                <span class="c1">#   -- in the previous increment</span>
                <span class="c1">#   -- provided by the user</span>
                <span class="c1">#</span>
                <span class="c1"># The kernel can be a pattern defining multiple kernels or</span>
                <span class="c1"># a name. If the kernel provided contains a pattern it will be</span>
                <span class="c1"># useful to determine the coverage of multiple orbnum files</span>
                <span class="c1"># provided in the plan.</span>
                <span class="c1">#</span>
                <span class="n">cov_patn</span> <span class="o">=</span> <span class="n">coverage_kernel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                <span class="c1">#</span>
                <span class="c1"># Start checking the path provided in the configuration file.</span>
                <span class="c1">#</span>
                <span class="n">cov_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">coverage_kernel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cov_kers</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">cov_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="n">cov_patn</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                    <span class="p">]</span>

                <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                    <span class="n">cov_kers</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1">#</span>
                <span class="c1"># Check if the SPK kernel is present in the increment.</span>
                <span class="c1">#</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">cov_kers</span><span class="p">:</span>
                    <span class="n">cov_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">staging_directory</span><span class="si">}</span><span class="s2">/spice_kernels/spk&quot;</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">cov_kers</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">cov_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="n">cov_patn</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                        <span class="p">]</span>
                    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                        <span class="n">cov_kers</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="c1">#</span>
                    <span class="c1"># Check if the SPK kernel is present in the bundle</span>
                    <span class="c1"># directory.</span>
                    <span class="c1">#</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">cov_kers</span><span class="p">:</span>
                        <span class="n">cov_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">bundle_directory</span><span class="si">}</span><span class="s2">/spice_kernels/spk&quot;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">cov_kers</span> <span class="o">=</span> <span class="p">[</span>
                                <span class="n">x</span>
                                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">cov_path</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="n">cov_patn</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                            <span class="p">]</span>
                        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                            <span class="n">cov_kers</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">if</span> <span class="n">cov_kers</span><span class="p">:</span>
                    <span class="n">coverage_found</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1">#</span>
                <span class="c1"># If there is only one coverage kernel this is the one that</span>
                <span class="c1"># will be used.</span>
                <span class="c1">#</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cov_kers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">coverage_found</span><span class="p">:</span>
                    <span class="n">coverage_kernel</span> <span class="o">=</span> <span class="n">cov_path</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">cov_kers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Coverage determined by </span><span class="si">{</span><span class="n">coverage_kernel</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="c1">#</span>
                <span class="c1"># If there are more, the only possibility is that the orbnum</span>
                <span class="c1"># filename and the SPK filename, both without extensions, match.</span>
                <span class="c1">#</span>
                <span class="k">elif</span> <span class="n">coverage_found</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">kernel</span> <span class="ow">in</span> <span class="n">cov_kers</span><span class="p">:</span>
                        <span class="n">kername</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">kername</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="n">coverage_kernel</span> <span class="o">=</span> <span class="n">cov_path</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">kernel</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;-- Coverage determined by </span><span class="si">{</span><span class="n">coverage_kernel</span><span class="si">}</span><span class="s2">.&quot;</span>
                            <span class="p">)</span>

                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">coverage_kernel</span><span class="p">):</span>
                    <span class="c1">#</span>
                    <span class="c1"># Kernel provided by the user and directly available.</span>
                    <span class="c1">#</span>
                    <span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">stop_time</span><span class="p">)</span> <span class="o">=</span> <span class="n">spk_coverage</span><span class="p">(</span>
                        <span class="n">coverage_kernel</span><span class="p">,</span>
                        <span class="n">main_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">spice_name</span><span class="p">,</span>
                        <span class="n">date_format</span><span class="o">=</span><span class="s2">&quot;maklabel&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="c1">#</span>
                    <span class="c1"># If the XML tag has a cutoff attribute, apply the cutoff.</span>
                    <span class="c1">#</span>
                    <span class="k">if</span> <span class="n">coverage_source</span><span class="p">[</span><span class="s2">&quot;kernel&quot;</span><span class="p">][</span><span class="s2">&quot;@cutoff&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span><span class="p">:</span>
                        <span class="n">stop_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                            <span class="n">stop_time</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span>
                        <span class="p">)</span>
                        <span class="n">stop_time</span> <span class="o">=</span> <span class="n">stop_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T00:00:00Z&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">coverage_source</span><span class="p">[</span><span class="s2">&quot;kernel&quot;</span><span class="p">][</span><span class="s2">&quot;@cutoff&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;False&quot;</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s2">&quot;-- cutoff value of &lt;kernel&gt;&quot;</span>
                            <span class="s2">&quot;configuration item is not set to &quot;</span>
                            <span class="s1">&#39;a parseable value: &quot;True&quot; or &quot;False&quot;.&#39;</span>
                        <span class="p">)</span>
                    <span class="n">coverage_found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">coverage_found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">coverage_found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="s2">&quot;lookup_table&quot;</span> <span class="ow">in</span> <span class="n">coverage_source</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">coverage_source</span><span class="p">[</span><span class="s2">&quot;lookup_table&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">coverage_found</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;-- Orbnum file lookup table cov. found &quot;</span>
                        <span class="s2">&quot;but cov. already provided by SPK file.&quot;</span>
                    <span class="p">)</span>

                <span class="n">table_files</span> <span class="o">=</span> <span class="n">coverage_source</span><span class="p">[</span><span class="s2">&quot;lookup_table&quot;</span><span class="p">][</span><span class="s2">&quot;file&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table_files</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">table_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">table_files</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">table_files</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;@name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                        <span class="n">start_time</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span>
                        <span class="n">stop_time</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;finish&quot;</span><span class="p">]</span>
                        <span class="n">coverage_found</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;-- Coverage determined by &quot;</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">file</span><span class="p">[</span><span class="s2">&quot;@name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> from lookup table.&#39;</span>
                        <span class="p">)</span>
                        <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">coverage_found</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">coverage_found</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># Set the start and stop times to the first and last</span>
            <span class="c1"># time-tags of the orbnum file.</span>
            <span class="c1">#</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_record</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="s2">&quot;%Y-%b-</span><span class="si">%d</span><span class="s2">-%H:%M:%S&quot;</span><span class="p">)</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>

            <span class="c1">#</span>
            <span class="c1"># Read the orbnum file in binary mode in order to start</span>
            <span class="c1"># from the end of the file.</span>
            <span class="c1">#</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_END</span><span class="p">)</span>
                <span class="k">while</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_CUR</span><span class="p">)</span>
                <span class="n">last_line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="c1">#</span>
                <span class="c1"># Replace the spaces in the UTC strings for dashes in order</span>
                <span class="c1"># to be able to split the file with blank spaces.</span>
                <span class="c1">#</span>
            <span class="n">last_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">utc_blanks_to_dashes</span><span class="p">(</span><span class="n">last_line</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># If the opposite event is outside of the coverage of the SPK file</span>
            <span class="c1"># with which the orbnum has been generated, there is no UTC time</span>
            <span class="c1"># or the opposite event, in such case we will use the UTC time</span>
            <span class="c1"># of the last event.</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="s2">&quot;Unable to determine&quot;</span> <span class="ow">in</span> <span class="n">last_line</span><span class="p">:</span>
                <span class="n">stop_time</span> <span class="o">=</span> <span class="n">last_line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stop_time</span> <span class="o">=</span> <span class="n">last_line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">stop_time</span><span class="p">,</span> <span class="s2">&quot;%Y-%b-</span><span class="si">%d</span><span class="s2">-%H:%M:%S&quot;</span><span class="p">)</span>
                <span class="n">stop_time</span> <span class="o">=</span> <span class="n">stop</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="c1">#</span>
                <span class="c1"># Exception to cope with orbnum files without all the ground</span>
                <span class="c1"># set of parameters.</span>
                <span class="c1">#</span>
                <span class="n">stop_time</span> <span class="o">=</span> <span class="n">last_line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">stop_time</span><span class="p">,</span> <span class="s2">&quot;%Y-%b-</span><span class="si">%d</span><span class="s2">-%H:%M:%S&quot;</span><span class="p">)</span>
                <span class="n">stop_time</span> <span class="o">=</span> <span class="n">stop</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;-- Coverage determined by ORBNUM file data.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">start_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_time</span> <span class="o">=</span> <span class="n">stop_time</span></div></div>


<div class="viewcode-block" id="InventoryProduct"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.InventoryProduct">[docs]</a><span class="k">class</span> <span class="nc">InventoryProduct</span><span class="p">(</span><span class="n">Product</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Product child Class that defines a Collection Inventory product.</span>

<span class="sd">    :param setup: NPB execution setup object</span>
<span class="sd">    :type setup: object</span>
<span class="sd">    :param collection: Collection that the inventory product belongs to</span>
<span class="sd">    :type collection: object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setup</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">collection</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Constructor.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">collection</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;miscellaneous&quot;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">setup</span><span class="o">.</span><span class="n">step</span><span class="si">}</span><span class="s2"> - Generation of </span><span class="si">{</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> collection&quot;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">setup</span><span class="o">.</span><span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">setup</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">silent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">setup</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-- &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; - &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">collection</span>

        <span class="k">if</span> <span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">setup</span><span class="o">.</span><span class="n">staging_directory</span><span class="si">}</span><span class="s2">/index/index.tab&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;index.tab&quot;</span>

        <span class="k">elif</span> <span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>

            <span class="c1">#</span>
            <span class="c1"># Determine the inventory version</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">increment</span><span class="p">:</span>
                <span class="n">inventory_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">bundle_directory</span>
                    <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_acronym</span><span class="si">}</span><span class="s2">_spice&quot;</span>
                    <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
                    <span class="o">+</span> <span class="n">collection</span><span class="o">.</span><span class="n">name</span>
                    <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
                    <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;collection_</span><span class="si">{</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_inventory_v*.csv&quot;</span>
                <span class="p">)</span>
                <span class="n">inventory_files</span> <span class="o">+=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">staging_directory</span>
                    <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
                    <span class="o">+</span> <span class="n">collection</span><span class="o">.</span><span class="n">name</span>
                    <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
                    <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;collection_</span><span class="si">{</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_inventory_v*.csv&quot;</span>
                <span class="p">)</span>
                <span class="n">inventory_files</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">latest_file</span> <span class="o">=</span> <span class="n">inventory_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                    <span class="c1">#</span>
                    <span class="c1"># We store the previous version to use it to validate the</span>
                    <span class="c1"># generated one.</span>
                    <span class="c1">#</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">path_current</span> <span class="o">=</span> <span class="n">latest_file</span>

                    <span class="n">latest_version</span> <span class="o">=</span> <span class="n">latest_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_v&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">latest_version</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Previous inventory file is: </span><span class="si">{</span><span class="n">latest_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Generate version </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">path_current</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;-- Previous inventory file not found.&quot;</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Default to version </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;-- The version of this file might be incorrect.&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">path_current</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Default to version </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;-- Make sure this is the first release of the archive.&quot;</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;collection_</span><span class="si">{</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_inventory_v</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="si">:</span><span class="s2">03</span><span class="si">}</span><span class="s2">.csv&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">setup</span><span class="o">.</span><span class="n">staging_directory</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">collection</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">set_product_lid</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_product_vid</span><span class="p">()</span>

        <span class="c1">#</span>
        <span class="c1"># Kernels are already generated products but Inventories are not.</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_product</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_product</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">Product</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">InventoryPDS4Label</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">InventoryPDS3Label</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

            <span class="c1">#</span>
            <span class="c1"># Generate dsindex files.</span>
            <span class="c1">#</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">staging_directory</span> <span class="o">+</span> <span class="s2">&quot;/../dsindex.tab&quot;</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tab&quot;</span><span class="p">,</span> <span class="s2">&quot;.lbl&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">staging_directory</span> <span class="o">+</span> <span class="s2">&quot;/../dsindex.lbl&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">replace_string_in_file</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">staging_directory</span> <span class="o">+</span> <span class="s2">&quot;/../dsindex.lbl&quot;</span><span class="p">,</span>
                <span class="s1">&#39;&quot;INDEX.TAB&quot;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;&quot;DSINDEX.TAB&quot;&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">,</span>
            <span class="p">)</span>

<div class="viewcode-block" id="InventoryProduct.set_product_lid"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.InventoryProduct.set_product_lid">[docs]</a>    <span class="k">def</span> <span class="nf">set_product_lid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the Product LID.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lid</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">logical_identifier</span><span class="si">}</span><span class="s2">:document:spiceds&quot;</span></div>

<div class="viewcode-block" id="InventoryProduct.set_product_vid"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.InventoryProduct.set_product_vid">[docs]</a>    <span class="k">def</span> <span class="nf">set_product_vid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the Product VID.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vid</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.0&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">))</span></div>

<div class="viewcode-block" id="InventoryProduct.write_product"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.InventoryProduct.write_product">[docs]</a>    <span class="k">def</span> <span class="nf">write_product</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write and validate the Collection inventory.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_pds4_collection_product</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_pds3_index_product</span><span class="p">()</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;-- Generated </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">staging_directory</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">silent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   * Created </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">staging_directory</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate_pds4</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate_pds3</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">diff</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compare</span><span class="p">()</span></div>

<div class="viewcode-block" id="InventoryProduct.write_pds4_collection_product"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.InventoryProduct.write_pds4_collection_product">[docs]</a>    <span class="k">def</span> <span class="nf">write_pds4_collection_product</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write the PDS4 Collection product.&quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1"># If there is an existing version we need to add the items from</span>
        <span class="c1"># the previous version as SECONDARY members</span>
        <span class="c1">#</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_current</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_current</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s2">&quot;P,urn&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="c1">#</span>
                            <span class="c1"># All primary items in previous version shall</span>
                            <span class="c1"># be included as secondary in the new one</span>
                            <span class="c1">#</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;P,urn&quot;</span><span class="p">,</span> <span class="s2">&quot;S,urn&quot;</span><span class="p">)</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">add_carriage_return</span><span class="p">(</span>
                            <span class="n">line</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">eol_pds4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span>
                        <span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">product</span><span class="p">:</span>
                <span class="c1">#</span>
                <span class="c1"># This conditional is added because miscellaneous inventories</span>
                <span class="c1"># are added to the collection before generating the inventory</span>
                <span class="c1"># product itself.</span>
                <span class="c1">#</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">product</span><span class="p">)</span> <span class="o">!=</span> <span class="n">InventoryProduct</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">product</span><span class="o">.</span><span class="n">new_product</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;P,</span><span class="si">{</span><span class="n">product</span><span class="o">.</span><span class="n">lid</span><span class="si">}</span><span class="s2">::</span><span class="si">{</span><span class="n">product</span><span class="o">.</span><span class="n">vid</span><span class="si">}</span><span class="se">\r\n</span><span class="s2">&quot;</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">add_carriage_return</span><span class="p">(</span>
                            <span class="n">line</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">eol_pds4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span>
                        <span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>

<div class="viewcode-block" id="InventoryProduct.write_pds3_index_product"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.InventoryProduct.write_pds3_index_product">[docs]</a>    <span class="k">def</span> <span class="nf">write_pds3_index_product</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This method uses the previous index file to generate the new one.</span>

<span class="sd">        There is a NAIF Perl script that will generate an index file from a</span>
<span class="sd">        kernel list file. Please contact the NAIF if you are interested in such</span>
<span class="sd">        script.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">column_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">increment</span><span class="p">:</span>
            <span class="n">existing_index</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">bundle_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">volume_id</span><span class="si">}</span><span class="s2">/index/index.tab&quot;</span>
            <span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">existing_index</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="n">index_row</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">index_row</span><span class="p">):</span>
                            <span class="k">if</span> <span class="s1">&#39;&quot;&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
                                <span class="n">index_row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">index_row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                            <span class="c1">#</span>
                            <span class="c1"># Remove EOL characters from last element of the</span>
                            <span class="c1"># column.</span>
                            <span class="c1">#</span>
                            <span class="k">if</span> <span class="s2">&quot;</span><span class="se">\n\r</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
                                <span class="n">col_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span>
                            <span class="k">elif</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
                                <span class="n">col_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">col_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">column_length</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">col_len</span><span class="p">:</span>
                                <span class="n">column_length</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">col_len</span>

                        <span class="n">current_index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_row</span><span class="p">)</span>

        <span class="n">new_index</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">kernel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">product</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s2">&quot;MetaKernelProduct&quot;</span><span class="p">:</span>
                <span class="n">index_row</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">kernel</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">kernel</span><span class="o">.</span><span class="n">stop_time</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s2">&quot;data/&quot;</span> <span class="o">+</span> <span class="n">kernel</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/data/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.lbl&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">DATA_SET_ID</span><span class="p">,</span>
                    <span class="n">kernel</span><span class="o">.</span><span class="n">creation_time</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">RELID</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">RELDATE</span><span class="p">,</span>
                    <span class="n">kernel</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
                    <span class="n">kernel</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">VOLID</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                <span class="p">]</span>

                <span class="n">new_index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_row</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Merge both lists</span>
        <span class="c1">#</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">current_index</span> <span class="o">+</span> <span class="n">new_index</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">column_bytes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">file_types</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">line_for_length</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">index</span><span class="p">:</span>
                <span class="n">rows</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="s2">&quot;N/A&quot;</span><span class="p">:</span>
                            <span class="n">col</span> <span class="o">=</span> <span class="s1">&#39;&quot;N/A&quot;&#39;</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}{</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">column_length</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">))</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}{</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">column_length</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
                        <span class="n">line_for_length</span> <span class="o">=</span> <span class="n">line</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">9</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;,&quot;</span>

                <span class="n">line</span> <span class="o">=</span> <span class="n">add_carriage_return</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">eol_pds3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">)</span>
                <span class="n">file_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">type_to_extension</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="c1">#</span>
            <span class="c1"># Bytes of each column is necessary to write the index label.</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line_for_length</span><span class="p">:</span>
                <span class="n">error_message</span><span class="p">(</span>
                    <span class="s2">&quot;The index file is incomplete since no binary &quot;</span>
                    <span class="s2">&quot;kernel is present in the archive.&quot;</span>
                <span class="p">)</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="n">column_start_bytes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">start_bytes</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>

                <span class="n">column_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>

                <span class="k">if</span> <span class="s2">&quot;</span><span class="se">\n\r</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">column</span><span class="p">:</span>
                    <span class="n">column_length</span> <span class="o">-=</span> <span class="mi">3</span>
                <span class="k">elif</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">column</span><span class="p">:</span>
                    <span class="n">column_length</span> <span class="o">-=</span> <span class="mi">2</span>
                <span class="k">if</span> <span class="s1">&#39;&quot;&#39;</span> <span class="ow">in</span> <span class="n">column</span><span class="p">:</span>
                    <span class="n">column_length</span> <span class="o">-=</span> <span class="mi">2</span>
                    <span class="n">start_bytes</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">column_start_bytes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">start_bytes</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;&quot;&#39;</span> <span class="ow">in</span> <span class="n">column</span><span class="p">:</span>
                    <span class="n">start_bytes</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">start_bytes</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">column</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="n">column_bytes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column_length</span><span class="p">)</span>

        <span class="n">file_types</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">file_types</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">file_types</span> <span class="o">=</span> <span class="n">file_types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_bytes</span> <span class="o">=</span> <span class="n">column_bytes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_start_bytes</span> <span class="o">=</span> <span class="n">column_start_bytes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">row_bytes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">=</span> <span class="n">rows</span></div>

<div class="viewcode-block" id="InventoryProduct.validate_pds4"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.InventoryProduct.validate_pds4">[docs]</a>    <span class="k">def</span> <span class="nf">validate_pds4</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate the PDS4 Inventory Product.</span>

<span class="sd">        The Inventory is validated by checking that all the products listed</span>
<span class="sd">        are present in the archive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Validating </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Check that all the products are listed in the collection product.</span>
        <span class="c1">#</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;      Check that all the products are in the collection.&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">product</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">product</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s2">&quot;InventoryProduct&quot;</span><span class="p">:</span>
                <span class="n">product_found</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">product</span><span class="o">.</span><span class="n">lid</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="n">product_found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">product_found</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;      Product </span><span class="si">{</span><span class="n">product</span><span class="o">.</span><span class="n">lid</span><span class="si">}</span><span class="s2"> not found. &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;Consider increment re-generation.&quot;</span>
                        <span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;      OK&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="InventoryProduct.validate_pds3"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.InventoryProduct.validate_pds3">[docs]</a>    <span class="k">def</span> <span class="nf">validate_pds3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate the PDS3 Index.</span>

<span class="sd">        The Inventory is validated by checking that all the products listed</span>
<span class="sd">        are present in the archive and comparing the index file with the</span>
<span class="sd">        previous one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Validating </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="InventoryProduct.compare"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.InventoryProduct.compare">[docs]</a>    <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;**Compare the Inventory Product with another Inventory**.</span>

<span class="sd">        The Inventory Product is compared with the previous</span>
<span class="sd">        version and if it does not exist with the sample INSIGHT inventory</span>
<span class="sd">        product.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mission_acronym</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_acronym</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;-- Comparing &quot;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mission_acronym</span><span class="si">}</span><span class="s2">_spice/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s2">&quot;...&quot;</span>
        <span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Use the prior version of the same product, if it does not</span>
        <span class="c1"># exist use the sample.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_current</span><span class="p">:</span>

            <span class="n">fromfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_current</span>
            <span class="n">tofile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span>
            <span class="nb">dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">working_directory</span>

            <span class="n">compare_files</span><span class="p">(</span><span class="n">fromfile</span><span class="p">,</span> <span class="n">tofile</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">diff</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;-- Comparing with InSight test inventory product.&quot;</span><span class="p">)</span>
            <span class="n">fromfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">data/insight_spice/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;collection_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_inventory_*.csv&quot;</span>
            <span class="p">)</span>
            <span class="n">fromfiles</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">fromfile</span> <span class="o">=</span> <span class="n">fromfiles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">tofile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span>
            <span class="nb">dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">working_directory</span>

            <span class="n">compare_files</span><span class="p">(</span><span class="n">fromfile</span><span class="p">,</span> <span class="n">tofile</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">diff</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SpicedsProduct"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.SpicedsProduct">[docs]</a><span class="k">class</span> <span class="nc">SpicedsProduct</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Product child class to process the SPICEDS file.</span>

<span class="sd">    :param setup: NPB execution setup object</span>
<span class="sd">    :type setup: object</span>
<span class="sd">    :param collection: Collection that the inventory product belongs to</span>
<span class="sd">    :type collection: object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setup</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">collection</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Constructor.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_product</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">spiceds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">spiceds</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="n">spiceds</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">step</span><span class="si">}</span><span class="s2"> - Processing spiceds file&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">silent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-- &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; - &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">spiceds</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-- No spiceds file provided.&quot;</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Obtain the previous spiceds file if it exists</span>
        <span class="c1">#</span>
        <span class="n">path</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">setup</span><span class="o">.</span><span class="n">bundle_directory</span>
            <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
            <span class="o">+</span> <span class="n">setup</span><span class="o">.</span><span class="n">mission_acronym</span>
            <span class="o">+</span> <span class="s2">&quot;_spice&quot;</span>
            <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
            <span class="o">+</span> <span class="n">collection</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">increment</span><span class="p">:</span>
            <span class="n">spiceds_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s2">&quot;spiceds_v*.html&quot;</span><span class="p">)</span>
            <span class="n">spiceds_files</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">latest_spiceds</span> <span class="o">=</span> <span class="n">spiceds_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">latest_version</span> <span class="o">=</span> <span class="n">latest_spiceds</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_v&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">latest_spiceds</span> <span class="o">=</span> <span class="n">latest_spiceds</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">latest_version</span> <span class="o">=</span> <span class="n">latest_version</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">latest_version</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">spiceds</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Previous spiceds found: </span><span class="si">{</span><span class="n">latest_spiceds</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">generated</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">return</span>

            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;-- No previous version of spiceds_v*.html file found.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">spiceds</span><span class="p">:</span>
                    <span class="n">error_message</span><span class="p">(</span>
                        <span class="s2">&quot;spiceds not provided and not available &quot;</span>
                        <span class="s2">&quot;from previous releases.&quot;</span><span class="p">,</span>
                        <span class="n">setup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">latest_spiceds</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">latest_spiceds</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">spiceds</span><span class="p">:</span>
                <span class="n">error_message</span><span class="p">(</span>
                    <span class="s2">&quot;spiceds not provided and not available from previous releases.&quot;</span><span class="p">,</span>
                    <span class="n">setup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Compare the previous SPICEDS file and the provided one. A user might</span>
        <span class="c1"># not remove a previously provided SPICEDS file from the configuration</span>
        <span class="c1"># file, if so, the user must be warned.</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;spiceds_v</span><span class="si">{0:0=3d}</span><span class="s2">.html&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">setup</span><span class="o">.</span><span class="n">staging_directory</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">collection</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mission</span> <span class="o">=</span> <span class="n">setup</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_product_lid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_product_vid</span><span class="p">()</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;-- spiceds file provided as input moved to staging &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;area as </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># The provided spiceds file is moved to the staging area.</span>
        <span class="c1">#</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">spiceds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># The appropriate line endings are provided to the spiceds file,</span>
        <span class="c1"># If line endings did not have Carriage Return (CR), they are</span>
        <span class="c1"># added and the file timestamp is updated. Note that if the file</span>
        <span class="c1"># already had CRs the original timestamp is preserved.</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_cr</span><span class="p">()</span>

        <span class="c1">#</span>
        <span class="c1"># Kernels are already generated products but Inventories are not.</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_product</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">Product</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Check if the spiceds has not changed.</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_product</span><span class="p">()</span>

        <span class="c1">#</span>
        <span class="c1"># Validate the product by comparing it and then generate the label.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generated</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">diff</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compare</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">DocumentPDS4Label</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="SpicedsProduct.set_product_lid"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.SpicedsProduct.set_product_lid">[docs]</a>    <span class="k">def</span> <span class="nf">set_product_lid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the Product LID.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lid</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">logical_identifier</span><span class="si">}</span><span class="s2">:document:spiceds&quot;</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></div>

<div class="viewcode-block" id="SpicedsProduct.set_product_vid"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.SpicedsProduct.set_product_vid">[docs]</a>    <span class="k">def</span> <span class="nf">set_product_vid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the Product VID.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vid</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.0&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">))</span></div>

<div class="viewcode-block" id="SpicedsProduct.check_cr"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.SpicedsProduct.check_cr">[docs]</a>    <span class="k">def</span> <span class="nf">check_cr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine whether if ``&lt;CR&gt;`` has to be added to the SPICEDS.&quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1"># We add the date to the temporary file to have a unique name.</span>
        <span class="c1">#</span>
        <span class="n">today</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
        <span class="n">time_string</span> <span class="o">=</span> <span class="n">today</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">temporary_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">time_string</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">temporary_file</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">add_carriage_return</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">eol_pds4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">)</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># If CRs have been added then we update the spiceds file.</span>
        <span class="c1"># The operator is notified.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">temporary_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temporary_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">temporary_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;-- Carriage Return has been added to lines in the spiceds file.&quot;</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="SpicedsProduct.check_product"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.SpicedsProduct.check_product">[docs]</a>    <span class="k">def</span> <span class="nf">check_product</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if the SPICEDS product needs to be generated.</span>

<span class="sd">        :return: True if the SPICEDS products needs to be generated, False otherwise</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1"># If the previous spiceds document is the same then it does not</span>
        <span class="c1"># need to be generated.</span>
        <span class="c1">#</span>
        <span class="n">generate_spiceds</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest_spiceds</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">spiceds_current</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latest_spiceds</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">spiceds_latest</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

            <span class="n">differ</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">Differ</span><span class="p">(</span><span class="n">charjunk</span><span class="o">=</span><span class="n">difflib</span><span class="o">.</span><span class="n">IS_CHARACTER_JUNK</span><span class="p">)</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">differ</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">spiceds_current</span><span class="p">,</span> <span class="n">spiceds_latest</span><span class="p">))</span>

            <span class="n">generate_spiceds</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="s2">&quot;Last update&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span>
                        <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;-&quot;</span>
                        <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;-</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">):</span>
                        <span class="n">generate_spiceds</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">generate_spiceds</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;-- spiceds document does not need to be &quot;</span> <span class="s2">&quot;updated.&quot;</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">generate_spiceds</span></div>

<div class="viewcode-block" id="SpicedsProduct.compare"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.SpicedsProduct.compare">[docs]</a>    <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;**Compare the SPICEDS Product with another SPICEDS**.</span>

<span class="sd">        The SPICEDS Product is compared with the previous</span>
<span class="sd">        version and if it does not exist with the sample INSIGHT SPICEDS</span>
<span class="sd">        product.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1"># Compare spiceds with latest. First try with previous increment.</span>
        <span class="c1">#</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">val_spd_path</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">bundle_directory</span><span class="si">}</span><span class="s2">/&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_acronym</span><span class="si">}</span><span class="s2">_spice/document&quot;</span>
            <span class="p">)</span>

            <span class="n">val_spds</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val_spd_path</span><span class="si">}</span><span class="s2">/spiceds_v*.html&quot;</span><span class="p">)</span>
            <span class="n">val_spds</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">val_spd</span> <span class="o">=</span> <span class="n">val_spds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>

            <span class="c1">#</span>
            <span class="c1"># If previous increment does not work, compare with InSight</span>
            <span class="c1"># example.</span>
            <span class="c1">#</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- No other version of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> has been found.&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;-- Comparing with default InSight example.&quot;</span><span class="p">)</span>

            <span class="n">val_spd</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/data/insight_spice/document/spiceds_v002.html&quot;</span>
            <span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">fromfile</span> <span class="o">=</span> <span class="n">val_spd</span>
        <span class="n">tofile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span>
        <span class="nb">dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">working_directory</span>

        <span class="n">compare_files</span><span class="p">(</span><span class="n">fromfile</span><span class="p">,</span> <span class="n">tofile</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">diff</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ReadmeProduct"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.ReadmeProduct">[docs]</a><span class="k">class</span> <span class="nc">ReadmeProduct</span><span class="p">(</span><span class="n">Product</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Product child class to generate the Readme Product.</span>

<span class="sd">    :param setup: NPB execution setup object</span>
<span class="sd">    :type setup: object</span>
<span class="sd">    :param bundle: Bundle that contains the Readme Product</span>
<span class="sd">    :type bundle: object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setup</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">bundle</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Constructor.&quot;&quot;&quot;</span>
        <span class="n">line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">setup</span><span class="o">.</span><span class="n">step</span><span class="si">}</span><span class="s2"> - Generation of bundle products&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">setup</span><span class="o">.</span><span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">setup</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">silent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">setup</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-- &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; - &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;readme.txt&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bundle</span> <span class="o">=</span> <span class="n">bundle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">setup</span><span class="o">.</span><span class="n">staging_directory</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vid</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">vid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">Object</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">path</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">bundle_directory</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_acronym</span><span class="si">}</span><span class="s2">_spice/readme.txt&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-- Readme file already exists in final area.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_product</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-- Generating readme file...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_product</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_product</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1">#</span>
            <span class="c1"># If the product is generated we define a checksum attribute for</span>
            <span class="c1"># the Bundle object.</span>
            <span class="c1">#</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bundle</span><span class="o">.</span><span class="n">checksum</span> <span class="o">=</span> <span class="n">md5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="n">Product</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Now we change the path for the difference of the name in the label</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">setup</span><span class="o">.</span><span class="n">staging_directory</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">bundle</span><span class="o">.</span><span class="n">name</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-- Generating bundle label...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">BundlePDS4Label</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="ReadmeProduct.write_product"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.ReadmeProduct.write_product">[docs]</a>    <span class="k">def</span> <span class="nf">write_product</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write the Readme product.&quot;&quot;&quot;</span>
        <span class="n">line_length</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">#</span>
        <span class="c1"># If the readme file is provided via configuration copy it, otherwise</span>
        <span class="c1"># generate it with the tempalte.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;input&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">readme</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">readme</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">readme</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error_message</span><span class="p">(</span><span class="s2">&quot;Readme file provided via configuration does not exist.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">templates_directory</span> <span class="o">+</span> <span class="s2">&quot;/template_readme.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s2">&quot;$SPICE_NAME&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;$SPICE_NAME&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">spice_name</span><span class="p">)</span>
                            <span class="n">line_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">add_carriage_return</span><span class="p">(</span>
                                <span class="n">line</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">eol_pds4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span>
                            <span class="p">)</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="s2">&quot;$UNDERLINE&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;$UNDERLINE&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="n">line_length</span><span class="p">)</span>
                            <span class="n">line_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">add_carriage_return</span><span class="p">(</span>
                                <span class="n">line</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">eol_pds4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span>
                            <span class="p">)</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="s2">&quot;$OVERVIEW&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="n">overview</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">readme</span><span class="p">[</span><span class="s2">&quot;overview&quot;</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">overview</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
                                <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                                <span class="n">line</span> <span class="o">=</span> <span class="n">add_carriage_return</span><span class="p">(</span>
                                    <span class="n">line</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">eol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span>
                                <span class="p">)</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="s2">&quot;$COGNISANT_AUTHORITY&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="n">cognisant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">readme</span><span class="p">[</span><span class="s2">&quot;cognisant_authority&quot;</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">cognisant</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
                                <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                                <span class="n">line</span> <span class="o">=</span> <span class="n">add_carriage_return</span><span class="p">(</span>
                                    <span class="n">line</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">eol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span>
                                <span class="p">)</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">line_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">add_carriage_return</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">eol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">)</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-- Created readme file.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">silent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   * Created readme file.&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ChecksumProduct"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.ChecksumProduct">[docs]</a><span class="k">class</span> <span class="nc">ChecksumProduct</span><span class="p">(</span><span class="n">Product</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Product child class to generate a Checksum Product.</span>

<span class="sd">    :param setup: NPB execution setup object</span>
<span class="sd">    :type setup: object</span>
<span class="sd">    :param collection: Miscellaneous Collection</span>
<span class="sd">    :type collection: object</span>
<span class="sd">    :param add_previous_checksum: True if there is a previous checksum file to</span>
<span class="sd">                                  be added, False otherwise</span>
<span class="sd">    :type add_previous_checksum: bool</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">setup</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">collection</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">add_previous_checksum</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Constructor.&quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1"># The initialisation of the checksum class is lighter than the</span>
        <span class="c1"># initialisation of the other products because the purpose is</span>
        <span class="c1"># solely to obtain the LID and the VID of the checksum in order</span>
        <span class="c1"># to be able to include it in the miscellaneous collection</span>
        <span class="c1"># inventory file; the checksum file needs to be included in the</span>
        <span class="c1"># inventory file before the actual checksum file is generated.</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_path</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">staging_directory</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s2">&quot;miscellaneous&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
        <span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">step</span><span class="si">}</span><span class="s2"> - Generate checksum file&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">silent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-- &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; - &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># We generate the kernel directory if not present</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="n">product_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_path</span> <span class="o">+</span> <span class="s2">&quot;checksum/&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">product_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">setup</span><span class="o">.</span><span class="n">staging_directory</span><span class="si">}</span><span class="s2">/index/&quot;</span>

        <span class="n">safe_make_directory</span><span class="p">(</span><span class="n">product_path</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Initialise the checksum dictionary; we use a dictionary to be</span>
        <span class="c1"># able to sort it by value into a list to generate the checksum</span>
        <span class="c1"># table.</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">md5_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">read_current_product</span><span class="p">(</span><span class="n">add_previous_checksum</span><span class="o">=</span><span class="n">add_previous_checksum</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_product_lid</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_product_vid</span><span class="p">()</span>

<div class="viewcode-block" id="ChecksumProduct.set_coverage"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.ChecksumProduct.set_coverage">[docs]</a>    <span class="k">def</span> <span class="nf">set_coverage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine the coverage of the Checksum file.&quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1"># The coverage is set by generating the checksum file but without</span>
        <span class="c1"># writing it.</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_product</span><span class="p">(</span><span class="n">history</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">set_coverage</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="ChecksumProduct.generate"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.ChecksumProduct.generate">[docs]</a>    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write and label the Checksum file.</span>

<span class="sd">        :param history: True if the checksum will be generated with the archive</span>
<span class="sd">                        history, False otherwise</span>
<span class="sd">        :type history: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1"># This acts as the second part of the Checksum product initialization.</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_product</span><span class="p">(</span><span class="n">history</span><span class="o">=</span><span class="n">history</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Call the constructor of the parent class to fill the common</span>
        <span class="c1"># attributes.</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_product</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">Product</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># The checksum is labeled.</span>
        <span class="c1">#</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Labeling </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">ChecksumPDS4Label</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">ChecksumPDS3Label</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="ChecksumProduct.read_current_product"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.ChecksumProduct.read_current_product">[docs]</a>    <span class="k">def</span> <span class="nf">read_current_product</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">add_previous_checksum</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads the current checksum file.</span>

<span class="sd">        Reads the current checksum file, determines the version of the</span>
<span class="sd">        new checksum file, and adds the checksum file itself and its label.</span>

<span class="sd">        :param add_previous_checksum: True if there is a previous checksum file to</span>
<span class="sd">                                  be added, False otherwise</span>
<span class="sd">        :type add_previous_checksum: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1"># Determine the checksum version</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">increment</span><span class="p">:</span>
                <span class="n">checksum_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">bundle_directory</span>
                    <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_acronym</span><span class="si">}</span><span class="s2">_spice/&quot;</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span>
                    <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
                    <span class="o">+</span> <span class="s2">&quot;/checksum/checksum_v*.tab&quot;</span>
                <span class="p">)</span>

                <span class="n">checksum_files</span> <span class="o">+=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">staging_directory</span>
                    <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span>
                    <span class="o">+</span> <span class="s2">&quot;/checksum/checksum_v*.tab&quot;</span>
                <span class="p">)</span>
                <span class="n">checksum_files</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">latest_file</span> <span class="o">=</span> <span class="n">checksum_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                    <span class="c1">#</span>
                    <span class="c1"># Store the previous version to use it to validate the</span>
                    <span class="c1"># generated one.</span>
                    <span class="c1">#</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">path_current</span> <span class="o">=</span> <span class="n">latest_file</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">name_current</span> <span class="o">=</span> <span class="n">latest_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                    <span class="n">latest_version</span> <span class="o">=</span> <span class="n">latest_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_v&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">latest_version</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Previous checksum file is: </span><span class="si">{</span><span class="n">latest_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Generate version </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">path_current</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;-- Previous checksum file not found.&quot;</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Default to version </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;-- The version of this file might be incorrect.&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">path_current</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Default to version </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;-- Make sure this is the first release of the archive.&quot;</span>
                <span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;checksum_v</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="si">:</span><span class="s2">03</span><span class="si">}</span><span class="s2">.tab&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">staging_directory</span>
                <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span>
                <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
                <span class="o">+</span> <span class="s2">&quot;checksum&quot;</span>
                <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">name_current</span> <span class="o">=</span> <span class="s2">&quot;checksum.tab&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path_current</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">bundle_directory</span>
                <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">volume_id</span>
                <span class="o">+</span> <span class="s2">&quot;/index/checksum.tab&quot;</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;checksum.tab&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">staging_directory</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s2">&quot;index&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Add each element of current checksum into the md5_sum attribute if</span>
        <span class="c1"># the miscellaneous collection was present in the release.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_current</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_current</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                    <span class="c1">#</span>
                    <span class="c1"># Check the format of the current checksum file.</span>
                    <span class="c1">#</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="p">(</span><span class="n">md5_file</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                        <span class="n">error_message</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Checksum file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path_current</span><span class="si">}</span><span class="s2"> is corrupted.&quot;</span><span class="p">,</span>
                            <span class="n">setup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">,</span>
                        <span class="p">)</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">md5_file</span><span class="p">)</span> <span class="o">==</span> <span class="mi">32</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">md5_dict</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">md5_file</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">error_message</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Checksum file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path_current</span><span class="si">}</span><span class="s2"> &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;corrupted entry: </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
                            <span class="n">setup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">,</span>
                        <span class="p">)</span>

            <span class="c1">#</span>
            <span class="c1"># Add the previous checksum file itself and its label, as specified</span>
            <span class="c1"># by the parameter. Checksum is not added if the corresponding</span>
            <span class="c1"># release did not have the miscellaneous collection.</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="n">add_previous_checksum</span><span class="p">:</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
                    <span class="n">checksum_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/checksum/&quot;</span>
                    <span class="n">label_current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_current</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tab&quot;</span><span class="p">,</span> <span class="s2">&quot;.xml&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">checksum_dir</span> <span class="o">=</span> <span class="s2">&quot;index/&quot;</span>
                    <span class="n">label_current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_current</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tab&quot;</span><span class="p">,</span> <span class="s2">&quot;.lbl&quot;</span><span class="p">)</span>

                <span class="n">md5_current</span> <span class="o">=</span> <span class="n">md5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_current</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">md5_dict</span><span class="p">[</span>
                    <span class="n">checksum_dir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_current</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">md5_current</span>

                <span class="n">md5_label</span> <span class="o">=</span> <span class="n">md5</span><span class="p">(</span><span class="n">label_current</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">md5_dict</span><span class="p">[</span>
                    <span class="n">checksum_dir</span> <span class="o">+</span> <span class="n">label_current</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">md5_label</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">new_product</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="ChecksumProduct.set_product_lid"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.ChecksumProduct.set_product_lid">[docs]</a>    <span class="k">def</span> <span class="nf">set_product_lid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set Product LID.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lid</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">logical_identifier</span><span class="si">}</span><span class="s2">:miscellaneous:checksum_checksum&quot;</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ChecksumProduct.set_product_vid"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.ChecksumProduct.set_product_vid">[docs]</a>    <span class="k">def</span> <span class="nf">set_product_vid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set Product VID.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vid</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.0&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">))</span></div>

<div class="viewcode-block" id="ChecksumProduct.write_product"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.ChecksumProduct.write_product">[docs]</a>    <span class="k">def</span> <span class="nf">write_product</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">set_coverage</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write the Checksum file and determine its start and stop time.</span>

<span class="sd">        This method can also be used to determine the start and stop time of</span>
<span class="sd">        the checksum file, necessary to determine these times for the</span>
<span class="sd">        miscellaneous collection before the checksum is actually written.</span>

<span class="sd">        :param history: Archive History</span>
<span class="sd">        :type history: dict</span>
<span class="sd">        :param set_coverage: Determines the start and stop of the checksum file</span>
<span class="sd">                             if set to True, False otherwise</span>
<span class="sd">        :type set_coverage: bool</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msn_acr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_acronym</span>

        <span class="c1">#</span>
        <span class="c1"># The checksum file of the current run is generated without the</span>
        <span class="c1"># bundle history and using the checksum hashes obtained during</span>
        <span class="c1"># the pipeline execution.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">history</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># Iterate the collections to obtain the checksum of each product.</span>
            <span class="c1">#</span>
            <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">bundle</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">collection</span><span class="o">.</span><span class="n">product</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
                        <span class="n">archive_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">msn_acr</span><span class="si">}</span><span class="s2">_spice/&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">archive_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">volume_id</span><span class="si">}</span><span class="s2">/&quot;</span>

                    <span class="n">product_name</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">product</span><span class="p">,</span> <span class="s2">&quot;checksum&quot;</span><span class="p">):</span>

                        <span class="c1">#</span>
                        <span class="c1"># If a product MD5 sum is duplicated by a product with</span>
                        <span class="c1"># a different name raise an error unless you are</span>
                        <span class="c1"># running NPB in debug mode.</span>
                        <span class="c1">#</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">product</span><span class="o">.</span><span class="n">checksum</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">md5_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">md5_dict</span><span class="p">[</span><span class="n">product_name</span><span class="p">]</span> <span class="o">!=</span> <span class="n">product</span><span class="o">.</span><span class="n">checksum</span>
                        <span class="p">):</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Two products have the same MD5 sum, &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;the product </span><span class="si">{</span><span class="n">product_name</span><span class="si">}</span><span class="s2"> might be a duplicate.&quot;</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                                <span class="n">error_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">md5_dict</span><span class="p">[</span><span class="n">product_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">checksum</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1">#</span>
                        <span class="c1"># For the current checksum product that does not have</span>
                        <span class="c1"># a checksum.</span>
                        <span class="c1">#</span>
                        <span class="k">pass</span>
                    <span class="c1">#</span>
                    <span class="c1"># Generate the MD5 checksum of the label.</span>
                    <span class="c1">#</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">product</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">):</span>
                        <span class="n">label_checksum</span> <span class="o">=</span> <span class="n">md5</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">md5_dict</span><span class="p">[</span>
                            <span class="n">product</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">label_checksum</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- </span><span class="si">{</span><span class="n">product_name</span><span class="si">}</span><span class="s2"> does not have a label.&quot;</span><span class="p">)</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="c1">#</span>
            <span class="c1"># Include the readme file checksum if it has been generated in</span>
            <span class="c1"># this run. This is a bundle level product.</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">bundle</span><span class="p">,</span> <span class="s2">&quot;checksum&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">md5_dict</span><span class="p">[</span><span class="s2">&quot;readme.txt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">bundle</span><span class="o">.</span><span class="n">checksum</span>

            <span class="c1">#</span>
            <span class="c1"># Include the bundle label, that is paired to the readme file.</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">set_coverage</span><span class="p">:</span>
                <span class="n">label_checksum</span> <span class="o">=</span> <span class="n">md5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">bundle</span><span class="o">.</span><span class="n">readme</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">md5_dict</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">bundle</span><span class="o">.</span><span class="n">readme</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">msn_acr</span><span class="si">}</span><span class="s2">_spice/&quot;</span>
                    <span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">label_checksum</span>

        <span class="c1">#</span>
        <span class="c1"># The missing checksum files for PDS4 are generated from the bundle</span>
        <span class="c1"># history.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">history</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">history</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">bundle_directory</span>
                    <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_acronym</span><span class="si">}</span><span class="s2">_spice/&quot;</span>
                    <span class="o">+</span> <span class="n">product</span>
                <span class="p">)</span>
                <span class="c1">#</span>
                <span class="c1"># Computing checksums is resource consuming; let&#39;s see if the</span>
                <span class="c1"># product has the checksum in its label already. Otherwise,</span>
                <span class="c1"># compute the checksum.</span>
                <span class="c1">#</span>
                <span class="n">checksum</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="s2">&quot;.xml&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">product</span><span class="p">:</span>
                    <span class="n">checksum</span> <span class="o">=</span> <span class="n">checksum_from_registry</span><span class="p">(</span>
                        <span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">working_directory</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">checksum</span><span class="p">:</span>
                        <span class="n">checksum</span> <span class="o">=</span> <span class="n">checksum_from_label</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">checksum</span><span class="p">:</span>
                    <span class="n">checksum</span> <span class="o">=</span> <span class="n">md5</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">md5_dict</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">=</span> <span class="n">checksum</span>

        <span class="c1">#</span>
        <span class="c1"># The resulting dictionary needs to be transformed into a list</span>
        <span class="c1"># sorted by filename alphabetical order (second column of the</span>
        <span class="c1"># resulting table)</span>
        <span class="c1">#</span>
        <span class="n">md5_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">#</span>
        <span class="c1"># Check if two items of the dictionary have the same value (same</span>
        <span class="c1"># MD5 sum.) This happened for the ExoMars2016 bundle release 004</span>
        <span class="c1"># where 3 products had the same MD5 sum values.</span>
        <span class="c1">#</span>
        <span class="n">md5_check_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">md5_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">md5_check_dict</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="n">md5_check_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">md5_check_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">md5_check_dict</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;-- The following products have the same MD5 sum:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">md5_check_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># The resulting dictionary needs to be transformed into a list</span>
        <span class="c1"># sorted by filename alphabetical order (second column of the</span>
        <span class="c1"># resulting table)</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="n">md5_dict_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">md5_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">md5_dict_keys</span><span class="p">):</span>
                <span class="n">md5_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">md5_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># PDS3 checksums have trailing whitespaces to fill the number of</span>
            <span class="c1"># characters of the longest entry. This value is also used for the</span>
            <span class="c1"># label generation.</span>
            <span class="c1">#</span>
            <span class="n">max_key_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">md5_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">))</span>

            <span class="c1">#</span>
            <span class="c1"># Python sorting algorythm sorts the characters using their ASCII</span>
            <span class="c1"># index. The original Checksum generation script mkpdssum.pl did not</span>
            <span class="c1"># use this sorting order; &#39;.&#39; and &#39;_&#39; did not have precedence over</span>
            <span class="c1"># alphabetical characters.</span>
            <span class="c1">#</span>
            <span class="c1"># In order to preserve the order provided by mkpdssum.pl, it is</span>
            <span class="c1"># necessary to &quot;trick&quot; Python sorting or implement a customised</span>
            <span class="c1"># sorting function. The order in ASCII is as follows:</span>
            <span class="c1">#</span>
            <span class="c1">#    index     char</span>
            <span class="c1">#   -------------------</span>
            <span class="c1">#    42        *</span>
            <span class="c1">#    46        .</span>
            <span class="c1">#    47        /</span>
            <span class="c1">#    48-57     0-9</span>
            <span class="c1">#    58        :</span>
            <span class="c1">#    95        _</span>
            <span class="c1">#    96        `</span>
            <span class="c1">#    65-90     A-Z</span>
            <span class="c1">#    97-122    a-z</span>
            <span class="c1">#    124       |</span>
            <span class="c1">#    126       ~</span>
            <span class="c1">#</span>
            <span class="c1"># In order to correct the issue there will be a modified of keys</span>
            <span class="c1"># list -with file names- that will have &#39;.&#39; replaced by &#39;~&#39; and</span>
            <span class="c1"># &#39;_&#39; replaced by &#39;|&#39;. This is safe since filenames do not use</span>
            <span class="c1"># these characters.</span>
            <span class="c1">#</span>
            <span class="n">md5_dict_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">md5_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">md5_dict_keys</span><span class="p">):</span>
                <span class="n">md5_dict_keys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;~&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;|&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">md5_dict_keys</span><span class="p">):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
                <span class="n">md5_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">md5_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">key</span><span class="si">}{</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_key_len</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">max_key_len</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">record_bytes</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">max_key_len</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_records</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">md5_dict_keys</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># We remove spurious .DS_Store files if we are working with MacOS.</span>
        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">_dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">bundle_directory</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.DS_Store&quot;</span><span class="p">):</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Removing </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Checksum start and stop times are the same as the ones defined</span>
        <span class="c1"># by the spice_kernel collection and the orbnum files in the</span>
        <span class="c1"># miscellaneous collection.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="n">coverage_list</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1">#</span>
            <span class="c1"># Gather all the relevant products that define the coverage of the</span>
            <span class="c1"># checksum file: orbnum labels and spice_kernels collection labels.</span>
            <span class="c1">#</span>
            <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">md5_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;spice_kernels/collection_spice_kernels_v&quot;</span> <span class="ow">in</span> <span class="n">product</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                    <span class="p">(</span><span class="s2">&quot;miscellaneous/orbnum/&quot;</span> <span class="ow">in</span> <span class="n">product</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="s2">&quot;.xml&quot;</span> <span class="ow">in</span> <span class="n">product</span><span class="p">))</span>
                <span class="p">):</span>
                    <span class="n">coverage_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="n">start_times</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">stop_times</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">coverage_list</span><span class="p">:</span>
                <span class="c1">#</span>
                <span class="c1"># The files can either be in the staging or the final area.</span>
                <span class="c1">#</span>
                <span class="n">path</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">bundle_directory</span><span class="si">}</span><span class="s2">/&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_acronym</span><span class="si">}</span><span class="s2">_spice/&quot;</span> <span class="o">+</span> <span class="n">product</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">staging_directory</span><span class="si">}</span><span class="s2">/&quot;</span> <span class="o">+</span> <span class="n">product</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;-- Product required to determine &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> coverage: </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2"> not found.&quot;</span>
                        <span class="p">)</span>

                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">lbl</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lbl</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s2">&quot;&lt;start_date_time&gt;&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                                <span class="n">start_time</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&lt;start_date_time&gt;&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                                    <span class="s2">&quot;&lt;/&quot;</span>
                                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">start_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">start_time</span><span class="p">)</span>
                            <span class="k">if</span> <span class="s2">&quot;&lt;stop_date_time&gt;&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                                <span class="n">stop_time</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&lt;stop_date_time&gt;&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                                    <span class="s2">&quot;&lt;/&quot;</span>
                                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">stop_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stop_time</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">start_times</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;-- Start time set to &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;mission start time: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_start</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">start_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_start</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">stop_times</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;-- Stop time set to &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;mission finish time: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_finish</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">stop_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">mission_finish</span><span class="p">)</span>

            <span class="n">start_times</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">stop_times</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">start_times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_time</span> <span class="o">=</span> <span class="n">stop_times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">set_coverage</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># Write the checksum file.</span>
            <span class="c1">#</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">md5_list</span><span class="p">:</span>
                    <span class="n">entry</span> <span class="o">=</span> <span class="n">add_carriage_return</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">eol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">)</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">diff</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-- Comparing checksum with previous version...&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compare</span><span class="p">()</span></div>

<div class="viewcode-block" id="ChecksumProduct.compare"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.ChecksumProduct.compare">[docs]</a>    <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;**Compare the Checksum with the previous Checksum file**.</span>

<span class="sd">        The Checksum file is compared with the previous version.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">compare_files</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">path_current</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">diff</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;-- Checksum from previous increment does not exist.&quot;</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="PDS3DocumentProduct"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.PDS3DocumentProduct">[docs]</a><span class="k">class</span> <span class="nc">PDS3DocumentProduct</span><span class="p">(</span><span class="n">Product</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Product child class that represents a PDS3 Document Product.</span>

<span class="sd">    :param setup: NPB execution setup object</span>
<span class="sd">    :type setup: object</span>
<span class="sd">    :param path: PDS3 Document path</span>
<span class="sd">    :type path: str</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setup</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Constructor.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1">#</span>
        <span class="c1"># Compare with the already existing file -that has the same name-, if</span>
        <span class="c1"># files are the same do not include as an updated file.</span>
        <span class="c1">#</span>
        <span class="n">existing_path</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">bundle_directory</span>
            <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">volume_id</span>
            <span class="o">+</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">volume_id</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">same_files</span> <span class="o">=</span> <span class="n">compare_files</span><span class="p">(</span>
            <span class="n">existing_path</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">diff</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">same_files</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_product</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_product</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

        <span class="n">Product</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="PDS3DocumentProduct.validate"><a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.product.PDS3DocumentProduct.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Try to validate the PDS3 document.</span>

<span class="sd">        The outcome of the validation is an INFO or a WARNING log message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;release.cat&quot;</span><span class="p">:</span>
            <span class="n">release_strings</span> <span class="o">=</span> <span class="p">[</span>
                <span class="sa">f</span><span class="s1">&#39;RELEASE_ID                      = &quot;0</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">release</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;RELEASE_DATE                    = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">release_date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;RELEASE_PARAMETER_TEXT          = &quot;&amp;RELEASE_ID=0</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">release</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">release_strings</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">release_date</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">string</span> <span class="ow">in</span> <span class="n">release_strings</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">present</span> <span class="o">=</span> <span class="n">string_in_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">present</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;-- The following string:&quot;</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">string</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Is not present in: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-- The following string:&quot;</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">string</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Is present in: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2021, Caltech/JPL/NASA

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>