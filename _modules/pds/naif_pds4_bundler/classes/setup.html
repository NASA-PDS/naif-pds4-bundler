

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pds.naif_pds4_bundler.classes.setup &mdash; NAIF PDS4 Bundler 1.8.0
 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/theme_overrides.css?v=8a44a683" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=b51e6972"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            NAIF PDS4 Bundler
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../10_overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../20_spice_kernel_archive_description.html">SPICE Kernel Archive Description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../30_spice_kernel_archive_preparation_guide.html">SPICE Kernel Archive Preparation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../40_naif_pds4_bundler_user_guide.html">NAIF PDS4 Bundler User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../50_api_docs.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../60_annex_npb_for_pds3.html">Appendix: NPB for PDS3 Archives</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">NAIF PDS4 Bundler</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pds.naif_pds4_bundler.classes.setup</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pds.naif_pds4_bundler.classes.setup</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Setup Class Implementation.&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">os.path</span><span class="w"> </span><span class="kn">import</span> <span class="n">dirname</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">xml.etree</span><span class="w"> </span><span class="kn">import</span> <span class="n">cElementTree</span> <span class="k">as</span> <span class="n">ET</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">spiceypy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xmlschema</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">..utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">etree_to_dict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">kernel_name</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">spice_exception_handler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.log</span><span class="w"> </span><span class="kn">import</span> <span class="n">error_message</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.object</span><span class="w"> </span><span class="kn">import</span> <span class="n">Object</span>


<div class="viewcode-block" id="Setup">
<a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.setup.Setup">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Setup</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class that parses and processes the NPB XML configuration file.</span>

<span class="sd">    :param args: Parameters arguments from NPB main function</span>
<span class="sd">    :type args: object</span>
<span class="sd">    :param version: NPB version</span>
<span class="sd">    :type version: str</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Object</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># Check that the configuration file validates with its schema</span>
            <span class="c1">#</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">xmlschema</span><span class="o">.</span><span class="n">XMLSchema11</span><span class="p">(</span>
                <span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/../data/configuration.xsd&quot;</span>
            <span class="p">)</span>
            <span class="n">schema</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">inst</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="c1">#</span>
        <span class="c1"># Converting XML setup file into a dictionary and then into</span>
        <span class="c1"># attributes for the object.</span>
        <span class="c1">#</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="n">etree_to_dict</span><span class="p">(</span><span class="n">ET</span><span class="o">.</span><span class="n">XML</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>

        <span class="c1">#</span>
        <span class="c1"># Re-arrange the resulting dictionary into one-level attributes</span>
        <span class="c1"># adept to be used (as if we were loading a JSON file).</span>
        <span class="c1">#</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="s2">&quot;naif-pds4-bundler_configuration&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pds_parameters&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;bundle_parameters&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;mission_parameters&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;directories&quot;</span><span class="p">])</span>

        <span class="c1">#</span>
        <span class="c1"># Re-arrange secondary missions, spacecrafts, and targets parameters.</span>
        <span class="c1">#</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;secondary_missions&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secondary_missions</span><span class="p">[</span><span class="s2">&quot;mission_name&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secondary_missions</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">secondary_missions</span><span class="p">[</span><span class="s2">&quot;mission_name&quot;</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secondary_missions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondary_missions</span><span class="p">[</span><span class="s2">&quot;mission_name&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;secondary_observers&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secondary_observers</span><span class="p">[</span><span class="s2">&quot;observer&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secondary_observers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">secondary_observers</span><span class="p">[</span><span class="s2">&quot;observer&quot;</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secondary_observers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondary_observers</span><span class="p">[</span><span class="s2">&quot;observer&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;secondary_targets&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secondary_targets</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secondary_targets</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">secondary_targets</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secondary_targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondary_targets</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span>

        <span class="c1">#</span>
        <span class="c1"># Kernel directory needs to be turned into a list.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernels_directory</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kernels_directory</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kernels_directory</span><span class="p">]</span>

        <span class="c1">#</span>
        <span class="c1"># Generate empty orbnum directory if not present.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;orbnum_directory&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orbnum_directory</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1">#</span>
        <span class="c1"># Kernel list configuration needs refactoring.</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;kernel_list&quot;</span><span class="p">])</span>

        <span class="n">kernel_list_config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">:</span>
            <span class="n">kernel_list_config</span><span class="p">[</span><span class="n">ker</span><span class="p">[</span><span class="s2">&quot;@pattern&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ker</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kernel_list_config</span> <span class="o">=</span> <span class="n">kernel_list_config</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span>

        <span class="c1">#</span>
        <span class="c1"># Meta-kernel configuration; if there is one meta-kernel</span>
        <span class="c1"># mk is a dictionary, otherwise it is a list of dictionaries.</span>
        <span class="c1"># It is processed in such a way that it is always a list of</span>
        <span class="c1"># dictionaries. Same applies to meta-kernels from configuration</span>
        <span class="c1"># as user input.</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;meta-kernel&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;mk&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mk</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mk</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mk</span><span class="p">]</span>

        <span class="c1">#</span>
        <span class="c1"># Meta-kernel configuration; if there is one pattern for</span>
        <span class="c1"># the meta-kernel name, convert it into a list of</span>
        <span class="c1"># dictionaries.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;mk&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mk</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mk</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mk</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mk</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span>

        <span class="c1">#</span>
        <span class="c1"># Meta-kernel configuration; if there is one coverage kernel, convert</span>
        <span class="c1"># it into a list of coverage kernels.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;coverage_kernels&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coverage_kernels</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coverage_kernels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coverage_kernels</span><span class="p">]</span>

        <span class="c1">#</span>
        <span class="c1"># ORBNUM configuration: if there is one orbnum file orbnum is a</span>
        <span class="c1"># dictionary, otherwise it is a list of dictionaries. It is</span>
        <span class="c1"># processed in such a way that it is always a list of dictionaries</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="s2">&quot;orbit_number_file&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;orbit_number_file&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orbnum</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">orbnum</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">orbnum</span><span class="p">]</span>

        <span class="c1">#</span>
        <span class="c1"># Set run type for the NPB by-products file name. So far this only</span>
        <span class="c1"># deviates from the default *_release_* for label generation run only</span>
        <span class="c1"># *_labels_*</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">faucet</span> <span class="o">==</span> <span class="s2">&quot;labels&quot;</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">args</span><span class="o">.</span><span class="n">faucet</span> <span class="o">==</span> <span class="s2">&quot;clear&quot;</span> <span class="ow">and</span> <span class="s2">&quot;_labels_&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">clear</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_type</span> <span class="o">=</span> <span class="s2">&quot;labels&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_type</span> <span class="o">=</span> <span class="s2">&quot;release&quot;</span>

        <span class="c1">#</span>
        <span class="c1"># Populate the setup object with attributes not present in the</span>
        <span class="c1"># configuration file.</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))[:</span><span class="o">-</span><span class="mi">7</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">faucet</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">faucet</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diff</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">diff</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checksum_registry</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">#</span>
        <span class="c1"># If a release date is not specified it is set to today.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;release_date&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">release_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;[0-9]</span><span class="si">{4}</span><span class="s2">-[0-9]</span><span class="si">{2}</span><span class="s2">-[0-9]</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">release_date</span><span class="p">):</span>
                <span class="n">error_message</span><span class="p">(</span>
                    <span class="s2">&quot;release_date parameter does not match &quot;</span>
                    <span class="s2">&quot;the required format: YYYY-MM-DD.&quot;</span>
                <span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Check date format, if is not provided it is set to the format</span>
        <span class="c1"># proposed for the PDS4 Information Model 2.0.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;date_format&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">date_format</span> <span class="o">=</span> <span class="s2">&quot;maklabel&quot;</span>

        <span class="c1">#</span>
        <span class="c1"># Check text End of Line format and set EoL length.</span>
        <span class="c1">#</span>
        <span class="c1"># CRs are added to all text, XML, and other PDS meta-files</span>
        <span class="c1"># present in PDS4 archives as dictated by the standard.</span>
        <span class="c1"># CRs are added to checksum tables as well.</span>
        <span class="c1">#</span>
        <span class="c1"># If the parameter is not provided via configuration is set by default</span>
        <span class="c1"># to CRLF.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;end_of_line&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_of_line</span> <span class="o">=</span> <span class="s2">&quot;CRLF&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_of_line</span> <span class="o">==</span> <span class="s2">&quot;CRLF&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eol</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eol_len</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_of_line</span> <span class="o">==</span> <span class="s2">&quot;LF&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eol</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eol_len</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error_message</span><span class="p">(</span><span class="s2">&quot;End of Line provided via configuration is not CRLF nor LF.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">end_of_line_pds4</span> <span class="o">=</span> <span class="s2">&quot;CRLF&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eol_pds4</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eol_pds4_len</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eol_mk</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eol_mk_len</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eol_pds3</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span>

        <span class="c1">#</span>
        <span class="c1"># Check and determine endianness.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;binary_endianness&quot;</span><span class="p">):</span>
            <span class="c1">#</span>
            <span class="c1"># Placeholder for when PDS3 is fully implemented.</span>
            <span class="c1">#</span>
            <span class="c1"># if self.pds_version == &quot;4&quot;:</span>
            <span class="c1">#    self.kernel_endianness = &quot;little&quot;</span>
            <span class="c1"># else:</span>
            <span class="c1">#    self.kernel_endianness = &quot;big&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kernel_endianness</span> <span class="o">=</span> <span class="s2">&quot;little&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">binary_endianness</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;little&quot;</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_endianness</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;ltl-ieee&quot;</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kernel_endianness</span> <span class="o">=</span> <span class="s2">&quot;little&quot;</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">binary_endianness</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;big&quot;</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_endianness</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;big-ieee&quot;</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kernel_endianness</span> <span class="o">=</span> <span class="s2">&quot;big&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error_message</span><span class="p">(</span>
                    <span class="s2">&quot;binary_endianness configuration parameter value must be&quot;</span>
                    <span class="s2">&quot; &#39;big&#39;, &#39;BIG-IEEE&#39;, &#39;little&#39; or &#39;LTL-IEEE&#39;. Case is not&quot;</span>
                    <span class="s2">&quot; sensitive.&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_endianness</span><span class="p">:</span>
            <span class="n">error_message</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;binary_endianness configuration parameter value must be &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;the same as your system endianness: </span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Fill missing fields.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">producer_phone</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">producer_email</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">volume_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

<div class="viewcode-block" id="Setup.check_configuration">
<a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.setup.Setup.check_configuration">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Performs the following checks to the loaded configuration items:</span>

<span class="sd">        * IM, Line Feed, and Date Time format NAIF recommendations</span>
<span class="sd">        * Archive increment start and finish times</span>
<span class="sd">        * Transform relative to absolute paths</span>
<span class="sd">        * Existence of kernel directories</span>
<span class="sd">        * IM, XML model, and Schema Location coherence</span>
<span class="sd">        * Check existence of templates according to the IM</span>
<span class="sd">        * Meta-kernel configuration</span>
<span class="sd">        * Presence of uppercase characters in the kernel list configuration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1"># Check IM, Line Feed, and Date Time format NAIF recommendations.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_format</span> <span class="o">==</span> <span class="s2">&quot;infomod2&quot;</span><span class="p">:</span>

            <span class="c1">#</span>
            <span class="c1"># Warn the user if the End of Line character is not the one</span>
            <span class="c1"># corresponding to the one recommended by NAIF for the selected</span>
            <span class="c1"># date format.</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_of_line</span> <span class="o">!=</span> <span class="s2">&quot;LF&quot;</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;-- NAIF recommends to use `LF&#39; End-of-Line while using&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; the `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">date_format</span><span class="si">}</span><span class="s2">&#39; parameter instead of &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">end_of_line</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">)</span>

            <span class="c1">#</span>
            <span class="c1"># Set the time format for the Date format selected.</span>
            <span class="c1">#</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
                <span class="s2">&quot;[0-9]</span><span class="si">{4}</span><span class="s2">-[0-9]</span><span class="si">{2}</span><span class="s2">-[0-9]</span><span class="si">{2}</span><span class="s2">T&quot;</span> <span class="s2">&quot;[0-9]</span><span class="si">{2}</span><span class="s2">:[0-9]</span><span class="si">{2}</span><span class="s2">:[0-9]</span><span class="si">{2}</span><span class="s2">.[0-9]</span><span class="si">{3}</span><span class="s2">Z&quot;</span>
            <span class="p">)</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;YYYY-MM-DDThh:mm:ss.sssZ&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_format</span> <span class="o">==</span> <span class="s2">&quot;maklabel&quot;</span><span class="p">:</span>

            <span class="c1">#</span>
            <span class="c1"># Warn the user if the End of Line character is not the one</span>
            <span class="c1"># corresponding to the one recommended by NAIF for the selected</span>
            <span class="c1"># date format.</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_of_line</span> <span class="o">!=</span> <span class="s2">&quot;CRLF&quot;</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;-- NAIF recommends to use `CRLF&#39; End-of-Line while using&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; the `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">date_format</span><span class="si">}</span><span class="s2">&#39; parameter instead of &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">end_of_line</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">)</span>

            <span class="c1">#</span>
            <span class="c1"># Set the time format for the Date format selected.</span>
            <span class="c1">#</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
                <span class="s2">&quot;[0-9]</span><span class="si">{4}</span><span class="s2">-[0-9]</span><span class="si">{2}</span><span class="s2">-[0-9]</span><span class="si">{2}</span><span class="s2">T&quot;</span> <span class="s2">&quot;[0-9]</span><span class="si">{2}</span><span class="s2">:[0-9]</span><span class="si">{2}</span><span class="s2">:[0-9]</span><span class="si">{2}</span><span class="s2">Z&quot;</span>
            <span class="p">)</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;YYYY-MM-DDThh:mm:ssZ&quot;</span>

        <span class="c1">#</span>
        <span class="c1"># Check binary kernels endianness.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_endianness</span> <span class="o">==</span> <span class="s2">&quot;little&quot;</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;-- Binary SPICE kernels expected to have LTL-IEEE (little endian) binary format.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;-- Binary SPICE kernels expected to have BIG-IEEE (little endian) binary format.&quot;</span>
                <span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;-- NAIF strongly recommends to use LTL-IEEE (little endian) for binary kernels in PDS4 archives &quot;</span>
                <span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;   and enforces it if the archive is hosted by NAIF.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_endianness</span> <span class="o">==</span> <span class="s2">&quot;little&quot;</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;-- Binary SPICE kernels expected to have LTL-IEEE (little endian) binary format.&quot;</span>
                <span class="p">)</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;-- NAIF strongly recommends to use BIG-IEEE (big endian) for binary kernels in PDS3 archives &quot;</span>
                <span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;   and enforces it if the archive is hosted by NAIF.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">==</span> <span class="s2">&quot;big&quot;</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;   Your system is BIG-IEEE (big endian): PDS3 Labels cannot be attached to binary kernels.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;   If binary kernels are present this will result in an error.&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;-- Binary SPICE kernels expected to have BIG-IEEE (big endian) binary format.&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">!=</span> <span class="s2">&quot;big&quot;</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;   Your system is LTL-IEEE (little endian): PDS3 Labels cannot be attached to binary kernels.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;   If binary kernels are present this will result in an error.&quot;</span>
                    <span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Check Bundle increment start and finish times. For the two accepted</span>
        <span class="c1"># formats.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;mission_start&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_start</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mission_start</span><span class="p">):</span>
                <span class="n">error_message</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;mission_start parameter does not match the &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;required format: </span><span class="si">{</span><span class="nb">format</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;mission_finish&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_finish</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mission_finish</span><span class="p">):</span>
                <span class="n">error_message</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;mission_finish does not match the required format: </span><span class="si">{</span><span class="nb">format</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;increment_start&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">increment_start</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">increment_start</span><span class="p">):</span>
                <span class="n">error_message</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;increment_start parameter does not match the &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;required format: </span><span class="si">{</span><span class="nb">format</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;increment_finish&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">increment_finish</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">increment_finish</span><span class="p">):</span>
                <span class="n">error_message</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;increment_finish does not match the required &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;format: </span><span class="si">{</span><span class="nb">format</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;increment_start&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;increment_finish&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">increment_start</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">increment_finish</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">increment_start</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">increment_finish</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">error_message</span><span class="p">(</span>
                    <span class="s2">&quot;If provided via configuration, increment_start and &quot;</span>
                    <span class="s2">&quot;increment_finish parameters need to be provided &quot;</span>
                    <span class="s2">&quot;together.&quot;</span>
                <span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Check that directories are not the same.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">staging_directory</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bundle_directory</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">staging_directory</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bundle_directory</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;--The working, staging, and bundle directories must be different:&quot;</span>
            <span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  working: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  staging: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">staging_directory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  bundle:  </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bundle_directory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">error_message</span><span class="p">(</span><span class="s2">&quot;Update working, staging, or bundle directory.&quot;</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Sort out if directories are provided as relative paths and</span>
        <span class="c1"># if so convert them in absolute for the execution</span>
        <span class="c1">#</span>
        <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Set the staging directory WRT PDS3 or PDS4</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="n">mission_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mission_acronym</span><span class="si">}</span><span class="s2">_spice&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mission_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">volume_id</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">cwd</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">=</span> <span class="n">cwd</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="p">):</span>
            <span class="n">error_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Directory does not exist: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">cwd</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">staging_directory</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">staging_directory</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">cwd</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">staging_directory</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">mission_dir</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">staging_directory</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;-- Creating staging directory: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">staging_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">mission_dir</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># If the faucet is set to plan, kerlist, or checks, this is just</span>
            <span class="c1"># fine. Otherwise the non-existence must trigger an error.</span>
            <span class="c1">#</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">cwd</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">staging_directory</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">faucet</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;plan&quot;</span><span class="p">,</span> <span class="s2">&quot;list&quot;</span><span class="p">,</span> <span class="s2">&quot;checks&quot;</span><span class="p">]:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;-- Staging directory cannot be created but is not used with </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">faucet</span><span class="si">}</span><span class="s2"> faucet.&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">error_message</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Staging directory cannot be created: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">staging_directory</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>

        <span class="k">elif</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">mission_dir</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">staging_directory</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">staging_directory</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">mission_dir</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">cwd</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bundle_directory</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bundle_directory</span> <span class="o">=</span> <span class="n">cwd</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bundle_directory</span>

        <span class="c1">#</span>
        <span class="c1"># If the faucet is set to plan, kerlist, or checks, this is just</span>
        <span class="c1"># fine. Otherwise the non-existence must trigger an error.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bundle_directory</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">faucet</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;plan&quot;</span><span class="p">,</span> <span class="s2">&quot;list&quot;</span><span class="p">,</span> <span class="s2">&quot;checks&quot;</span><span class="p">]:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;-- Bundle directory does not exist but is not used with </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">faucet</span><span class="si">}</span><span class="s2"> faucet.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error_message</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Bundle directory does not exist: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bundle_directory</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># There might be more than one kernel directory</span>
        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernels_directory</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">cwd</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernels_directory</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kernels_directory</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cwd</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernels_directory</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernels_directory</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="n">error_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Directory does not exist: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kernels_directory</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Check IM, XML model, and Schema Location coherence (given that is not</span>
        <span class="c1"># checked by the PDS Validate tool.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;information_model&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[0-9]+[.][0-9]+[.][0-9]+[.][0-9]+&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">information_model</span><span class="p">):</span>

                <span class="n">major</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">information_model</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">minor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">information_model</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">maint</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">information_model</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">build</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">information_model</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">3</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">major</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">major</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">major</span> <span class="o">+</span> <span class="mi">55</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">minor</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">minor</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">minor</span> <span class="o">+</span> <span class="mi">55</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">maint</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">maint</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">maint</span> <span class="o">+</span> <span class="mi">55</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">build</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">build</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">build</span> <span class="o">+</span> <span class="mi">55</span><span class="p">)</span>

                <span class="n">short_version</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">major</span><span class="si">}{</span><span class="n">minor</span><span class="si">}{</span><span class="n">maint</span><span class="si">}{</span><span class="n">build</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="c1">#</span>
                <span class="c1"># Check if xml_model is provided via configuration, if so check</span>
                <span class="c1"># its validity and if not generate it.</span>
                <span class="c1">#</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;xml_model&quot;</span><span class="p">):</span>
                    <span class="n">xml_model_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_model</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;PDS4_PDS_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">xml_model_version</span> <span class="o">=</span> <span class="n">xml_model_version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.sch&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">xml_model_version</span> <span class="o">!=</span> <span class="n">short_version</span><span class="p">:</span>
                        <span class="n">error_message</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;PDS4 Information Model &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">short_version</span><span class="si">}</span><span class="s2"> &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;is incoherent with the XML Model version: &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">xml_model</span><span class="si">}</span><span class="s2">.&quot;</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">xml_model</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;http://pds.nasa.gov/pds4/pds/v1/PDS4_PDS_</span><span class="si">{</span><span class="n">short_version</span><span class="si">}</span><span class="s2">.sch&quot;</span>
                    <span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;-- Schema XML Model (xml_model) not provided with configuration file. Set to:&quot;</span>
                    <span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">xml_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1">#</span>
                <span class="c1"># Check if schema_location is provided via configuration, if so check</span>
                <span class="c1"># its validity and if not generate it.</span>
                <span class="c1">#</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;schema_location&quot;</span><span class="p">):</span>
                    <span class="n">schema_loc_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema_location</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/PDS4_PDS_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">schema_loc_version</span> <span class="o">=</span> <span class="n">schema_loc_version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.xsd&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">schema_loc_version</span> <span class="o">!=</span> <span class="n">short_version</span><span class="p">:</span>
                        <span class="n">error_message</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;PDS4 Information Model &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">short_version</span><span class="si">}</span><span class="s2"> &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;is incoherent with the Schema location: &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">schema_location</span><span class="si">}</span><span class="s2">.&quot;</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">schema_location</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;http://pds.nasa.gov/pds4/pds/v1 &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;http://pds.nasa.gov/pds4/pds/v1/PDS4_PDS_</span><span class="si">{</span><span class="n">short_version</span><span class="si">}</span><span class="s2">.xsd&quot;</span>
                    <span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;-- Schema Location (schema_location) not provided with configuration file. Set to:&quot;</span>
                    <span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">schema_location</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">error_message</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;PDS4 Information Model </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">information_model</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; format from configuration is incorrect.&quot;</span>
                <span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Check existence of templates according to the information_model</span>
        <span class="c1"># or user-defined templates.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>

            <span class="n">config_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">information_model</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="n">config_schema</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">config_schema</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">config_schema</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">config_schema</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">config_schema</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="c1">#</span>
            <span class="c1"># Store the float value of the schema to evaluate element values</span>
            <span class="c1"># that depend on the IM.</span>
            <span class="c1">#</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">information_model_float</span> <span class="o">=</span> <span class="n">config_schema</span>

            <span class="n">schemas</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">templates/*/&quot;</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">schemas</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;pds3&quot;</span><span class="p">)</span>

            <span class="n">schemas_eval</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">schemas</span><span class="p">:</span>
                <span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
                <span class="n">schema</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">schema</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">schema</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">schema</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">schema</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">schemas_eval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>

            <span class="c1">#</span>
            <span class="c1"># Reorder the schema list according to their value.</span>
            <span class="c1">#</span>
            <span class="n">schemas_index</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">schemas_eval</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="n">schemas_eval</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">schemas_eval</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">schemas</span> <span class="o">=</span> <span class="p">[</span><span class="n">schemas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">schemas_index</span><span class="p">]</span>

            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">schemas_eval</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">config_schema</span> <span class="o">&lt;</span> <span class="n">schemas_eval</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">schema</span> <span class="o">=</span> <span class="n">schemas</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">schema</span> <span class="o">=</span> <span class="n">schemas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">config_schema</span> <span class="o">&gt;=</span> <span class="n">schemas_eval</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">schema</span> <span class="o">=</span> <span class="n">schemas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">break</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">templates_directory</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">templates/</span><span class="si">{</span><span class="n">schema</span><span class="si">}</span><span class="s2">/&quot;</span>
        <span class="c1">#</span>
        <span class="c1"># If a templates&#39; directory is not provided, determine the templates</span>
        <span class="c1"># to be used based on the IM.</span>
        <span class="c1">#</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">templates_directory</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">templates/pds3/&quot;</span>

        <span class="n">template_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;templates_directory&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">templates_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span>

            <span class="n">templates</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">templates_directory</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">templates</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">templates_directory</span><span class="p">,</span> <span class="n">template</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">templates_directory</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">template_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">template</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">config_schema</span> <span class="ow">in</span> <span class="n">schemas_eval</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;-- Label templates will use the ones from &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;information model </span><span class="si">{</span><span class="n">schema</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;-- Label templates will use the ones from &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;information model </span><span class="si">{</span><span class="n">schema</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">templates_directory</span><span class="p">):</span>
                <span class="n">error_message</span><span class="p">(</span><span class="s2">&quot;Path provided/derived for templates is not available.&quot;</span><span class="p">)</span>
            <span class="n">labels_check</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">templates/1.5.0.0/*&quot;</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">templates_directory</span><span class="si">}</span><span class="s2">/*&quot;</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="c1">#</span>
            <span class="c1"># Copy the templates to the working directory.</span>
            <span class="c1">#</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels_check</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;-- Template </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> has not been provided. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Using label from: &quot;</span>
                    <span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">templates_directory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
                        <span class="n">templates_directory</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span>
                    <span class="p">)</span>
                    <span class="n">template_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">label</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">templates_directory</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">template_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">label</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># PDS3 templates</span>
            <span class="c1">#</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">templates_directory</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">templates/pds3&quot;</span>
            <span class="n">templates</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">templates_directory</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">templates</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">templates_directory</span><span class="p">,</span> <span class="n">template</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">template_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">template</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Label templates directory: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">templates_directory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">templates_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template_files</span> <span class="o">=</span> <span class="n">template_files</span>

        <span class="c1">#</span>
        <span class="c1"># Extract the XML files line tabs and line spaces for the element added</span>
        <span class="c1"># to the templates. The default for the built-in templates is 2.</span>
        <span class="c1">#</span>
        <span class="n">xml_tab</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">xml_tag</span> <span class="o">=</span> <span class="s2">&quot;&lt;Identification_Area&gt;&quot;</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">templates_directory</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s2">&quot;template_bundle.xml&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">xml_tag</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                            <span class="n">xml_tab</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">xml_tag</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;-- XML Template not found to determine XML Tab. It has been set to 2.&quot;</span>
                <span class="p">)</span>
                <span class="n">xml_tab</span> <span class="o">=</span> <span class="mi">2</span>

            <span class="k">if</span> <span class="n">xml_tab</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;-- XML Template not useful to determine XML Tab. It has been set to 2.&quot;</span>
                <span class="p">)</span>
                <span class="n">xml_tab</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xml_tab</span> <span class="o">=</span> <span class="n">xml_tab</span>

        <span class="c1">#</span>
        <span class="c1"># Check meta-kernel configuration</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;mk&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">metak</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk</span><span class="p">:</span>

                <span class="n">metak_name_check</span> <span class="o">=</span> <span class="n">metak</span><span class="p">[</span><span class="s2">&quot;@name&quot;</span><span class="p">]</span>

                <span class="c1">#</span>
                <span class="c1"># Fix no list or list of lists.</span>
                <span class="c1">#</span>
                <span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">metak</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="s2">&quot;pattern&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="p">[</span><span class="s2">&quot;pattern&quot;</span><span class="p">]]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">name</span><span class="p">[</span><span class="s2">&quot;pattern&quot;</span><span class="p">]:</span>
                            <span class="n">patterns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
                    <span class="n">name_pattern</span> <span class="o">=</span> <span class="n">pattern</span><span class="p">[</span><span class="s2">&quot;#text&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">name_pattern</span> <span class="ow">in</span> <span class="n">metak_name_check</span><span class="p">:</span>
                        <span class="n">error_message</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;The meta-kernel pattern &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name_pattern</span><span class="si">}</span><span class="s2"> is not provided.&quot;</span>
                        <span class="p">)</span>

                    <span class="n">metak_name_check</span> <span class="o">=</span> <span class="n">metak_name_check</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;$&quot;</span> <span class="o">+</span> <span class="n">name_pattern</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

                <span class="c1">#</span>
                <span class="c1"># If there are remaining $ characters in the metak_name_check</span>
                <span class="c1"># this means that there are remaining patterns to define in</span>
                <span class="c1"># the configuration file.</span>
                <span class="c1">#</span>
                <span class="k">if</span> <span class="s2">&quot;$&quot;</span> <span class="ow">in</span> <span class="n">metak_name_check</span><span class="p">:</span>
                    <span class="n">error_message</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;The MK patterns </span><span class="si">{</span><span class="n">metak</span><span class="p">[</span><span class="s1">&#39;@name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> do not &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;correspond to the present MKs.&quot;</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;-- There is no meta-kernel configuration to check.&quot;</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Check coverage kernels configuration (needed if there is only one</span>
        <span class="c1"># entry).</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;coverage_kernels&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coverage_kernels</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coverage_kernels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coverage_kernels</span><span class="p">]</span>

        <span class="c1">#</span>
        <span class="c1"># If a readme file is present the readme section of the configuration</span>
        <span class="c1"># is irrelevant.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bundle_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">mission_dir</span><span class="si">}</span><span class="s2">/readme.txt&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span>
        <span class="p">):</span>
            <span class="c1">#</span>
            <span class="c1"># Check readme file inputs in configuration. Raise an error immediately</span>
            <span class="c1"># if things do not look good.</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;readme&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;input&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">readme</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">readme</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;cognisant_authority&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">readme</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                        <span class="s2">&quot;overview&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">readme</span>
                    <span class="p">):</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;Input readme file not present. &quot;</span>
                            <span class="s2">&quot;File will be generated from &quot;</span>
                            <span class="s2">&quot;configuration.&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">error_message</span><span class="p">(</span>
                            <span class="s2">&quot;Readme elements not present in configuration file.&quot;</span>
                        <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error_message</span><span class="p">(</span><span class="s2">&quot;Readme elements not present in configuration file.&quot;</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Check if there is any uppercase character in the kernel list</span>
        <span class="c1"># configuration section.</span>
        <span class="c1">#</span>
        <span class="n">kernel_pattern_is_upper</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">kernel_pattern_upper</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">kernel_pattern</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_list_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">ele</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="n">kernel_pattern</span><span class="p">):</span>
                <span class="n">kernel_pattern_is_upper</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">kernel_pattern_upper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kernel_pattern</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kernel_pattern_is_upper</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;-- Kernel list configuration has entries with uppercase letters:&quot;</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">kernel_pattern</span> <span class="ow">in</span> <span class="n">kernel_pattern_upper</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      </span><span class="si">{</span><span class="n">kernel_pattern</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;   Uppercase letters in kernel names are HIGHLY discouraged. &quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Setup.set_release">
<a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.setup.Setup.set_release">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine the Bundle release number.&quot;&quot;&quot;</span>
        <span class="n">line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="si">}</span><span class="s2"> - Setup the archive generation&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">silent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-- &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; - &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># PDS4 release increment (implies inventory and meta-kernel).</span>
        <span class="c1">#</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-- Checking existence of previous release.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">clear</span><span class="p">:</span>
            <span class="n">release</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">clear</span>
            <span class="n">release</span> <span class="o">=</span> <span class="n">release</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.file_list&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">release</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">release</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">run_type</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">current_release</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">release</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="n">release</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">release</span><span class="si">:</span><span class="s2">03</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">current_release</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">current_release</span><span class="si">:</span><span class="s2">03</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;-- Generating release </span><span class="si">{</span><span class="n">release</span><span class="si">}</span><span class="s2"> as obtained from &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;file list from previous run: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">clear</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">increment</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">releases</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bundle_directory</span>
                    <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_acronym</span>
                    <span class="o">+</span> <span class="s2">&quot;_spice&quot;</span>
                    <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
                    <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;bundle_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mission_acronym</span><span class="si">}</span><span class="s2">_spice_v*&quot;</span>
                <span class="p">)</span>
                <span class="n">releases</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="n">current_release</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">releases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_spice_v&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">current_release</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">current_release</span><span class="si">:</span><span class="s2">03</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">release</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">current_release</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">release</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">release</span><span class="si">:</span><span class="s2">03</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Generating release </span><span class="si">{</span><span class="n">release</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

                <span class="n">increment</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;-- Bundle label not found. Checking previous kernel list.&quot;</span>
                    <span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>

                    <span class="c1">#</span>
                    <span class="c1"># If the kernel list is provided as an argument, we</span>
                    <span class="c1"># cannot deduce the release version from it.</span>
                    <span class="c1">#</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">kerlist</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;-- Kernel list provided as input. &quot;</span>
                            <span class="s2">&quot;Release number cannot be obtained.&quot;</span>
                        <span class="p">)</span>
                        <span class="k">raise</span>

                    <span class="n">releases</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mission_acronym</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">run_type</span><span class="si">}</span><span class="s2">_*.kernel_list&quot;</span>
                    <span class="p">)</span>

                    <span class="n">releases</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                    <span class="n">current_release</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                        <span class="n">releases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">run_type</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">current_release</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">current_release</span><span class="si">:</span><span class="s2">03</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">release</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">current_release</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">release</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">release</span><span class="si">:</span><span class="s2">03</span><span class="si">}</span><span class="s2">&quot;</span>

                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Generating release </span><span class="si">{</span><span class="n">release</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="n">increment</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span><span class="p">:</span>

                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;-- This is the first release.&quot;</span><span class="p">)</span>

                    <span class="n">release</span> <span class="o">=</span> <span class="s2">&quot;001&quot;</span>
                    <span class="n">current_release</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

                    <span class="n">increment</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">release</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_release</span> <span class="o">=</span> <span class="n">current_release</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">increment</span> <span class="o">=</span> <span class="n">increment</span></div>


<div class="viewcode-block" id="Setup.load_kernels">
<a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.setup.Setup.load_kernels">[docs]</a>
    <span class="nd">@spice_exception_handler</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_kernels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads the kernels required to run NPB.</span>

<span class="sd">        Note that kernels that</span>
<span class="sd">        are not required might be loaded as well, but given that the</span>
<span class="sd">        required memory is not much, we stay on the safe side by loading</span>
<span class="sd">        additional kernels.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="si">}</span><span class="s2"> - Load LSK, PCK, FK and SCLK kernels&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">silent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-- &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; - &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># To get the appropriate kernels, use the kernel list config.</span>
        <span class="c1"># First extract the patterns for each kernel type of interest.</span>
        <span class="c1">#</span>
        <span class="n">fk_patterns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sclk_patterns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pck_patterns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lsk_patterns</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">#</span>
        <span class="c1"># We inspect the kernels directory and the bundle directory.</span>
        <span class="c1">#</span>
        <span class="n">directories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernels_directory</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pds_version</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="n">directories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bundle_directory</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mission_acronym</span><span class="si">}</span><span class="s2">_spice/spice_kernels&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">directories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bundle_directory</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">volume_id</span><span class="si">}</span><span class="s2">/data&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernels_to_load</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;fk&quot;</span> <span class="ow">in</span> <span class="nb">type</span><span class="p">:</span>
                <span class="n">fks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernels_to_load</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fks</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">fks</span> <span class="o">=</span> <span class="p">[</span><span class="n">fks</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="n">fks</span><span class="p">:</span>
                    <span class="n">fk_patterns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fk</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;sclk&quot;</span> <span class="ow">in</span> <span class="nb">type</span><span class="p">:</span>
                <span class="n">sclks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernels_to_load</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sclks</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">sclks</span> <span class="o">=</span> <span class="p">[</span><span class="n">sclks</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">sclk</span> <span class="ow">in</span> <span class="n">sclks</span><span class="p">:</span>
                    <span class="n">sclk_patterns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sclk</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;pck&quot;</span> <span class="ow">in</span> <span class="nb">type</span><span class="p">:</span>
                <span class="n">pcks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernels_to_load</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pcks</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">pcks</span> <span class="o">=</span> <span class="p">[</span><span class="n">pcks</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">pck</span> <span class="ow">in</span> <span class="n">pcks</span><span class="p">:</span>
                    <span class="n">pck_patterns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pck</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;lsk&quot;</span> <span class="ow">in</span> <span class="nb">type</span><span class="p">:</span>
                <span class="n">lsks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernels_to_load</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lsks</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">lsks</span> <span class="o">=</span> <span class="p">[</span><span class="n">lsks</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">lsk</span> <span class="ow">in</span> <span class="n">lsks</span><span class="p">:</span>
                    <span class="n">lsk_patterns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lsk</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Search the latest version for each pattern of each kernel type.</span>
        <span class="c1">#</span>
        <span class="n">lsks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">lsk_patterns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
                <span class="n">lsks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
                <span class="n">spiceypy</span><span class="o">.</span><span class="n">furnsh</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="n">directories</span><span class="p">:</span>
                    <span class="n">lsk_pattern</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">files</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="p">]</span>
                    <span class="k">if</span> <span class="n">lsk_pattern</span><span class="p">:</span>
                        <span class="n">lsk_pattern</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">kernel_name</span><span class="p">)</span>
                        <span class="n">spiceypy</span><span class="o">.</span><span class="n">furnsh</span><span class="p">(</span><span class="n">lsk_pattern</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">lsks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lsk_pattern</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lsks</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- LSK not found.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- LSK     loaded: </span><span class="si">{</span><span class="n">lsks</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lsks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">error_message</span><span class="p">(</span><span class="s2">&quot;Only one LSK should be obtained.&quot;</span><span class="p">)</span>

        <span class="n">pcks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">pck_patterns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
                <span class="n">pcks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
                <span class="n">spiceypy</span><span class="o">.</span><span class="n">furnsh</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="n">directories</span><span class="p">:</span>
                    <span class="n">pcks_pattern</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">files</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="p">]</span>
                    <span class="k">if</span> <span class="n">pcks_pattern</span><span class="p">:</span>
                        <span class="n">pcks_pattern</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">kernel_name</span><span class="p">)</span>
                        <span class="n">spiceypy</span><span class="o">.</span><span class="n">furnsh</span><span class="p">(</span><span class="n">pcks_pattern</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">pcks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pcks_pattern</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pcks</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- PCK not found.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- PCK(s)   loaded: </span><span class="si">{</span><span class="n">pcks</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">fks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">fk_patterns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
                <span class="n">fks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
                <span class="n">spiceypy</span><span class="o">.</span><span class="n">furnsh</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="n">directories</span><span class="p">:</span>
                    <span class="n">fks_pattern</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">files</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="p">]</span>

                    <span class="k">if</span> <span class="n">fks_pattern</span><span class="p">:</span>
                        <span class="n">fks_pattern</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">kernel_name</span><span class="p">)</span>
                        <span class="n">spiceypy</span><span class="o">.</span><span class="n">furnsh</span><span class="p">(</span><span class="n">fks_pattern</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">fks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fks_pattern</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fks</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- FK not found.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- FK(s)   loaded: </span><span class="si">{</span><span class="n">fks</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">sclks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">sclk_patterns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
                <span class="n">sclks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
                <span class="n">spiceypy</span><span class="o">.</span><span class="n">furnsh</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="n">directories</span><span class="p">:</span>
                    <span class="n">sclks_pattern</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">files</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="p">]</span>
                    <span class="k">if</span> <span class="n">sclks_pattern</span><span class="p">:</span>
                        <span class="n">sclks_pattern</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">kernel_name</span><span class="p">)</span>
                        <span class="n">spiceypy</span><span class="o">.</span><span class="n">furnsh</span><span class="p">(</span><span class="n">sclks_pattern</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">sclks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sclks_pattern</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sclks</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- SCLK not found.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- SCLK(s) loaded: </span><span class="si">{</span><span class="n">sclks</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fks</span> <span class="o">=</span> <span class="n">fks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sclks</span> <span class="o">=</span> <span class="n">sclks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lsk</span> <span class="o">=</span> <span class="n">lsk</span></div>


<div class="viewcode-block" id="Setup.information_model_setup">
<a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.setup.Setup.information_model_setup">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">information_model_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup and check PDS4 Information Model related things.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="Setup.clear_run">
<a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.setup.Setup.clear_run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clears the files generated by a previous run.</span>

<span class="sd">        Clears the files generated by a previous run when specified with the</span>
<span class="sd">        clear argument and the kernel list of the previous run.</span>

<span class="sd">        Please note that newly created directories will not be erased.</span>

<span class="sd">        :param debug: If True, the by-product files are not cleaned up. This is</span>
<span class="sd">                      useful when testing</span>
<span class="sd">        :type debug: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;-- Running in DEBUG mode, by-product files are not cleaned up.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">clear</span><span class="p">):</span>

            <span class="c1">#</span>
            <span class="c1"># Remove files from the staging area.</span>
            <span class="c1">#</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">staging_directory</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Removing files from staging area: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">clear</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;.plan&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;.kernel_list&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">stag_file</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">stag_file</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     File </span><span class="si">{</span><span class="n">stag_file</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>

            <span class="c1">#</span>
            <span class="c1"># Remove files from the final area.</span>
            <span class="c1">#</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bundle_directory</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_acronym</span> <span class="o">+</span> <span class="s2">&quot;_spice/&quot;</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Removing files from final area: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">clear</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;.plan&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;.kernel_list&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1">#</span>
                            <span class="c1"># When NPB has been executed in label mode the final</span>
                            <span class="c1"># area does not replicate the bundle directory structure</span>
                            <span class="c1"># but kernels operations area.</span>
                            <span class="c1">#</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">bundle_directory</span>
                                    <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;spice_kernels&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                <span class="p">)</span>
                            <span class="c1">#</span>
                            <span class="c1"># Default case.</span>
                            <span class="c1">#</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     File </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>

            <span class="c1">#</span>
            <span class="c1"># Remove generated by-products from the working_directory.</span>
            <span class="c1">#</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">kerlist</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">byproduct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">clear</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.plan&quot;</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Removing previous run by-product: </span><span class="si">{</span><span class="n">byproduct</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">byproduct</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     File </span><span class="si">{</span><span class="n">byproduct</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">plan</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">byproduct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">clear</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.kernel_list&quot;</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Removing previous run by-product: </span><span class="si">{</span><span class="n">byproduct</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">byproduct</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     File </span><span class="si">{</span><span class="n">byproduct</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">error_message</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;The file provided with the &quot;clear&quot; argument does &#39;</span>
                <span class="sa">f</span><span class="s2">&quot;not exist or is not readable. Make sure that the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;file follows the name pattern: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mission_acronym</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">run_type</span><span class="si">}</span><span class="s2">_NN.file_list.&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; where NN is the release number.&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Setup.add_file">
<a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.setup.Setup.add_file">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add file fo Product List.</span>

<span class="sd">        Adds a product to the run by-product Product List.</span>

<span class="sd">        :param file: Product to be added</span>
<span class="sd">        :type file: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span></div>


<div class="viewcode-block" id="Setup.add_checksum">
<a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.setup.Setup.add_checksum">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_checksum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">checksum</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add checksum to Checksum record.</span>

<span class="sd">        Adds a MD5sum entry with the product it corresponds to for the run</span>
<span class="sd">        by-product Checksum record file.</span>

<span class="sd">        :param path: File path for checksum</span>
<span class="sd">        :type path: str</span>
<span class="sd">        :param checksum: Checksum value for checksum</span>
<span class="sd">        :type checksum: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checksum_registry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">checksum</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Setup.write_file_list">
<a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.setup.Setup.write_file_list">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_file_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write the run by-product File List.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_list</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span>
                <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mission_acronym</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">run_type</span><span class="si">}</span><span class="s2">_&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">)</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">.file_list&quot;</span><span class="p">,</span>
                <span class="s2">&quot;w&quot;</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">l</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_list</span><span class="p">:</span>
                    <span class="n">l</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-- Run File List file written in working area.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Setup.write_checksum_registry">
<a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.setup.Setup.write_checksum_registry">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_checksum_registry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write the run by-product Checksum Record.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checksum_registry</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span>
                <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mission_acronym</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">run_type</span><span class="si">}</span><span class="s2">_&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">)</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">.checksum&quot;</span><span class="p">,</span>
                <span class="s2">&quot;w&quot;</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">l</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">checksum_registry</span><span class="p">:</span>
                    <span class="n">l</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">element</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-- Run Checksum Registry file written in working area.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Setup.write_validate_config">
<a class="viewcode-back" href="../../../../pds.naif_pds4_bundler.classes.html#pds.naif_pds4_bundler.classes.setup.Setup.write_validate_config">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_validate_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write a PDS validate tool configuration file.</span>

<span class="sd">        NPB will write a PDS validate tool configuration file for convenience</span>
<span class="sd">        of the user. The following validate example command for ExoMars2016::</span>

<span class="sd">           $ validate -v 1 -t em16/em16_spice -skip-context-validation \</span>
<span class="sd">           -R pds4.bundle -x working/PDS4_PDS_1B00.xsd -S working/PDS4_PDS_1B00.sch \</span>
<span class="sd">           -strict-field-checks -r working/em16_release_03.validate</span>

<span class="sd">        Would be equivalent to the following resulting Validate configuration</span>
<span class="sd">        file::</span>

<span class="sd">           # Run the PDS validate tool where the NPB working directory resides:</span>
<span class="sd">           # $ validate -c working/em16_release_03.config.validate</span>
<span class="sd">           validate.target = em16/em16_spice</span>
<span class="sd">           validate.verbose = 1</span>
<span class="sd">           validate.skip-context-validation = true</span>
<span class="sd">           validate.rule = pds4.bundle</span>
<span class="sd">           validate.schema = working/PDS4_PDS_1B00.xsd</span>
<span class="sd">           validate.schematron = working/PDS4_PDS_1B00.sch</span>
<span class="sd">           validate.strictFieldChecks = true</span>
<span class="sd">           validate.report = working/em16_release_03.validate_report</span>

<span class="sd">        If there is an issue during the generation of this file --e.g.: no</span>
<span class="sd">        internet connection-- the process will silently fail but the NPB run</span>
<span class="sd">        will be successful.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pds_schematron_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_model</span>
        <span class="n">pds_schematron</span> <span class="o">=</span> <span class="n">pds_schematron_location</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pds_schematron_location</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;-- PDS Validate Tool configuration file not written.&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   PDS Schematron not reachable: </span><span class="si">{</span><span class="n">pds_schematron</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">pds_schematron</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

        <span class="n">pds_schema_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema_location</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pds_schema</span> <span class="o">=</span> <span class="n">pds_schema_location</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pds_schema_location</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;-- PDS Validate Tool configuration file not written.&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;   PDS Schema location not reachable: </span><span class="si">{</span><span class="n">pds_schema_location</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">pds_schema</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mission_acronym</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">run_type</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">)</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.validate_config&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">l</span><span class="p">:</span>
            <span class="n">l</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s2">&quot;# Run the PDS validate tool where the NPB working directory resides:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">l</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;# $ validate -t </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bundle_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mission_acronym</span><span class="si">}</span><span class="s2">_spice &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;-c </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.validate_config &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;-r </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.validate_report</span><span class="se">\n</span><span class="s2">#</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">l</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;validate.schema = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">pds_schema</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">l</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;validate.schematron = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">pds_schematron</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">l</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;validate.verbose = 1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">l</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;validate.skipContextValidation = true</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">l</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;validate.rule = pds4.bundle</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">l</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;validate.strictFieldChecks = true</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-- PDS Validate Tool configuration file written in working area:&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.validate_config&quot;</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Caltech/JPL/NASA.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Q1K210DS5W"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-Q1K210DS5W', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>